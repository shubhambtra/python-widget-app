<!DOCTYPE html>
<html>
<head>
    <title>Test Razorpay Payment</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        .btn {
            background: #2563eb;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
            display: block;
            width: 100%;
        }
        .btn:hover { background: #1d4ed8; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .log {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        h1 { color: #1f2937; }
        .step { margin: 10px 0; padding: 10px; background: #e5e7eb; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Test Razorpay Payment</h1>

    <div class="step">
        <strong>Step 1:</strong> Register & Create Site (click this first)
    </div>
    <button class="btn" id="setupBtn" onclick="setupAccount()">
        1. Create Test Account & Site
    </button>

    <div class="step">
        <strong>Step 2:</strong> Test Payment (after account is created)
    </div>
    <button class="btn" id="payBtn" onclick="testPayment()" disabled>
        2. Pay with Razorpay (₹29 / $29)
    </button>

    <div class="log" id="log"></div>

    <script>
        const API_BASE = 'https://chatapp.code2night.com';

        let accessToken = null;
        let siteId = null;
        const testEmail = `testpay_${Date.now()}@test.com`;
        const testUsername = `testpay_${Date.now()}`;

        function log(msg, type = '') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<span class="${type}">[${time}] ${msg}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function setupAccount() {
            const btn = document.getElementById('setupBtn');
            btn.disabled = true;
            btn.textContent = 'Creating account...';

            try {
                // Step 1: Register
                log('Registering user: ' + testEmail, 'info');
                const regRes = await fetch(`${API_BASE}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        Email: testEmail,
                        Password: 'Test12345',
                        Username: testUsername
                    })
                });
                const regData = await regRes.json();

                if (!regData.success) {
                    throw new Error(regData.message || 'Registration failed');
                }

                accessToken = regData.data.accessToken;
                log('✓ User registered successfully', 'success');
                log('Token: ' + accessToken.substring(0, 50) + '...', 'info');

                // Step 2: Create Site
                log('Creating site...', 'info');
                const siteRes = await fetch(`${API_BASE}/api/sites`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        name: 'Test Payment Site',
                        domain: 'testpayment.com'
                    })
                });
                const siteData = await siteRes.json();

                if (!siteData.success) {
                    throw new Error(siteData.message || 'Site creation failed');
                }

                siteId = siteData.data.id;
                log('✓ Site created: ' + siteId, 'success');

                // Enable payment button
                document.getElementById('payBtn').disabled = false;
                btn.textContent = '✓ Account Ready';
                btn.style.background = '#10b981';

                log('', '');
                log('=== READY TO TEST PAYMENT ===', 'success');
                log('Click "Pay with Razorpay" button above', 'info');

            } catch (err) {
                log('✗ Error: ' + err.message, 'error');
                btn.disabled = false;
                btn.textContent = '1. Create Test Account & Site (Retry)';
            }
        }

        async function testPayment() {
            const btn = document.getElementById('payBtn');
            btn.disabled = true;
            btn.textContent = 'Creating order...';

            try {
                if (!siteId || !accessToken) {
                    throw new Error('Please create account first (Step 1)');
                }

                // Create Razorpay order
                log('Creating Razorpay order...', 'info');
                log('SiteId: ' + siteId, 'info');

                const orderRes = await fetch(`${API_BASE}/api/sites/${siteId}/payments/razorpay/create-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        amount: 29,
                        currency: 'USD',
                        planId: 'af44a1db-e8d2-4e91-a197-edb0f7dccd47',
                        billingCycle: 'monthly'
                    })
                });

                const orderData = await orderRes.json();
                log('Order response: ' + JSON.stringify(orderData, null, 2), 'info');

                if (!orderData.success) {
                    throw new Error(orderData.message || 'Failed to create order');
                }

                log('✓ Order created: ' + orderData.data.orderId, 'success');
                log('Opening Razorpay checkout...', 'info');

                btn.textContent = 'Opening Razorpay...';

                // Open Razorpay
                const options = {
                    key: orderData.data.keyId,
                    amount: orderData.data.amount * 100,
                    currency: orderData.data.currency,
                    name: 'Test Payment',
                    description: 'Starter Plan - monthly',
                    order_id: orderData.data.orderId,
                    handler: async function(response) {
                        log('', '');
                        log('=== PAYMENT SUCCESS ===', 'success');
                        log('Order ID: ' + response.razorpay_order_id, 'success');
                        log('Payment ID: ' + response.razorpay_payment_id, 'success');
                        log('Signature: ' + response.razorpay_signature.substring(0, 30) + '...', 'success');

                        // Verify payment
                        log('Verifying payment...', 'info');
                        try {
                            const verifyRes = await fetch(`${API_BASE}/api/sites/${siteId}/payments/razorpay/verify`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${accessToken}`
                                },
                                body: JSON.stringify({
                                    razorpayOrderId: response.razorpay_order_id,
                                    razorpayPaymentId: response.razorpay_payment_id,
                                    razorpaySignature: response.razorpay_signature,
                                    siteId: siteId,
                                    planId: 'af44a1db-e8d2-4e91-a197-edb0f7dccd47',
                                    billingCycle: 'monthly'
                                })
                            });
                            const verifyData = await verifyRes.json();
                            log('Verify response: ' + JSON.stringify(verifyData, null, 2), verifyData.success ? 'success' : 'error');
                        } catch (e) {
                            log('Verify error: ' + e.message, 'error');
                        }

                        btn.textContent = '✓ Payment Complete!';
                        btn.style.background = '#10b981';
                    },
                    prefill: {
                        email: testEmail,
                        name: 'Test User'
                    },
                    theme: {
                        color: '#2563eb'
                    },
                    modal: {
                        ondismiss: function() {
                            log('Payment modal dismissed by user', 'error');
                            btn.disabled = false;
                            btn.textContent = '2. Pay with Razorpay (Retry)';
                        }
                    }
                };

                const razorpay = new Razorpay(options);
                razorpay.on('payment.failed', function(response) {
                    log('', '');
                    log('=== PAYMENT FAILED ===', 'error');
                    log('Code: ' + response.error.code, 'error');
                    log('Description: ' + response.error.description, 'error');
                    log('Reason: ' + response.error.reason, 'error');
                    log('Source: ' + response.error.source, 'error');
                    log('Full error: ' + JSON.stringify(response.error, null, 2), 'error');

                    btn.disabled = false;
                    btn.textContent = '2. Pay with Razorpay (Retry)';
                });
                razorpay.open();

            } catch (err) {
                log('✗ Error: ' + err.message, 'error');
                btn.disabled = false;
                btn.textContent = '2. Pay with Razorpay (Retry)';
            }
        }
    </script>
</body>
</html>
