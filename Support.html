<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assistica AI - Support</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="Support.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="topbar-left">
    <div class="topbar-logo" data-brand="icon">
      C
    </div>
    <div class="topbar-brand"><span data-brand="name">Assistica AI</span> <span>Support</span></div>
  </div>

  <div class="topbar-center" role="search">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
    </svg>
    <input type="text" placeholder="Search conversations..." id="searchInput" aria-label="Search conversations" />
  </div>

  <div class="topbar-right">
    <button class="topbar-btn" title="Notifications" id="notificationsBtn" aria-label="Notifications">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
      </svg>
      <span class="badge" id="notificationBadge" style="display:none;"></span>
    </button>

    <button class="topbar-btn" title="Team Chat" id="btnTeamChat" onclick="toggleAgentsPanel()" aria-label="Team Chat">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
      </svg>
    </button>

    <button class="topbar-btn supervisor-btn" title="Supervisor View" id="supervisorBtn" onclick="openSupervisorModal()" style="display:none;" aria-label="Supervisor View">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
      </svg>
    </button>

    <button class="topbar-btn" title="Workflows" onclick="openWorkflowsModal()" aria-label="Workflows">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
    </button>

    <button class="topbar-btn" title="Settings" onclick="openSettings()" aria-label="Settings">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    </button>

    <button class="topbar-btn" title="Help" id="btnHelp" onclick="openShortcutsModal()" aria-label="Help & Keyboard Shortcuts">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    </button>

    <button class="topbar-btn" title="Report Issue" id="reportIssueBtn" onclick="openReportIssue()" aria-label="Report Issue">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
    </button>

    <div class="topbar-divider"></div>

    <!-- Connection Status Indicator -->
    <div class="connection-status" id="connectionStatus" title="Connected">
      <span class="connection-dot connected"></span>
      <span class="connection-text">Connected</span>
    </div>

    <div class="topbar-divider"></div>

    <!-- Agent Status Selector -->
    <div class="agent-status-wrapper">
      <button class="agent-status-btn" id="agentStatusBtn" onclick="toggleAgentStatusMenu()" style="display:none">
        <span class="agent-status-dot online" id="agentStatusDot"></span>
        <span class="agent-status-text" id="agentStatusText">Online</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      <div class="agent-status-dropdown" id="agentStatusDropdown" style="display:none">
        <button class="status-option" onclick="setAgentStatus('online')">
          <span class="agent-status-dot online"></span>
          <span>Online</span>
        </button>
        <button class="status-option" onclick="setAgentStatus('away')">
          <span class="agent-status-dot away"></span>
          <span>Away</span>
        </button>
        <button class="status-option" onclick="setAgentStatus('busy')">
          <span class="agent-status-dot busy"></span>
          <span>Busy</span>
        </button>
      </div>
    </div>

    <div class="topbar-divider"></div>

    <div class="topbar-user-wrapper">
      <div class="topbar-user" onclick="toggleUserMenu()" id="userMenuTrigger">
        <div class="topbar-user-avatar" id="currentUserAvatar">A</div>
        <div class="topbar-user-info">
          <div class="topbar-user-name" id="currentUserName">Agent</div>
          <div class="topbar-user-role">Support Agent</div>
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: #64748b;" id="dropdownChevron">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>

      <div class="user-dropdown" id="userDropdown">
        <div class="dropdown-header">
          <div class="dropdown-header-info">
            <div class="dropdown-avatar" id="dropdownAvatar">A</div>
            <div>
              <div class="dropdown-name" id="dropdownName">Agent</div>
              <div class="dropdown-email" id="dropdownEmail">agent@example.com</div>
            </div>
          </div>
        </div>
        <div class="dropdown-menu">
          <button class="dropdown-item" onclick="openProfile()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            My Profile
          </button>
          <button class="dropdown-item" onclick="openSettings()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Settings
          </button>
          <div class="dropdown-divider"></div>
          <button class="dropdown-item logout" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
            Logout
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Free Trial Banner (injected by JS) -->
<div id="freeTrialBanner" style="display: none;"></div>

<!-- MAIN LAYOUT -->
<div class="main-layout">

<!-- LEFT SIDEBAR -->
<div class="sidebar">
  <div class="sidebar-header">
    <h2>Conversations</h2>
    <span class="conversation-count" id="conversationCount" data-tooltip="Total conversations">0</span>
    <button class="btn-bulk-select" id="btnBulkSelect" onclick="toggleBulkSelectMode()" title="Select Multiple" aria-label="Select Multiple Conversations">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
      </svg>
    </button>
    <button class="btn-filter" id="btnFilter" onclick="toggleFilterPanel()" title="Filter Conversations" aria-label="Filter Conversations">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
      </svg>
      <span class="filter-badge" id="filterBadge" style="display:none;" data-tooltip="Active filters">0</span>
    </button>
  </div>

  <!-- Bulk Actions Bar -->
  <div class="bulk-actions-bar" id="bulkActionsBar" style="display: none;">
    <div class="bulk-select-all">
      <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)" />
      <label for="selectAllCheckbox">Select All</label>
    </div>
    <span class="bulk-selected-count" id="bulkSelectedCount">0 selected</span>
    <div class="bulk-action-buttons">
      <button class="bulk-btn bulk-btn-close" onclick="bulkCloseConversations()" title="Close Selected">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Close
      </button>
      <button class="bulk-btn bulk-btn-delete" onclick="bulkDeleteConversations()" title="Delete Selected">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
        Delete
      </button>
    </div>
    <button class="bulk-cancel-btn" onclick="cancelBulkSelect()">Cancel</button>
  </div>


  <div class="users-list" id="usersList">
    <div class="no-users">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" />
      </svg>
      <p>No active conversations</p>
    </div>
  </div>

  <!-- Online Agents Section (Collapsible) -->
  <div class="agents-section" id="agentsSection">
    <div class="agents-section-header" onclick="toggleAgentsSectionCollapse()">
      <div class="agents-section-title">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        <span>Team</span>
        <span class="agents-count" id="agentsCount">0</span>
      </div>
      <svg class="collapse-icon" id="agentsCollapseIcon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
      </svg>
    </div>
    <div class="agents-list" id="agentsList">
      <div class="no-agents">No other agents online</div>
    </div>
  </div>
  <div class="sidebar-version" id="sidebarVersion"></div>
</div>

<!-- MAIN CONTENT -->
<div class="main-content" role="main">

  <!-- CHAT PANEL -->
  <div class="chat-panel" id="chatPanel">
    <div class="no-chat-selected" id="noChatSelected">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
      </svg>
      <h3>Select a conversation</h3>
      <p>Choose a customer from the sidebar to start chatting</p>
    </div>

    <div class="chat-header" id="chatHeader" style="display: none;">
      <div class="chat-header-avatar" id="chatHeaderAvatar">J</div>
      <div class="chat-header-info">
        <h3 id="chatHeaderName">John Doe</h3>
        <p id="chatHeaderStatus">Online</p>
      </div>
      <!-- Tags displayed in header -->
      <div class="chat-header-tags" id="chatHeaderTags"></div>
      <div class="chat-header-actions">
        <div class="csat-badge" id="csatBadge" style="display: none;" title="Click to view feedback" onclick="openCsatFeedbackModal()">
          <span class="csat-stars" id="csatStars"></span>
          <span class="csat-value" id="csatValue"></span>
        </div>
        <button class="btn-send-email" id="btnSendEmail" style="display: none;" title="Send Email" aria-label="Send Email">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
        </button>
        <button class="btn-search-messages" id="btnSearchMessages" onclick="toggleMessageSearch()" title="Search Messages" aria-label="Search Messages">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </button>
        <!-- More Actions Menu -->
        <div class="conv-actions-wrapper">
          <button class="btn-more-actions" id="btnMoreActions" onclick="toggleConvActionsMenu()" title="More Actions" aria-label="More Actions">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
            </svg>
          </button>
          <div class="conv-actions-menu" id="convActionsMenu">
            <!-- Transfer & Close actions -->
            <div class="conv-actions-section">
              <button class="conv-action-btn" id="btnTransferMenu" onclick="openTransferModal(); toggleConvActionsMenu();">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                </svg>
                Transfer Conversation
              </button>
              <button class="conv-action-btn conv-action-btn-success" id="btnCloseMenu" onclick="openCloseConversationModal(); toggleConvActionsMenu();">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Close Conversation
              </button>
            </div>
            <div class="conv-actions-divider"></div>
            <div class="conv-actions-section">
              <div class="conv-actions-label">Priority</div>
              <div class="conv-actions-chips">
                <button class="priority-chip" data-priority="normal" onclick="setConversationPriority('normal')">Normal</button>
                <button class="priority-chip" data-priority="high" onclick="setConversationPriority('high')">High</button>
                <button class="priority-chip" data-priority="urgent" onclick="setConversationPriority('urgent')">Urgent</button>
              </div>
            </div>
            <div class="conv-actions-divider"></div>
            <div class="conv-actions-section">
              <div class="conv-actions-label">Tags</div>
              <div class="conv-tags-input-wrapper">
                <input type="text" class="conv-tags-input" id="convTagsInput" placeholder="Add tags..." onkeydown="if(event.key==='Enter')addConversationTag()" />
                <button class="conv-tags-add-btn" onclick="addConversationTag()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                  </svg>
                </button>
              </div>
              <div class="conv-tags-list" id="convTagsList"></div>
            </div>
            <div class="conv-actions-divider"></div>
            <div class="conv-actions-section">
              <button class="conv-action-btn" id="btnReopenConv" onclick="reopenConversation()" style="display:none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Reopen Conversation
              </button>
              <button class="conv-action-btn conv-action-btn-danger" onclick="deleteConversation(currentVisitor)">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Delete Conversation
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Message Search Bar -->
    <div class="message-search-bar" id="messageSearchBar" style="display: none;">
      <div class="message-search-input-wrapper">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input type="text" id="messageSearchInput" placeholder="Search in conversation..." oninput="searchMessages(this.value)" />
        <span class="search-results-count" id="searchResultsCount"></span>
        <button class="search-nav-btn" onclick="navigateSearchResult(-1)" title="Previous" aria-label="Previous search result">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
          </svg>
        </button>
        <button class="search-nav-btn" onclick="navigateSearchResult(1)" title="Next" aria-label="Next search result">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <button class="search-close-btn" onclick="closeMessageSearch()" aria-label="Close search">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>

    <div class="messages-container" id="messagesContainer" style="display: none;"></div>

    <div id="typingIndicatorContainer"></div>

    <div class="chat-input-area" id="chatInputArea" style="display: none; position: relative;">
      <!-- Quick Replies / Canned Responses -->
      <div class="quick-replies-panel" id="quickRepliesPanel" style="display: none;">
        <div class="quick-replies-header">
          <span class="quick-replies-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            Quick Replies
          </span>
          <button class="quick-replies-close" onclick="toggleQuickReplies()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="quick-replies-list" id="quickRepliesList">
          <!-- Rendered dynamically by renderQuickReplies() -->
        </div>
      </div>
      <div class="emoji-picker" id="emojiPicker">
        <div class="emoji-search">
          <input type="text" id="emojiSearch" placeholder="Search emojis..." />
        </div>
        <div class="emoji-categories" id="emojiCategories"></div>
        <div class="emoji-grid" id="emojiGrid"></div>
      </div>

      <div id="filePreviewArea"></div>
      <div class="chat-input-wrapper">
        <textarea id="messageInput" placeholder="Type a message..." rows="1"></textarea>
        <div class="input-actions">
          <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx,.txt,.zip" style="display: none;" />
          <button class="btn-quick-replies" id="btnQuickReplies" onclick="toggleQuickReplies()" title="Quick Replies" aria-label="Quick Replies">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
          </button>
          <button class="btn-attach" id="btnAttach" title="Attach file" aria-label="Attach file">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
            </svg>
          </button>
          <button class="btn-emoji" id="btnEmoji" title="Emoji" aria-label="Emoji picker">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </button>
          <button class="btn-send" id="btnSend" title="Send" aria-label="Send message">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div class="image-modal" id="imageModal">
    <button class="image-modal-close" onclick="closeImageModal()" aria-label="Close image">&times;</button>
    <img id="modalImage" src="" alt="Full size image" />
  </div>

  <!-- ANALYSIS PANEL -->
  <div class="analysis-panel" id="visitorInfoPanel">
    <div class="analysis-header">
      <h3>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
        </svg>
        AI Analysis
      </h3>
    </div>
    <div class="analysis-toggles">
      <div class="toggle-container" id="analysisToggleContainer">
        <span class="toggle-label">
          Enable AI Analysis
          <span class="usage-indicator" id="analysisUsageIndicator"></span>
        </span>
        <span id="analysisPremiumBadge" style="display: none;"></span>
        <label class="toggle-switch">
          <input type="checkbox" id="toggleAnalysis" onchange="onAnalysisToggle(this.checked)">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="toggle-container" id="autoReplyToggleContainer">
        <span class="toggle-label">
          Auto Reply
          <span class="usage-indicator" id="autoReplyUsageIndicator"></span>
        </span>
        <span id="autoReplyPremiumBadge" style="display: none;"></span>
        <label class="toggle-switch">
          <input type="checkbox" id="toggleAutoReply" onchange="onAutoReplyToggle(this.checked)">
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>
    <div class="analysis-content" id="analysisContent">
      <div class="analysis-empty">
        <p>Enable AI Analysis to see insights</p>
      </div>
    </div>

    <!-- Internal Notes/Comments Section -->
    <div class="comments-section" id="commentsSection">
      <div class="comments-header">
        <h4>
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
          </svg>
          Internal Notes
        </h4>
        <span class="comments-count" id="commentsCount">0</span>
      </div>
      <div class="comments-list" id="commentsList">
        <div class="no-comments">No notes yet</div>
      </div>
      <div class="comments-input-area">
        <div class="mentions-dropdown" id="mentionsDropdown" style="display:none;"></div>
        <textarea id="commentInput" placeholder="Add a note... (use @ to mention)" rows="2" oninput="handleCommentInput(event)"></textarea>
        <button class="btn-add-comment" onclick="addComment()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
          </svg>
        </button>
      </div>
    </div>
  </div>

</div>

</div> <!-- Close main-layout -->

<!-- Profile Slide Panel -->
<div class="profile-slide-overlay" id="profileSlideOverlay" onclick="if(event.target===this)closeProfile()">
  <div class="profile-slide-panel">
    <div class="profile-panel-header">
      <h2>Profile Settings</h2>
      <button class="profile-panel-close" onclick="closeProfile()" aria-label="Close profile">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="profile-panel-body">
      <div class="profile-panel-avatar-section">
        <div class="profile-panel-avatar" id="profilePanelAvatar">
          <span id="profilePanelInitials">--</span>
        </div>
        <div class="profile-panel-user-info">
          <h3 id="profilePanelName">Loading...</h3>
          <p id="profilePanelEmail">loading@example.com</p>
          <span class="profile-panel-role" id="profilePanelRole">Agent</span>
        </div>
      </div>
      <form id="profilePanelForm" onsubmit="saveProfilePanel(event)">
        <div class="profile-panel-grid">
          <div class="profile-panel-field">
            <label>First Name</label>
            <input type="text" id="profileFirstName" placeholder="First name">
          </div>
          <div class="profile-panel-field">
            <label>Last Name</label>
            <input type="text" id="profileLastName" placeholder="Last name">
          </div>
          <div class="profile-panel-field">
            <label>Username</label>
            <input type="text" id="profileUsername" disabled>
          </div>
          <div class="profile-panel-field">
            <label>Email</label>
            <input type="email" id="profileEmailField" disabled>
          </div>
          <div class="profile-panel-field profile-panel-full">
            <label>Avatar URL</label>
            <input type="url" id="profileAvatarUrl" placeholder="https://example.com/avatar.jpg">
          </div>
        </div>
        <div class="profile-panel-actions">
          <button type="button" class="profile-panel-btn secondary" onclick="closeProfile()">Cancel</button>
          <button type="submit" class="profile-panel-btn primary" id="profileSaveBtn">Save Changes</button>
        </div>
      </form>
      <div class="profile-panel-divider"></div>
      <h3 class="profile-panel-section-title">Change Password</h3>
      <form id="profilePasswordForm" onsubmit="changeProfilePassword(event)">
        <div class="profile-panel-grid">
          <div class="profile-panel-field profile-panel-full">
            <label>Current Password</label>
            <input type="password" id="profileCurrentPassword" placeholder="Current password">
          </div>
          <div class="profile-panel-field">
            <label>New Password</label>
            <input type="password" id="profileNewPassword" placeholder="New password">
          </div>
          <div class="profile-panel-field">
            <label>Confirm Password</label>
            <input type="password" id="profileConfirmPassword" placeholder="Confirm password">
          </div>
        </div>
        <div class="profile-panel-actions">
          <button type="submit" class="profile-panel-btn primary" id="profilePasswordBtn">Update Password</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="settings-modal-overlay" style="display: none;" onclick="if(event.target === this) closeSettingsModal()">
  <div class="settings-modal">
    <div class="settings-modal-header">
      <h2>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        Settings
      </h2>
      <button class="settings-modal-close" onclick="closeSettingsModal()" aria-label="Close settings">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="settings-modal-body" id="settingsModalBody">
      <!-- Theme content will be rendered here -->
    </div>
  </div>
</div>

<!-- Keyboard Shortcuts Modal -->
<div id="shortcutsModal" class="settings-modal-overlay" style="display: none;" onclick="if(event.target === this) closeShortcutsModal()">
  <div class="settings-modal" style="max-width: 480px;">
    <div class="settings-modal-header">
      <h2>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707" />
        </svg>
        Keyboard Shortcuts
      </h2>
      <button class="settings-modal-close" onclick="closeShortcutsModal()" aria-label="Close shortcuts">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="settings-modal-body">
      <div class="shortcuts-grid">
        <div class="shortcut-row"><span class="shortcut-label">Search conversations</span><div class="shortcut-keys"><kbd>Ctrl</kbd><span>+</span><kbd>K</kbd></div></div>
        <div class="shortcut-row"><span class="shortcut-label">Send message</span><div class="shortcut-keys"><kbd>Ctrl</kbd><span>+</span><kbd>Enter</kbd></div></div>
        <div class="shortcut-row"><span class="shortcut-label">Close modal / panel</span><div class="shortcut-keys"><kbd>Esc</kbd></div></div>
        <div class="shortcut-row"><span class="shortcut-label">Show shortcuts</span><div class="shortcut-keys"><kbd>?</kbd></div></div>
      </div>
    </div>
  </div>
</div>

<!-- Upgrade Modal -->
<div id="upgradeModal" class="upgrade-modal-overlay" onclick="if(event.target === this) closeUpgradeModal()">
  <div class="upgrade-modal">
    <div class="upgrade-modal-header">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
      </svg>
      <h2 id="upgradeModalTitle">Upgrade Required</h2>
      <p id="upgradeModalSubtitle">This feature requires a plan upgrade</p>
    </div>
    <div class="upgrade-modal-body">
      <div class="upgrade-feature-info" id="upgradeFeatureInfo">
        <h3>
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
          <span id="upgradeFeatureName">AI Analysis</span>
        </h3>
        <p id="upgradeFeatureDesc">Get real-time insights about customer sentiment, buying intent, and recommended responses.</p>
      </div>
      <div class="upgrade-usage-status" id="upgradeUsageStatus" style="display: none;">
        <span class="label">Current Usage</span>
        <span class="value" id="upgradeUsageValue">0 / 0</span>
      </div>

      <!-- Contact Admin Message -->
      <div class="upgrade-contact-admin">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <p>Please contact your <strong>Site Administrator</strong> to upgrade your plan and unlock this feature.</p>
      </div>

      <div class="upgrade-modal-actions">
        <button class="btn-upgrade" onclick="closeUpgradeModal()" style="width: 100%;">
          <span style="display: flex; align-items: center; justify-content: center; gap: 6px;">
            Got it
          </span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Email Compose Modal -->
<div id="emailModal" class="email-modal-overlay" style="display: none;" onclick="if(event.target === this) closeEmailModal()">
  <div class="email-modal">
    <div class="email-modal-header">
      <h3>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
        </svg>
        Send Email
      </h3>
      <button class="email-modal-close" onclick="closeEmailModal()">&times;</button>
    </div>
    <div class="email-modal-body">
      <div class="email-form-group">
        <label>To</label>
        <input type="email" id="emailTo" readonly />
      </div>
      <div class="email-form-group">
        <label>Subject</label>
        <input type="text" id="emailSubject" placeholder="Enter subject..." />
      </div>
      <div class="email-form-group">
        <label>Message</label>
        <textarea id="emailBody" rows="8" placeholder="Write your message..."></textarea>
      </div>
    </div>
    <div class="email-modal-footer">
      <button class="btn-cancel" onclick="closeEmailModal()">Cancel</button>
      <button class="btn-send" id="btnSendEmailSubmit" onclick="sendEmail()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
        </svg>
        Send Email
      </button>
    </div>
  </div>
</div>

<!-- Transfer Conversation Modal -->
<div id="transferModal" class="transfer-modal-overlay" style="display: none;" onclick="if(event.target === this) closeTransferModal()">
  <div class="transfer-modal">
    <div class="transfer-modal-header">
      <h3>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
        </svg>
        Transfer Conversation
      </h3>
      <button class="transfer-modal-close" onclick="closeTransferModal()">&times;</button>
    </div>
    <div class="transfer-modal-body">
      <p class="transfer-info">Select an agent to transfer this conversation to:</p>
      <div class="agents-list" id="transferAgentsList">
        <div class="loading-agents">Loading agents...</div>
      </div>
      <div class="transfer-note">
        <label>Add a note (optional)</label>
        <textarea id="transferNote" placeholder="Add context for the receiving agent..."></textarea>
      </div>
    </div>
    <div class="transfer-modal-footer">
      <button class="btn-cancel" onclick="closeTransferModal()">Cancel</button>
      <button class="btn-transfer-confirm" id="btnTransferConfirm" onclick="confirmTransfer()" disabled>
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
        </svg>
        Transfer
      </button>
    </div>
  </div>
</div>

<!-- Close Conversation Modal -->
<div id="closeConvModal" class="close-conv-modal-overlay" style="display: none;" onclick="if(event.target === this) closeCloseConversationModal()">
  <div class="close-conv-modal">
    <div class="close-conv-modal-header">
      <h3>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Close Conversation
      </h3>
      <button class="close-conv-modal-close" onclick="closeCloseConversationModal()">&times;</button>
    </div>
    <div class="close-conv-modal-body">
      <p class="close-conv-info">Are you sure you want to close this conversation?</p>

      <div class="csat-option">
        <label class="csat-checkbox">
          <input type="checkbox" id="sendCsatCheckbox" checked>
          <span class="checkmark"></span>
          Request customer satisfaction rating
        </label>
        <p class="csat-hint">Customer will be asked to rate their experience (1-5 stars)</p>
      </div>

      <div class="close-conv-note">
        <label>Closing note (optional)</label>
        <textarea id="closeConvNote" placeholder="Add a note about the resolution..."></textarea>
      </div>

      <div class="close-conv-status">
        <label>Resolution status</label>
        <select id="closeConvStatus">
          <option value="resolved">Resolved</option>
          <option value="unresolved">Unresolved</option>
          <option value="spam">Spam</option>
          <option value="no-response">No Response</option>
        </select>
      </div>
    </div>
    <div class="close-conv-modal-footer">
      <button class="btn-cancel" onclick="closeCloseConversationModal()">Cancel</button>
      <button class="btn-close-confirm" id="btnCloseConfirm" onclick="confirmCloseConversation()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Close Conversation
      </button>
    </div>
  </div>
</div>

<!-- Agent Chat Floating Modal -->
<div id="agentChatModal" class="agent-chat-modal" style="display: none;">
  <div class="agent-chat-header">
    <div class="agent-chat-header-info">
      <div class="agent-chat-avatar" id="agentChatAvatar">A</div>
      <div class="agent-chat-details">
        <span class="agent-chat-name" id="agentChatName">Agent Name</span>
        <span class="agent-chat-status" id="agentChatStatus">Online</span>
      </div>
    </div>
    <button class="agent-chat-close" onclick="closeAgentChat()">&times;</button>
  </div>
  <div class="agent-chat-messages" id="agentChatMessages">
    <div class="agent-chat-empty">Start a conversation</div>
  </div>
  <div class="agent-chat-typing" id="agentChatTyping" style="display: none;">
    <span></span><span></span><span></span>
  </div>
  <div class="agent-chat-input-area">
    <input type="text" id="agentChatInput" placeholder="Type a message..." onkeydown="if(event.key==='Enter')sendAgentMessage()">
    <button onclick="sendAgentMessage()">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
      </svg>
    </button>
  </div>
</div>

<!-- Floating Agents Panel -->
<div id="agentsPanel" class="agents-panel" style="display: none;">
  <div class="agents-panel-header">
    <h3>
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
      Team Chat
    </h3>
    <button class="agents-panel-close" onclick="toggleAgentsPanel()">&times;</button>
  </div>
  <div class="agents-panel-list" id="agentsPanelList">
    <div class="no-agents-panel">No other agents online</div>
  </div>
</div>

<!-- Supervisor View Modal -->
<div id="supervisorModal" class="supervisor-modal-overlay" style="display: none;" onclick="if(event.target === this) closeSupervisorModal()">
  <div class="supervisor-modal">
    <div class="supervisor-modal-header">
      <h3>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
        Supervisor Dashboard
      </h3>
      <button class="supervisor-modal-close" onclick="closeSupervisorModal()">&times;</button>
    </div>
    <div class="supervisor-modal-body">
      <!-- Stats Panel -->
      <div class="supervisor-stats">
        <div class="stat-card">
          <div class="stat-value" id="statOnlineAgents">0</div>
          <div class="stat-label">Online Agents</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statTotalAgents">0</div>
          <div class="stat-label">Total Agents</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statActiveConvs">0</div>
          <div class="stat-label">Active Chats</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statTotalConvs">0</div>
          <div class="stat-label">Unassigned</div>
        </div>
      </div>

      <div class="supervisor-panels">
        <!-- Agents Panel -->
        <div class="supervisor-panel">
          <div class="supervisor-panel-header">
            <h4>Agents</h4>
            <button class="btn-refresh" onclick="loadSupervisorData()">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
            </button>
          </div>
          <div class="supervisor-agents-list" id="supervisorAgentsList">
            <div class="loading-supervisor">Loading...</div>
          </div>
        </div>

        <!-- Conversations Panel -->
        <div class="supervisor-panel">
          <div class="supervisor-panel-header">
            <h4>Active Conversations</h4>
          </div>
          <div class="supervisor-conversations-list" id="supervisorConversationsList">
            <div class="loading-supervisor">Loading...</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Filter Drawer (Slide-out from Right) -->
<div class="filter-drawer-overlay" id="filterDrawerOverlay" onclick="closeFilterDrawer()"></div>
<div class="filter-drawer" id="filterDrawer">
  <div class="filter-drawer-header">
    <h3>
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
      </svg>
      Filter Conversations
    </h3>
    <button class="filter-drawer-close" onclick="closeFilterDrawer()">&times;</button>
  </div>
  <div class="filter-drawer-body">
    <div class="filter-section">
      <div class="filter-section-title">Basic Filters</div>
      <div class="filter-group">
        <div class="filter-label">Status</div>
        <div class="filter-chips">
          <button class="filter-chip" data-filter="status" data-value="active" onclick="toggleFilterChip(this)">Active</button>
          <button class="filter-chip" data-filter="status" data-value="closed" onclick="toggleFilterChip(this)">Closed</button>
          <button class="filter-chip" data-filter="status" data-value="pending" onclick="toggleFilterChip(this)">Pending</button>
        </div>
      </div>
      <div class="filter-group">
        <div class="filter-label">Priority</div>
        <div class="filter-chips">
          <button class="filter-chip" data-filter="priority" data-value="normal" onclick="toggleFilterChip(this)">Normal</button>
          <button class="filter-chip" data-filter="priority" data-value="high" onclick="toggleFilterChip(this)">High</button>
          <button class="filter-chip" data-filter="priority" data-value="urgent" onclick="toggleFilterChip(this)">Urgent</button>
        </div>
      </div>
      <div class="filter-group">
        <div class="filter-label">Resolution</div>
        <div class="filter-chips">
          <button class="filter-chip" data-filter="resolutionStatus" data-value="resolved" onclick="toggleFilterChip(this)">Resolved</button>
          <button class="filter-chip" data-filter="resolutionStatus" data-value="unresolved" onclick="toggleFilterChip(this)">Unresolved</button>
          <button class="filter-chip" data-filter="resolutionStatus" data-value="spam" onclick="toggleFilterChip(this)">Spam</button>
        </div>
      </div>
    </div>
    <div class="filter-section">
      <div class="filter-section-title">Date & Assignment</div>
      <div class="filter-group">
        <div class="filter-label">Date Range</div>
        <div class="filter-row">
          <div class="filter-field">
            <span class="filter-field-label">From</span>
            <input type="date" class="filter-input" id="filterDateFrom" />
          </div>
          <div class="filter-field">
            <span class="filter-field-label">To</span>
            <input type="date" class="filter-input" id="filterDateTo" />
          </div>
        </div>
      </div>
      <div class="filter-group">
        <div class="filter-label">Assigned Agent</div>
        <select class="filter-select" id="filterAgent">
          <option value="">All Agents</option>
        </select>
      </div>
      <div class="filter-group">
        <div class="filter-label">Tags</div>
        <input type="text" class="filter-input" id="filterTags" placeholder="Enter comma-separated tags..." />
      </div>
      <div class="filter-group">
        <div class="filter-label">CSAT Rating</div>
        <div class="filter-row">
          <div class="filter-field">
            <span class="filter-field-label">Min</span>
            <select class="filter-select" id="filterRatingMin">
              <option value="">Any</option>
              <option value="1">1 Star</option>
              <option value="2">2 Stars</option>
              <option value="3">3 Stars</option>
              <option value="4">4 Stars</option>
              <option value="5">5 Stars</option>
            </select>
          </div>
          <div class="filter-field">
            <span class="filter-field-label">Max</span>
            <select class="filter-select" id="filterRatingMax">
              <option value="">Any</option>
              <option value="1">1 Star</option>
              <option value="2">2 Stars</option>
              <option value="3">3 Stars</option>
              <option value="4">4 Stars</option>
              <option value="5">5 Stars</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    <div class="filter-section filter-section-ai">
      <div class="filter-section-title">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
        </svg>
        AI-Powered Filters
      </div>
      <div class="filter-group">
        <div class="filter-label">Sentiment</div>
        <div class="filter-chips">
          <button class="filter-chip filter-chip-positive" data-filter="sentiment" data-value="positive" onclick="toggleFilterChip(this)">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            Positive
          </button>
          <button class="filter-chip filter-chip-neutral" data-filter="sentiment" data-value="neutral" onclick="toggleFilterChip(this)">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            Neutral
          </button>
          <button class="filter-chip filter-chip-negative" data-filter="sentiment" data-value="negative" onclick="toggleFilterChip(this)">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            Negative
          </button>
        </div>
      </div>
      <div class="filter-group">
        <div class="filter-label">Customer Intent</div>
        <select class="filter-select" id="filterIntent">
          <option value="">All Intents</option>
          <option value="purchase">Purchase Intent</option>
          <option value="support">Support Request</option>
          <option value="complaint">Complaint</option>
          <option value="billing">Billing Inquiry</option>
          <option value="technical">Technical Issue</option>
          <option value="general">General Question</option>
        </select>
      </div>
      <div class="filter-group">
        <div class="filter-label">Urgency Level</div>
        <div class="filter-chips">
          <button class="filter-chip filter-chip-urgency-low" data-filter="urgency" data-value="low" onclick="toggleFilterChip(this)">Low</button>
          <button class="filter-chip filter-chip-urgency-medium" data-filter="urgency" data-value="medium" onclick="toggleFilterChip(this)">Medium</button>
          <button class="filter-chip filter-chip-urgency-high" data-filter="urgency" data-value="high" onclick="toggleFilterChip(this)">High</button>
        </div>
      </div>
    </div>
  </div>
  <div class="filter-drawer-footer">
    <button class="filter-clear-btn" onclick="clearAllFilters()">
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
      </svg>
      Clear All
    </button>
    <button class="filter-apply-btn" onclick="applyFilters()">
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
      Apply Filters
    </button>
  </div>
</div>

<!-- Workflows Modal -->
<div id="workflowsModal" class="workflows-modal-overlay" style="display: none;" onclick="if(event.target === this) closeWorkflowsModal()">
  <div class="workflows-modal">
    <div class="workflows-modal-header">
      <h3>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Automated Workflows
      </h3>
      <button class="workflows-modal-close" onclick="closeWorkflowsModal()">&times;</button>
    </div>
    <div class="workflows-modal-body">
      <!-- List View -->
      <div id="workflowListView">
        <div class="workflows-toolbar">
          <button class="workflow-add-btn" onclick="showWorkflowEditor()">+ New Workflow</button>
        </div>
        <div class="workflows-list" id="workflowsList">
          <div class="no-workflows">No workflows configured yet</div>
        </div>
      </div>
      <!-- Editor View -->
      <div id="workflowEditorView" style="display:none;">
        <div class="workflow-editor">
          <div class="workflow-editor-header">
            <h4 id="workflowEditorTitle">New Workflow</h4>
            <button class="workflow-back-btn" onclick="hideWorkflowEditor()">Back to List</button>
          </div>
          <div class="workflow-form">
            <div class="workflow-form-group">
              <label>Name</label>
              <input type="text" id="wfName" class="filter-input" placeholder="Workflow name" />
            </div>
            <div class="workflow-form-group">
              <label>Description</label>
              <input type="text" id="wfDescription" class="filter-input" placeholder="Optional description" />
            </div>
            <div class="workflow-form-group">
              <label>Trigger</label>
              <select id="wfTrigger" class="filter-select">
                <option value="new_message">New Message</option>
                <option value="customer_join">Customer Join</option>
                <option value="conversation_idle">Conversation Idle</option>
                <option value="sentiment_change">Sentiment Change</option>
              </select>
            </div>
            <div class="workflow-form-group">
              <label>Priority</label>
              <input type="number" id="wfPriority" class="filter-input" value="0" min="0" />
            </div>
            <div class="workflow-form-group">
              <label>Conditions</label>
              <div id="wfConditions"></div>
              <button class="workflow-add-row-btn" onclick="addConditionRow()">+ Add Condition</button>
            </div>
            <div class="workflow-form-group">
              <label>Actions</label>
              <div id="wfActions"></div>
              <button class="workflow-add-row-btn" onclick="addActionRow()">+ Add Action</button>
            </div>
            <div class="workflow-form-actions">
              <button class="filter-clear-btn" onclick="hideWorkflowEditor()">Cancel</button>
              <button class="filter-apply-btn" onclick="saveWorkflow()">Save Workflow</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CSAT Feedback Modal -->
<div id="csatFeedbackModal" class="csat-feedback-modal-overlay" style="display: none;" onclick="if(event.target === this) closeCsatFeedbackModal()">
  <div class="csat-feedback-modal">
    <div class="csat-feedback-modal-header">
      <h3>Customer Feedback</h3>
      <button class="csat-feedback-modal-close" onclick="closeCsatFeedbackModal()">&times;</button>
    </div>
    <div class="csat-feedback-modal-body">
      <div class="csat-feedback-rating">
        <span class="csat-feedback-stars" id="csatFeedbackStars"></span>
        <span class="csat-feedback-score" id="csatFeedbackScore"></span>
      </div>
      <div class="csat-feedback-label">Customer Comment</div>
      <div class="csat-feedback-text" id="csatFeedbackText"></div>
    </div>
  </div>
</div>

<script src="/config.js"></script>
<script src="/branding.js"></script>
<script>
// ==================== CONFIG ====================
const params = new URLSearchParams(window.location.search);
const siteId = params.get("siteId");
const token = params.get("token");

if (!siteId || !token) {
  alert("Unauthorized");
  location.href = "/login";
  throw new Error("Missing auth");
}

// Get username from token (we'll update this when connected)
let currentUsername = "Agent";

// ==================== STATE ====================
let currentVisitor = null;
let loggedOut = false;
let pendingFile = null;
let analysisEnabled = false;  // Toggle 1: AI Analysis (default OFF)
let autoReplyEnabled = false; // Toggle 2: Auto Reply (default OFF)
const users = {}; // visitorId -> { name, messages: [], typing: false, unread: 0, lastActivity: Date, analysis: null }

// Agent status state
let agentStatus = 'online'; // 'online', 'away', 'busy'
let selectedTransferAgent = null;
let siteAgents = []; // List of agents for transfer
const originalTitle = document.title;

// Plan/Subscription state
let sitePlan = null;
let siteUsage = [];
let aiAnalysisAvailable = false;
let aiAutoReplyAvailable = false;
let aiAnalysisLimitExhausted = false;
let aiAutoReplyLimitExhausted = false;

// Platform feature flags (from admin settings)
let platformFeatures = {
  supervisorMode: true,
  aiAnalysis: true,
  aiAutoReply: true,
  fileSharing: true,
  csatRatings: true,
  visitorInfo: true,
  cannedResponses: true,
  conversationTransfer: true,
  teamChat: true,
  typingIndicators: true,
  readReceipts: true,
  internalNotes: true,
  emojiPicker: true,
  emailSending: true,
  conversationSearch: true,
  messageSearch: true,
  bulkActions: true,
  themes: true,
  agentStatus: true,
  notifications: true
};

// Bulk select state
let bulkSelectMode = false;
const selectedConversations = new Set();

// Message search state
let messageSearchResults = [];
let currentSearchIndex = -1;

// ==================== WEBSOCKET ====================
const wsProtocol = location.protocol === "https:" ? "wss:" : "ws:";
const ws = new WebSocket(`${wsProtocol}//${location.host}/ws?siteId=${siteId}&role=support&token=${token}`);

ws.onopen = () => {
  console.log("Connected to support WebSocket");
  updateConnectionStatus('connected');
  console.log("Triggering loadHistoricalConversations...");
  loadHistoricalConversations();
  loadSiteAgents(); // Load agents for transfer feature
  loadPlatformFeatures(); // Load platform feature flags
};

ws.onmessage = (e) => {
  if (loggedOut) return;
  const data = JSON.parse(e.data);

  // Restore toggle states from backend (loaded from DB)
  if (data.type === "toggle_state") {
    analysisEnabled = data.analysis_enabled ?? false;
    autoReplyEnabled = data.auto_reply_enabled ?? false;
    const analysisCheckbox = document.getElementById("toggleAnalysis");
    const autoReplyCheckbox = document.getElementById("toggleAutoReply");
    if (analysisCheckbox) analysisCheckbox.checked = analysisEnabled;
    if (autoReplyCheckbox) autoReplyCheckbox.checked = autoReplyEnabled;
    console.log("Toggle state restored from DB:", { analysisEnabled, autoReplyEnabled });
  }

  // New visitor joined
  if (data.type === "user_joined") {
    const vid = data.visitorId;
    if (!users[vid]) {
      users[vid] = {
        name: data.name,
        email: data.email,
        conversationId: data.conversationId,
        messages: [],
        typing: false,
        unread: 0,
        lastActivity: new Date(),
        analysis: null,
        isOnline: true,
        tags: data.tags || []
      };
    } else {
      // User exists from historical data, update online status
      users[vid].isOnline = true;
      users[vid].lastActivity = new Date();
      if (data.conversationId) users[vid].conversationId = data.conversationId;
      if (data.email) users[vid].email = data.email;
      if (data.tags && data.tags.length > 0) users[vid].tags = data.tags;
    }
    renderUsers();
    if (!currentVisitor) selectUser(vid);
  }

  // Visitor left
  if (data.type === "user_left") {
    if (users[data.visitorId]) {
      users[data.visitorId].isOnline = false;
      renderUsers();
      // Update header status if this is current conversation
      if (currentVisitor === data.visitorId) {
        const statusEl = document.getElementById("chatHeaderStatus");
        if (statusEl) {
          statusEl.textContent = "Offline";
          statusEl.style.color = "#94a3b8";
        }
      }
    }
  }

  // Conversation updated (tags, etc.) - real-time update
  if (data.type === "conversation_updated") {
    const convId = data.conversationId;
    // Find the user with this conversation
    for (const vid in users) {
      if (users[vid].conversationId === convId) {
        if (data.tags) {
          users[vid].tags = data.tags;
        }
        renderUsers();
        // Update header if this is the current conversation
        if (currentVisitor === vid) {
          const headerTags = document.getElementById("chatHeaderTags");
          const tags = users[vid].tags || [];
          if (tags.length > 0) {
            headerTags.innerHTML = tags.map(tag => `<span class="header-tag">${escapeHtml(tag)}</span>`).join('');
            headerTags.style.display = 'flex';
          } else {
            headerTags.innerHTML = '';
            headerTags.style.display = 'none';
          }
        }
        break;
      }
    }
  }

  // Typing indicators
  if (data.type === "typing_start") {
    if (users[data.visitorId]) {
      users[data.visitorId].typing = true;
      renderUsers();
      if (currentVisitor === data.visitorId) showTypingIndicator();
    }
  }

  if (data.type === "typing_stop") {
    if (users[data.visitorId]) {
      users[data.visitorId].typing = false;
      renderUsers();
      if (currentVisitor === data.visitorId) hideTypingIndicator();
    }
  }

  // Customer message
  if (data.type === "message") {
    const vid = data.from;
    if (!users[vid]) {
      users[vid] = {
        name: data.name || vid,
        messages: [],
        typing: false,
        unread: 0,
        lastActivity: new Date(),
        analysis: null,
        conversationId: data.conversationId || null
      };
    }

    // Update conversationId if provided
    if (data.conversationId) {
      users[vid].conversationId = data.conversationId;
    }

    const msgObj = {
      from: "customer",
      text: data.message,
      time: new Date()
    };

    if (data.file) {
      msgObj.file = data.file;
    }

    users[vid].messages.push(msgObj);
    users[vid].lastActivity = new Date();
    users[vid].typing = false;

    if (vid !== currentVisitor) {
      users[vid].unread++;
    }

    renderUsers();

    if (vid === currentVisitor) {
      renderMessages();
      hideTypingIndicator();
    }

    // Send delivery acknowledgement back to customer widget
    if (platformFeatures.readReceipts && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({
        type: 'message_delivered',
        to: vid,
        timestamp: msgObj.time.toISOString()
      }));
    }

    // Play notification sound if tab is not focused
    if (typeof playNotificationSound === 'function') {
      playNotificationSound();
    }

    // Note: Don't call analyzeConversation here - Python server already sends analysis via WebSocket
    // The analysis will arrive via data.type === "analysis" message
  }

  // AI analysis (only store/display if enabled) - received from Python WebSocket
  if (data.type === "analysis") {
    if (users[data.from]) {
      users[data.from].analysis = data.analysis;
      if (currentVisitor === data.from && analysisEnabled) {
        renderAnalysis(data.analysis);
      }
    }
  }

  // Auto-reply sent notification
  if (data.type === "auto_reply_sent") {
    const vid = data.to;
    if (users[vid]) {
      // Add auto-reply to messages
      users[vid].messages.push({
        from: "support",
        text: data.message,
        time: new Date(),
        isAutoReply: true
      });
      users[vid].lastActivity = new Date();

      // Update UI if this is the current conversation
      if (currentVisitor === vid) {
        renderMessages();
      }
      renderUsers();

      // Show toast notification
      showToast(`Auto-replied to ${users[vid].name}`, "success");
    }
  }

  // AI usage update - real-time usage tracking
  if (data.type === "ai_usage_update") {
    updateAiUsageDisplay(data.feature, data.used, data.limit);
  }

  // AI limit reached notification
  if (data.type === "ai_limit_reached") {
    handleAiLimitReached(data.feature, data.message, data.used, data.limit);
  }

  // Welcome message sent notification
  if (data.type === "welcome_sent") {
    const vid = data.visitorId;
    if (users[vid]) {
      // Add welcome message to conversation
      users[vid].messages.push({
        from: "support",
        text: data.message,
        time: new Date(),
        isWelcome: true
      });

      // Update UI if this is the current conversation
      if (currentVisitor === vid) {
        renderMessages();
      }
    }
  }

  // CSAT rating received from customer
  if (data.type === "csat_received") {
    const vid = data.visitorId;
    const rating = data.rating;
    const feedback = data.feedback;
    displayCsatRating(vid, rating, feedback);
  }

  // Conversation closed confirmation
  if (data.type === "conversation_closed") {
    const vid = data.visitorId;
    if (users[vid]) {
      users[vid].isClosed = true;
      users[vid].closedAt = new Date();
      users[vid].closedStatus = data.status;

      if (currentVisitor === vid) {
        updateChatHeaderForClosedConversation();
      }
      renderUsers();
    }
  }

  // Workflow notifications
  if (data.type === "workflow_notification") {
    showToast(data.message || "Workflow action executed", "info");
  }

  if (data.type === "escalation") {
    showToast(data.message || "Conversation escalated!", "warning");
  }

  if (data.type === "workflows_loaded") {
    console.log("Workflows loaded on server:", data.count);
  }
};

ws.onclose = () => {
  if (!loggedOut) {
    console.log("WebSocket closed");
    updateConnectionStatus('disconnected');
    // Try to reconnect after 3 seconds
    setTimeout(() => {
      if (!loggedOut) {
        updateConnectionStatus('reconnecting');
        location.reload();
      }
    }, 3000);
  }
};

ws.onerror = () => {
  updateConnectionStatus('disconnected');
};

// ==================== VERSION ====================
const APP_VERSION = '1.0.1';
document.getElementById('sidebarVersion').textContent = `v${APP_VERSION}`;

// ==================== LOAD HISTORICAL DATA ====================
const API_BASE = CONFIG.API_BASE;

// ==================== FREE TRIAL BANNER ====================
(async function loadSupportTrialBanner() {
  try {
    const res = await fetch(`${API_BASE}/subscriptions/sites/${siteId}/overview`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!res.ok) return;
    const json = await res.json();
    const data = json.success ? json.data : json;
    const subscription = data?.subscription;
    if (!subscription) return;

    const plan = data?.plan;
    const isFree = plan && plan.monthlyPrice === 0;
    if (!isFree) return;

    const status = subscription.status;
    const now = new Date();
    let daysLeft = 0;
    let bannerText = '';

    if (status === 'trialing' && subscription.trialEnd) {
      daysLeft = Math.ceil((new Date(subscription.trialEnd) - now) / (1000 * 60 * 60 * 24));
      if (daysLeft <= 0) {
        bannerText = 'Your free trial has expired.';
      } else {
        bannerText = `Free trial: <strong>${daysLeft} day${daysLeft === 1 ? '' : 's'}</strong> remaining.`;
      }
    } else if (status === 'expired') {
      bannerText = 'Your free trial has expired.';
      daysLeft = 0;
    } else {
      return;
    }

    const isExpired = daysLeft <= 0;
    const isUrgent = daysLeft <= 3;
    const bgColor = isExpired ? '#ef4444' : isUrgent ? '#f59e0b' : '#0ea5e9';

    const banner = document.getElementById('freeTrialBanner');
    if (banner) {
      banner.style.display = 'flex';
      banner.style.cssText = `background: ${bgColor}; color: white; padding: 6px 24px; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 12px; z-index: 49;`;
      banner.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="flex-shrink: 0;">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>${bannerText}</span>
        <a href="/site-admin/site-admin-subscription.html?siteId=${siteId}&token=${token}" style="color: white; text-decoration: underline; font-weight: 600; white-space: nowrap;" target="_blank">Upgrade Now</a>
      `;
    }
  } catch (err) {
    console.error('Trial banner error:', err);
  }
})();

function showConversationSkeletons() {
  const ul = document.getElementById("usersList");
  let skeletonHtml = '';
  for (let i = 0; i < 6; i++) {
    skeletonHtml += `<div class="skeleton-item"><div class="skeleton-avatar"></div><div class="skeleton-lines"><div class="skeleton-line"></div><div class="skeleton-line"></div></div></div>`;
  }
  ul.innerHTML = skeletonHtml;
}

function showConversationError(message) {
  const ul = document.getElementById("usersList");
  ul.innerHTML = `<div class="error-state">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
    </svg>
    <h4>Failed to load conversations</h4>
    <p>${message || 'Something went wrong'}</p>
    <button class="btn-retry" onclick="loadHistoricalConversations()">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
      Retry
    </button>
  </div>`;
}

function showMessageSkeletons() {
  messagesContainer.innerHTML = '';
  for (let i = 0; i < 4; i++) {
    const side = i % 2 === 0 ? 'left' : 'right';
    const widths = side === 'left' ? ['80%', '60%'] : ['70%', '50%'];
    messagesContainer.innerHTML += `<div class="skeleton-message ${side}"><div class="skeleton-line" style="width:${widths[0]}"></div><div class="skeleton-line" style="width:${widths[1]}"></div></div>`;
  }
}

function showMessageError(visitorId, message) {
  messagesContainer.innerHTML = `<div class="error-state">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
    </svg>
    <h4>Failed to load messages</h4>
    <p>${message || 'Something went wrong'}</p>
    <button class="btn-retry" onclick="retryLoadMessages('${visitorId}')">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
      Retry
    </button>
  </div>`;
}

function retryLoadMessages(visitorId) {
  if (users[visitorId]) {
    users[visitorId].messagesLoaded = false;
  }
  loadConversationMessages(visitorId);
}

async function loadHistoricalConversations() {
  console.log("Loading historical conversations...");
  console.log("API_BASE:", API_BASE);
  console.log("siteId:", siteId);
  console.log("token:", token ? token.substring(0, 50) + "..." : "null");

  // Show loading skeletons
  showConversationSkeletons();

  try {
    const url = `${API_BASE}/sites/${siteId}/conversations`;
    console.log("Fetching:", url);

    const response = await fetch(url, {
      headers: { "Authorization": `Bearer ${token}` }
    });

    console.log("Response status:", response.status);

    if (!response.ok) {
      const errorText = await response.text();
      console.error("API error:", response.status, errorText);
      showConversationError('Server returned an error. Please try again.');
      showToast('Failed to load conversations', 'error');
      return;
    }

    const result = await response.json();
    console.log("API result:", result);

    if (!result.success) {
      console.error("API returned failure:", result);
      showConversationError('Could not load conversations.');
      showToast('Failed to load conversations', 'error');
      return;
    }

    const conversations = result.data.items || [];
    console.log("Found", conversations.length, "conversations");

    for (const conv of conversations) {
      const vid = conv.visitorId;
      // Build analysis summary from API fields
      const analysisSummary = (conv.sentiment || conv.intent || conv.urgencyScore != null) ? {
        sentiment: conv.sentiment,
        sentimentScore: conv.sentimentScore,
        intent: conv.intent,
        urgencyScore: conv.urgencyScore
      } : null;

      if (!users[vid]) {
        users[vid] = {
          name: conv.visitorName || "Visitor",
          email: conv.visitorEmail,
          conversationId: conv.id,
          messages: [],
          typing: false,
          unread: conv.unreadCount || 0,
          lastActivity: new Date(conv.lastMessageAt || conv.createdAt),
          lastMessagePreview: conv.lastMessagePreview,
          analysis: analysisSummary,
          isOnline: false,
          status: conv.status,
          priority: conv.priority,
          assignedUserId: conv.assignedUserId,
          tags: conv.tags,
          csatRating: conv.rating,
          csatFeedback: conv.ratingFeedback,
          resolutionStatus: conv.resolutionStatus
        };
      } else {
        // Merge historical data into existing user (e.g., from WebSocket user_joined)
        if (!users[vid].conversationId) {
          users[vid].conversationId = conv.id;
        }
        if (!users[vid].email) {
          users[vid].email = conv.visitorEmail;
        }
        // Use actual last message time from DB for sorting (WebSocket join time is not accurate)
        const historicalActivity = new Date(conv.lastMessageAt || conv.createdAt);
        if (!users[vid].messages.length) {
          users[vid].lastActivity = historicalActivity;
        }
        users[vid].lastMessagePreview = users[vid].lastMessagePreview || conv.lastMessagePreview;
        users[vid].unread = users[vid].unread || conv.unreadCount || 0;
        if (analysisSummary && !users[vid].analysis) users[vid].analysis = analysisSummary;
        users[vid].status = conv.status;
        users[vid].priority = conv.priority;
        users[vid].assignedUserId = conv.assignedUserId;
        users[vid].tags = conv.tags;
        users[vid].csatRating = conv.rating;
        users[vid].csatFeedback = conv.ratingFeedback;
        users[vid].resolutionStatus = conv.resolutionStatus;

        // If this is the currently selected user and messages weren't loaded yet, load them now
        if (currentVisitor === vid && !users[vid].messagesLoaded && users[vid].conversationId) {
          loadConversationMessages(vid);
        }
      }
    }

    console.log("Users after loading:", Object.keys(users).length);
    renderUsers();

    // Update CSAT badge if a user is currently selected (data may have loaded after selectUser was called)
    if (currentVisitor && users[currentVisitor]) {
      const user = users[currentVisitor];
      const csatBadge = document.getElementById('csatBadge');
      const csatStars = document.getElementById('csatStars');
      const csatValue = document.getElementById('csatValue');
      if (user.csatRating && csatBadge && csatStars && csatValue) {
        let starsHtml = '';
        for (let i = 1; i <= 5; i++) {
          starsHtml += i <= user.csatRating ? '' : '';
        }
        csatStars.textContent = starsHtml;
        csatValue.textContent = `${user.csatRating}/5`;
        csatBadge.style.display = 'flex';
        csatBadge.className = `csat-badge csat-${user.csatRating <= 2 ? 'low' : user.csatRating <= 3 ? 'medium' : 'high'}`;
      }
    }

    // Auto-select first conversation if any
    const firstVid = Object.keys(users)[0];
    if (firstVid && !currentVisitor) {
      console.log("Auto-selecting first user:", firstVid);
      selectUser(firstVid);
    }
  } catch (err) {
    console.error("Failed to load conversations:", err);
    showConversationError('Network error. Check your connection.');
    showToast('Failed to load conversations', 'error');
  }
}

async function loadConversationMessages(visitorId) {
  const user = users[visitorId];
  console.log("Loading messages for visitor:", visitorId, "conversationId:", user?.conversationId);

  if (!user || !user.conversationId) {
    console.log("No user or conversation ID found");
    return;
  }

  // Skip if already loaded
  if (user.messagesLoaded) {
    console.log("Messages already loaded");
    return;
  }

  // Show loading skeletons
  if (currentVisitor === visitorId) {
    showMessageSkeletons();
  }

  try {
    const url = `${API_BASE}/conversations/${user.conversationId}/messages`;
    console.log("Fetching messages from:", url);

    const response = await fetch(url, {
      headers: { "Authorization": `Bearer ${token}` }
    });

    console.log("Messages response status:", response.status);

    if (!response.ok) {
      const errorText = await response.text();
      console.error("Messages API error:", response.status, errorText);
      user.messagesLoaded = false;
      if (currentVisitor === visitorId) {
        showMessageError(visitorId, 'Server returned an error.');
        showToast('Failed to load messages', 'error');
      }
      return;
    }

    const result = await response.json();
    console.log("Messages result:", result);

    if (!result.success) {
      console.error("Messages API returned failure:", result);
      user.messagesLoaded = false;
      if (currentVisitor === visitorId) {
        showMessageError(visitorId, 'Could not load messages.');
        showToast('Failed to load messages', 'error');
      }
      return;
    }

    const messages = result.data.items || [];
    console.log("Found", messages.length, "messages");

    // Convert API messages to local format
    user.messages = messages.map(m => ({
      from: m.senderType === "visitor" ? "customer" : "support",
      text: m.content,
      time: new Date(m.createdAt),
      readAt: m.readAt ? new Date(m.readAt) : null,
      deliveredAt: m.deliveredAt ? new Date(m.deliveredAt) : null,
      file: m.file ? {
        url: `${location.origin}${m.file.url}`,
        original_name: m.file.originalName,
        is_image: m.file.mimeType?.startsWith("image/"),
        size: m.file.fileSize
      } : null
    }));

    user.messagesLoaded = true;

    if (currentVisitor === visitorId) {
      renderMessages();
    }
  } catch (err) {
    console.error("Failed to load messages:", err);
    user.messagesLoaded = false;
    if (currentVisitor === visitorId) {
      showMessageError(visitorId, 'Network error. Check your connection.');
      showToast('Failed to load messages', 'error');
    }
  }
}

// Historical data is loaded in ws.onopen handler above

// ==================== DOM ELEMENTS ====================
const usersList = document.getElementById("usersList");
const chatHeader = document.getElementById("chatHeader");
const chatHeaderAvatar = document.getElementById("chatHeaderAvatar");
const chatHeaderName = document.getElementById("chatHeaderName");
const messagesContainer = document.getElementById("messagesContainer");
const chatInputArea = document.getElementById("chatInputArea");
const noChatSelected = document.getElementById("noChatSelected");
const messageInput = document.getElementById("messageInput");
const analysisContent = document.getElementById("analysisContent");
const emojiPicker = document.getElementById("emojiPicker");

// ==================== RENDER FUNCTIONS ====================
function renderUsers(filterVids) {
  // If no filterVids passed but filter is active, use stored filter results
  if (filterVids === undefined && filterActive && currentFilterVids) {
    filterVids = currentFilterVids;
  }

  // Update conversation count
  const totalCount = Object.keys(users).length;
  const isFiltering = filterVids !== undefined && filterVids !== null;
  const entries = Object.entries(users)
    .filter(([vid]) => !isFiltering || filterVids.has(vid))
    .sort((a, b) => b[1].lastActivity - a[1].lastActivity);
  const displayCount = entries.length;
  const convCountEl = document.getElementById("conversationCount");
  convCountEl.textContent = isFiltering ? `${displayCount} / ${totalCount}` : totalCount;
  convCountEl.setAttribute('data-tooltip', isFiltering ? `${displayCount} of ${totalCount} conversations shown` : `${totalCount} total conversations`);

  if (displayCount === 0) {
    const isFilterEmpty = isFiltering && filterVids.size === 0;
    usersList.innerHTML = `
      <div class="no-users ${isFiltering ? 'filtered' : ''}">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          ${isFiltering ?
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />' :
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" />'
          }
        </svg>
        <p>${isFiltering ? 'No conversations match your filters' : 'No active conversations'}</p>
        ${isFiltering ? '<button class="clear-filter-btn" onclick="clearAllFilters(); renderUsers();">Clear Filters</button>' : ''}
      </div>
    `;
    return;
  }

  usersList.innerHTML = entries
    .map(([vid, user]) => {
      const initials = getInitials(user.name);
      const lastMsg = user.messages[user.messages.length - 1];

      // Better preview logic
      let preview;
      if (user.typing) {
        preview = "typing...";
      } else if (lastMsg && lastMsg.text) {
        const prefix = lastMsg.from === "support" ? "You: " : "";
        preview = prefix + truncate(lastMsg.text, 25);
      } else if (user.lastMessagePreview) {
        preview = truncate(user.lastMessagePreview, 25);
      } else {
        preview = user.isOnline ? "Online now" : "No messages";
      }

      const timeStr = formatTime(user.lastActivity);

      const isSelected = selectedConversations.has(vid);

      // Get conversation status and priority
      const convStatus = user.status || 'active';
      const convPriority = user.priority || 'normal';

      // Build status badge
      let statusBadge = '';
      if (convStatus === 'closed') {
        statusBadge = '<span class="conversation-status-badge status-closed">Closed</span>';
      } else if (convStatus === 'pending') {
        statusBadge = '<span class="conversation-status-badge status-pending">Pending</span>';
      } else if (convPriority === 'urgent') {
        statusBadge = '<span class="conversation-status-badge priority-urgent">Urgent</span>';
      } else if (convPriority === 'high') {
        statusBadge = '<span class="conversation-status-badge priority-high">High</span>';
      }

      return `
        <div class="user-item ${vid === currentVisitor ? 'active' : ''} ${isSelected ? 'selected' : ''}" onclick="${bulkSelectMode ? `toggleConversationSelection('${vid}')` : `selectUser('${vid}')`}">
          ${bulkSelectMode ? `
            <div class="bulk-checkbox" onclick="event.stopPropagation();">
              <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleConversationSelection('${vid}')" />
            </div>
          ` : ''}
          <div class="user-avatar">
            ${initials}
            ${user.isOnline ? '<span class="status-dot"></span>' : '<span class="status-dot" style="background:#94a3b8;"></span>'}
          </div>
          <div class="user-info">
            <div class="user-name-row">
              <span class="user-name">${escapeHtml(user.name)}</span>
              ${statusBadge}
            </div>
            <div class="user-preview ${user.typing ? 'typing' : ''}">${escapeHtml(preview)}</div>
            ${(user.tags && user.tags.length > 0) ? `
              <div class="user-tags">
                ${user.tags.slice(0, 3).map(tag => `<span class="user-tag">${escapeHtml(tag)}</span>`).join('')}
                ${user.tags.length > 3 ? `<span class="user-tag user-tag-more">+${user.tags.length - 3}</span>` : ''}
              </div>
            ` : ''}
          </div>
          <div class="user-meta">
            <span class="user-time">${timeStr}</span>
            ${user.unread > 0 ? `<span class="unread-badge">${user.unread}</span>` : ''}
          </div>
          ${!bulkSelectMode ? `
            <button class="btn-delete-conv" onclick="event.stopPropagation(); deleteConversation('${vid}')" title="Delete conversation">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          ` : ''}
        </div>
      `;
    }).join('');
}

function selectUser(vid) {
  currentVisitor = vid;
  users[vid].unread = 0;

  // Send read acknowledgement for all messages in this conversation
  if (platformFeatures.readReceipts && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({
      type: 'messages_read',
      to: vid,
      timestamp: new Date().toISOString()
    }));
  }

  // Show chat UI
  noChatSelected.style.display = "none";
  chatHeader.style.display = "flex";
  messagesContainer.style.display = "flex";
  chatInputArea.style.display = "block";

  // Update header - show name with email in brackets if available
  const email = users[vid].email || "";
  chatHeaderAvatar.textContent = getInitials(users[vid].name);
  chatHeaderName.textContent = email ? `${users[vid].name} (${email})` : users[vid].name;

  // Update Send Email button
  const btnSendEmail = document.getElementById("btnSendEmail");
  btnSendEmail.style.display = email && platformFeatures.emailSending ? "flex" : "none";

  // Update header tags
  const headerTags = document.getElementById("chatHeaderTags");
  const tags = users[vid].tags || [];
  if (tags.length > 0) {
    headerTags.innerHTML = tags.map(tag => `<span class="header-tag">${escapeHtml(tag)}</span>`).join('');
    headerTags.style.display = 'flex';
  } else {
    headerTags.innerHTML = '';
    headerTags.style.display = 'none';
  }

  // Update online status
  const statusEl = document.getElementById("chatHeaderStatus");
  const user = users[vid];

  if (user.isClosed) {
    statusEl.innerHTML = `<span class="closed-badge">${user.closedStatus || 'Closed'}</span>`;
    chatInputArea.classList.add('disabled');
    document.getElementById('btnCloseMenu').style.display = 'none';
  } else {
    statusEl.textContent = user.isOnline ? "Online" : "Offline";
    statusEl.style.color = user.isOnline ? "#22c55e" : "#94a3b8";
    chatInputArea.classList.remove('disabled');
    document.getElementById('btnCloseMenu').style.display = 'flex';
  }

  // Show CSAT rating if available
  const csatBadge = document.getElementById('csatBadge');
  const csatStars = document.getElementById('csatStars');
  const csatValue = document.getElementById('csatValue');

  if (user.csatRating) {
    let starsHtml = '';
    for (let i = 1; i <= 5; i++) {
      starsHtml += i <= user.csatRating ? '' : '';
    }
    csatStars.textContent = starsHtml;
    csatValue.textContent = `${user.csatRating}/5`;
    csatBadge.style.display = 'flex';
    csatBadge.className = `csat-badge csat-${user.csatRating <= 2 ? 'low' : user.csatRating <= 3 ? 'medium' : 'high'}`;
  } else {
    csatBadge.style.display = 'none';
  }

  renderUsers();

  // Load messages from API if not already loaded
  if (!users[vid].messagesLoaded && users[vid].conversationId) {
    messagesContainer.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">Loading messages...</div>';
    loadConversationMessages(vid);
  } else {
    renderMessages();
  }

  if (analysisEnabled) {
    if (users[vid].analysis) {
      renderAnalysis(users[vid].analysis);
    } else {
      analysisContent.innerHTML = '<div class="analysis-empty"><p>Waiting for customer message to analyze...</p></div>';
    }
  } else {
    analysisContent.innerHTML = '<div class="analysis-empty"><p>Enable AI Analysis to see insights</p></div>';
  }

  messageInput.focus();
}

function showNoChat() {
  noChatSelected.style.display = "flex";
  chatHeader.style.display = "none";
  messagesContainer.style.display = "none";
  chatInputArea.style.display = "none";
  analysisContent.innerHTML = '<div class="analysis-empty"><p>Select a conversation to see AI-powered insights</p></div>';
}

async function deleteConversation(vid) {
  const user = users[vid];
  if (!user) return;

  const result = await Swal.fire({
    title: 'Delete Conversation?',
    text: `Are you sure you want to delete the conversation with ${user.name}? This action cannot be undone.`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#ef4444',
    cancelButtonColor: '#64748b',
    confirmButtonText: 'Yes, delete it',
    cancelButtonText: 'Cancel'
  });

  if (!result.isConfirmed) return;

  try {
    const conversationId = user.conversationId;
    if (!conversationId) {
      // No conversation ID means it's a live session without DB record
      delete users[vid];
      if (currentVisitor === vid) {
        currentVisitor = null;
        showNoChat();
      }
      renderUsers();
      return;
    }

    const response = await fetch(`${API_BASE}/sites/${siteId}/conversations/${conversationId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (response.ok) {
      delete users[vid];
      if (currentVisitor === vid) {
        currentVisitor = null;
        showNoChat();
      }
      renderUsers();
      console.log('Conversation deleted successfully');
    } else {
      const error = await response.json();
      Swal.fire('Error', 'Failed to delete conversation: ' + (error.detail || 'Unknown error'), 'error');
    }
  } catch (error) {
    console.error('Error deleting conversation:', error);
    Swal.fire('Error', 'Failed to delete conversation', 'error');
  }
}

// ==================== CONVERSATION ACTIONS MENU ====================
function toggleConvActionsMenu() {
  const menu = document.getElementById('convActionsMenu');
  menu.classList.toggle('open');

  if (menu.classList.contains('open')) {
    updateConvActionsMenu();
    // Close menu when clicking outside
    setTimeout(() => {
      document.addEventListener('click', closeConvActionsMenuOnOutsideClick);
    }, 10);
  } else {
    document.removeEventListener('click', closeConvActionsMenuOnOutsideClick);
  }
}

function closeConvActionsMenuOnOutsideClick(e) {
  const menu = document.getElementById('convActionsMenu');
  const btn = document.getElementById('btnMoreActions');
  if (!menu.contains(e.target) && !btn.contains(e.target)) {
    menu.classList.remove('open');
    document.removeEventListener('click', closeConvActionsMenuOnOutsideClick);
  }
}

function updateConvActionsMenu() {
  if (!currentVisitor || !users[currentVisitor]) return;
  const user = users[currentVisitor];

  // Update priority chips
  document.querySelectorAll('.priority-chip').forEach(chip => {
    chip.classList.toggle('active', chip.dataset.priority === (user.priority || 'normal'));
  });

  // Update tags
  const tagsList = document.getElementById('convTagsList');
  const tags = user.tags || [];
  tagsList.innerHTML = tags.map(tag => `
    <span class="conv-tag">
      ${escapeHtml(tag)}
      <button class="conv-tag-remove" onclick="removeConversationTag('${escapeHtml(tag)}')">&times;</button>
    </span>
  `).join('');

  // Show/hide reopen button
  const reopenBtn = document.getElementById('btnReopenConv');
  reopenBtn.style.display = user.status === 'closed' ? 'flex' : 'none';
}

async function setConversationPriority(priority) {
  if (!currentVisitor || !users[currentVisitor]) return;
  const user = users[currentVisitor];
  const conversationId = user.conversationId;

  if (!conversationId) {
    showToast('Cannot set priority: No conversation ID', 'error');
    return;
  }

  try {
    const response = await fetch(`${API_BASE}/sites/${siteId}/conversations/${conversationId}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ priority: priority })
    });

    if (response.ok) {
      user.priority = priority;
      updateConvActionsMenu();
      renderUsers();
      showToast(`Priority set to ${priority}`, 'success');
    } else {
      showToast('Failed to update priority', 'error');
    }
  } catch (error) {
    console.error('Error setting priority:', error);
    showToast('Failed to update priority', 'error');
  }
}

async function addConversationTag() {
  const input = document.getElementById('convTagsInput');
  const tag = input.value.trim();
  if (!tag) return;

  if (!currentVisitor || !users[currentVisitor]) return;
  const user = users[currentVisitor];
  const conversationId = user.conversationId;

  if (!conversationId) {
    showToast('Cannot add tag: No conversation ID', 'error');
    return;
  }

  const currentTags = user.tags || [];
  if (currentTags.includes(tag)) {
    showToast('Tag already exists', 'warning');
    input.value = '';
    return;
  }

  const newTags = [...currentTags, tag];

  try {
    const response = await fetch(`${API_BASE}/sites/${siteId}/conversations/${conversationId}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ tags: newTags })
    });

    if (response.ok) {
      user.tags = newTags;
      input.value = '';
      updateConvActionsMenu();
      updateHeaderTags();
      renderUsers();
      showToast('Tag added', 'success');
    } else {
      showToast('Failed to add tag', 'error');
    }
  } catch (error) {
    console.error('Error adding tag:', error);
    showToast('Failed to add tag', 'error');
  }
}

async function removeConversationTag(tag) {
  if (!currentVisitor || !users[currentVisitor]) return;
  const user = users[currentVisitor];
  const conversationId = user.conversationId;

  if (!conversationId) return;

  const newTags = (user.tags || []).filter(t => t !== tag);

  try {
    const response = await fetch(`${API_BASE}/sites/${siteId}/conversations/${conversationId}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ tags: newTags })
    });

    if (response.ok) {
      user.tags = newTags;
      updateConvActionsMenu();
      updateHeaderTags();
      renderUsers();
      showToast('Tag removed', 'success');
    }
  } catch (error) {
    console.error('Error removing tag:', error);
  }
}

function updateHeaderTags() {
  if (!currentVisitor || !users[currentVisitor]) return;
  const tags = users[currentVisitor].tags || [];
  const headerTags = document.getElementById("chatHeaderTags");
  if (tags.length > 0) {
    headerTags.innerHTML = tags.map(tag => `<span class="header-tag">${escapeHtml(tag)}</span>`).join('');
    headerTags.style.display = 'flex';
  } else {
    headerTags.innerHTML = '';
    headerTags.style.display = 'none';
  }
}

async function reopenConversation() {
  if (!currentVisitor || !users[currentVisitor]) return;
  const user = users[currentVisitor];
  const conversationId = user.conversationId;

  if (!conversationId) {
    showToast('Cannot reopen: No conversation ID', 'error');
    return;
  }

  try {
    const response = await fetch(`${API_BASE}/sites/${siteId}/conversations/${conversationId}/reopen`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (response.ok) {
      user.status = 'active';
      user.isClosed = false;
      updateConvActionsMenu();
      renderUsers();

      // Update chat header
      const statusEl = document.getElementById('chatHeaderStatus');
      if (statusEl) {
        statusEl.innerHTML = user.isOnline ? 'Online' : 'Offline';
      }

      // Close the menu
      document.getElementById('convActionsMenu').classList.remove('open');

      showToast('Conversation reopened', 'success');
    } else {
      showToast('Failed to reopen conversation', 'error');
    }
  } catch (error) {
    console.error('Error reopening conversation:', error);
    showToast('Failed to reopen conversation', 'error');
  }
}

function renderMessages() {
  if (!currentVisitor || !users[currentVisitor]) return;

  const msgs = users[currentVisitor].messages;
  messagesContainer.innerHTML = msgs.map(m => {
    let fileHtml = '';
    if (m.file) {
      if (m.file.is_image) {
        fileHtml = `
          <div class="message-file">
            <div class="image-container">
              <img class="message-image" src="${m.file.url}" alt="${escapeHtml(m.file.original_name)}" onclick="openImageModal('${m.file.url}')" />
              <a class="image-download-btn" href="${m.file.url}" download="${escapeHtml(m.file.original_name)}" title="Download" onclick="event.stopPropagation()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
              </a>
            </div>
          </div>
        `;
      } else {
        fileHtml = `
          <div class="message-file">
            <a class="file-attachment" href="${m.file.url}" download="${escapeHtml(m.file.original_name)}">
              <div class="file-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
              </div>
              <div class="file-info">
                <div class="file-name">${escapeHtml(m.file.original_name)}</div>
                <div class="file-size">${formatFileSize(m.file.size)}</div>
              </div>
              <div class="file-download-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
              </div>
            </a>
          </div>
        `;
      }
    }

    const autoReplyBadge = m.isAutoReply ? '<span class="auto-reply-badge">AUTO</span>' : '';
    const hasText = m.text && m.text.trim();
    const hasFile = m.file;

    // Skip empty messages
    if (!hasText && !hasFile) return '';

    // Read receipt checkmarks for support messages
    let readReceipt = '';
    if (m.from === 'support' && platformFeatures.readReceipts) {
      const status = m.readAt ? 'read' : (m.deliveredAt ? 'delivered' : 'sent');
      readReceipt = `<span class="read-receipt ${status}" title="${status.charAt(0).toUpperCase() + status.slice(1)}">
        ${status === 'read' ? `
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 7l-8.5 8.5-4-4M22 7l-8.5 8.5-1-1"/>
          </svg>
        ` : status === 'delivered' ? `
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 7l-8.5 8.5-4-4M22 7l-8.5 8.5-1-1"/>
          </svg>
        ` : `
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 6L9 17l-5-5"/>
          </svg>
        `}
      </span>`;
    }

    return `
      <div class="message-wrapper ${m.from === 'customer' ? 'customer' : 'support'}">
        <div class="message-bubble ${!hasText && hasFile ? 'file-only' : ''}">
          ${hasText ? `<div class="message-text">${escapeHtml(m.text)}</div>` : ''}
          ${fileHtml}
        </div>
        <div class="message-time">${autoReplyBadge}${formatMessageTime(m.time)}${readReceipt}</div>
      </div>
    `;
  }).join('');

  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showTypingIndicator() {
  if (!platformFeatures.typingIndicators) return;
  const container = document.getElementById("typingIndicatorContainer");
  if (!container) return;
  container.classList.add("active");
  container.innerHTML = '<div class="typing-indicator"><div class="typing-dots"><span></span><span></span><span></span></div></div>';
}

function hideTypingIndicator() {
  const container = document.getElementById("typingIndicatorContainer");
  if (!container) return;
  container.classList.remove("active");
  container.innerHTML = '';
}

function renderAnalysis(a) {
  if (!a) {
    analysisContent.innerHTML = '<div class="analysis-empty"><p>No analysis data available</p></div>';
    return;
  }

  console.log("Analysis data received:", a);

  // Handle both Python WebSocket format and .NET API format
  // Python format: interest_level, conversion_percentage, objection, next_action, suggested_reply
  // .NET API format: sentiment, sentimentScore, summary, suggestedResponses[], intent

  // Map sentiment to interest level if needed
  let interestLevel = a.interest_level || a.interestLevel;
  if (!interestLevel && a.sentiment) {
    // Map sentiment to interest level
    const sentimentMap = { 'positive': 'High', 'neutral': 'Medium', 'negative': 'Low' };
    interestLevel = sentimentMap[a.sentiment.toLowerCase()] || 'Medium';
  }
  interestLevel = interestLevel || 'Unknown';
  const interestClass = interestLevel.toLowerCase().replace(/\s+/g, '-');

  // Map sentiment score to conversion percentage if needed
  let conversionPercentage = a.conversion_percentage || a.conversionPercentage;
  if (conversionPercentage === undefined && a.sentimentScore !== undefined) {
    // Convert sentiment score (-1 to 1) to percentage (0-100)
    conversionPercentage = Math.round((a.sentimentScore + 1) * 50);
  }
  conversionPercentage = conversionPercentage || 50;

  // Use summary or intent as objection/context
  const objection = a.objection || a.objectionDetected || (a.intent ? `Intent: ${a.intent}` : 'None detected');

  // Use summary as next action if available
  const nextAction = a.next_action || a.nextAction || a.recommendedAction || a.summary || 'No recommendation';

  // Get suggested reply - handle both string and array formats
  let suggestedReply = a.suggested_reply || a.suggestedReply || '';
  if (!suggestedReply && a.suggestedResponses && a.suggestedResponses.length > 0) {
    suggestedReply = a.suggestedResponses[0];
  }

  analysisContent.innerHTML = `
    <div class="analysis-card">
      <div class="analysis-card-header">Interest Level</div>
      <div class="interest-badge ${interestClass}">${escapeHtml(interestLevel)}</div>
    </div>

    <div class="analysis-card">
      <div class="analysis-card-header">Conversion Probability</div>
      <div class="conversion-value">${conversionPercentage}%</div>
      <div class="conversion-bar">
        <div class="conversion-fill" style="width: ${conversionPercentage}%"></div>
      </div>
    </div>

    <div class="analysis-card">
      <div class="analysis-card-header">Objection Detected</div>
      <div class="analysis-card-value">${escapeHtml(objection)}</div>
    </div>

    <div class="analysis-card">
      <div class="analysis-card-header">Recommended Action</div>
      <div class="analysis-card-value">${escapeHtml(nextAction)}</div>
    </div>

    <div class="suggested-reply">
      <div class="suggested-reply-header">
        <span>Suggested Reply</span>
        <button class="btn-use-reply" onclick="useReply()">Use This</button>
      </div>
      <div class="suggested-reply-text">${escapeHtml(suggestedReply) || 'No suggestion available'}</div>
    </div>
  `;
}

// ==================== SEND MESSAGE ====================
async function send() {
  if (!currentVisitor) return;

  const text = messageInput.value.trim();
  if (!text && !pendingFile) return;

  // If there's a file, upload it first
  if (pendingFile) {
    const formData = new FormData();
    formData.append("file", pendingFile);
    formData.append("siteId", siteId);
    formData.append("token", token);

    try {
      const response = await fetch("/upload", {
        method: "POST",
        body: formData
      });

      if (!response.ok) {
        const error = await response.json();
        alert(error.detail || "Failed to upload file");
        return;
      }

      const fileData = await response.json();

      // Add message locally
      users[currentVisitor].messages.push({
        from: "support",
        text: text,
        file: fileData,
        time: new Date(),
        deliveredAt: null,
        readAt: null
      });

      renderMessages();

      // Send via WebSocket
      ws.send(JSON.stringify({
        to: currentVisitor,
        message: text,
        file: fileData
      }));
    } catch (error) {
      alert("Failed to upload file");
      return;
    }

    // Clear pending file
    clearPendingFile();
  } else {
    // Text only message
    users[currentVisitor].messages.push({
      from: "support",
      text: text,
      time: new Date(),
      deliveredAt: null,
      readAt: null
    });

    renderMessages();

    ws.send(JSON.stringify({
      to: currentVisitor,
      message: text
    }));
  }

  // Stop typing indicator
  ws.send(JSON.stringify({
    type: "support_typing_stop",
    to: currentVisitor
  }));

  messageInput.value = "";
  messageInput.style.height = "auto";
}

function useReply() {
  if (!currentVisitor || !users[currentVisitor].analysis) return;
  const a = users[currentVisitor].analysis;
  let suggestedReply = a.suggested_reply || a.suggestedReply || '';
  // Handle array format from .NET API
  if (!suggestedReply && a.suggestedResponses && a.suggestedResponses.length > 0) {
    suggestedReply = a.suggestedResponses[0];
  }
  if (suggestedReply) {
    messageInput.value = suggestedReply;
    messageInput.focus();
  }
}

// ==================== TYPING INDICATOR ====================
let typingTimeout = null;
let isTyping = false;

messageInput.addEventListener("input", () => {
  // Auto-resize textarea
  messageInput.style.height = "auto";
  messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + "px";

  // Send typing indicator
  if (!currentVisitor || !platformFeatures.typingIndicators) return;

  if (!isTyping) {
    isTyping = true;
    ws.send(JSON.stringify({
      type: "support_typing",
      to: currentVisitor
    }));
  }

  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => {
    isTyping = false;
    ws.send(JSON.stringify({
      type: "support_typing_stop",
      to: currentVisitor
    }));
  }, 2000);
});

messageInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});

// ==================== EMOJI PICKER ====================
const EMOJI_DATA = {
  "Smileys": ["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""],
  "Gestures": ["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""],
  "Hearts": ["","","","","","","","","","","","","","","","","","","",""],
  "Objects": ["","","","","","","","","","","","","","","","","","","","","","","","","","","","",""],
  "Symbols": ["","","","","","","","","","","","","","","","","","","","","","","","","","","","",""]
};

let currentEmojiCategory = "Smileys";

function getRecentEmojis() {
  try {
    return JSON.parse(localStorage.getItem('recentEmojis') || '[]');
  } catch { return []; }
}

function addRecentEmoji(emoji) {
  let recents = getRecentEmojis();
  recents = recents.filter(e => e !== emoji);
  recents.unshift(emoji);
  if (recents.length > 20) recents = recents.slice(0, 20);
  localStorage.setItem('recentEmojis', JSON.stringify(recents));
}

function initEmojiPicker() {
  const categoriesDiv = document.getElementById("emojiCategories");
  const recents = getRecentEmojis();
  const categoryIcons = {
    "Recent": "",
    "Smileys": "",
    "Gestures": "",
    "Hearts": "",
    "Objects": "",
    "Symbols": ""
  };

  const categories = recents.length > 0 ? ["Recent", ...Object.keys(EMOJI_DATA)] : Object.keys(EMOJI_DATA);

  // Default to Recent if available
  if (recents.length > 0 && currentEmojiCategory === "Smileys") {
    currentEmojiCategory = "Recent";
  }

  categoriesDiv.innerHTML = categories.map(cat => `
    <button class="emoji-category-btn ${cat === currentEmojiCategory ? 'active' : ''}"
            onclick="selectEmojiCategory('${cat}')" title="${cat}">
      ${categoryIcons[cat] || ''}
    </button>
  `).join('');

  renderEmojis();
}

function selectEmojiCategory(cat) {
  currentEmojiCategory = cat;
  document.querySelectorAll(".emoji-category-btn").forEach(btn => btn.classList.remove("active"));
  event.target.classList.add("active");
  renderEmojis();
}

function renderEmojis(filter = "") {
  const grid = document.getElementById("emojiGrid");
  let emojis;

  if (filter) {
    emojis = Object.values(EMOJI_DATA).flat().filter(e => e.includes(filter));
  } else if (currentEmojiCategory === "Recent") {
    emojis = getRecentEmojis();
  } else {
    emojis = EMOJI_DATA[currentEmojiCategory];
  }

  grid.innerHTML = (emojis || []).map(e => `
    <span class="emoji-item" onclick="insertEmoji('${e}')">${e}</span>
  `).join('');
}

function insertEmoji(emoji) {
  const input = messageInput;
  const start = input.selectionStart;
  const end = input.selectionEnd;
  const text = input.value;

  input.value = text.substring(0, start) + emoji + text.substring(end);
  input.selectionStart = input.selectionEnd = start + emoji.length;
  input.focus();

  addRecentEmoji(emoji);
  emojiPicker.classList.remove("show");
}

document.getElementById("btnEmoji").addEventListener("click", () => {
  emojiPicker.classList.toggle("show");
  if (emojiPicker.classList.contains("show")) {
    initEmojiPicker();
  }
});

document.getElementById("emojiSearch").addEventListener("input", (e) => {
  renderEmojis(e.target.value);
});

// Close emoji picker when clicking outside
document.addEventListener("click", (e) => {
  if (!emojiPicker.contains(e.target) && e.target.id !== "btnEmoji" && !e.target.closest("#btnEmoji")) {
    emojiPicker.classList.remove("show");
  }
});

document.getElementById("btnSend").addEventListener("click", send);

// ==================== FILE HANDLING ====================
const fileInput = document.getElementById("fileInput");
const filePreviewArea = document.getElementById("filePreviewArea");

document.getElementById("btnAttach").addEventListener("click", () => {
  fileInput.click();
});

fileInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  // Check file type
  const allowedTypes = ['image/jpeg','image/png','image/gif','image/webp','image/svg+xml',
    'application/pdf','application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    'text/plain','application/zip'];
  const allowedExts = ['.jpg','.jpeg','.png','.gif','.webp','.svg','.pdf','.doc','.docx','.txt','.zip'];
  const ext = '.' + file.name.split('.').pop().toLowerCase();
  if (!allowedTypes.includes(file.type) && !allowedExts.includes(ext)) {
    showToast(`Unsupported file type. Accepted: images, PDF, DOC, TXT, ZIP`, 'error');
    fileInput.value = "";
    return;
  }

  // Check file size (10MB limit)
  if (file.size > 10 * 1024 * 1024) {
    showToast("File is too large. Maximum size is 10MB.", "error");
    fileInput.value = "";
    return;
  }

  pendingFile = file;
  showFilePreview(file);
});

function showFilePreview(file) {
  const isImage = file.type.startsWith("image/");

  let previewHtml = `
    <div class="file-preview">
      ${isImage ? `<img src="${URL.createObjectURL(file)}" alt="Preview" />` : `
        <div class="file-preview-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg>
        </div>
      `}
      <div class="file-preview-info">
        <div class="file-preview-name">${escapeHtml(file.name)}</div>
        <div class="file-preview-size">${formatFileSize(file.size)}</div>
      </div>
      <button class="file-preview-remove" onclick="clearPendingFile()" title="Remove">&times;</button>
    </div>
  `;

  filePreviewArea.innerHTML = previewHtml;
}

function clearPendingFile() {
  pendingFile = null;
  fileInput.value = "";
  filePreviewArea.innerHTML = "";
}

function openImageModal(url) {
  const modal = document.getElementById("imageModal");
  const img = document.getElementById("modalImage");
  img.src = url;
  modal.classList.add("show");
}

function closeImageModal() {
  document.getElementById("imageModal").classList.remove("show");
}

// Close modal on background click
document.getElementById("imageModal").addEventListener("click", (e) => {
  if (e.target.id === "imageModal") {
    closeImageModal();
  }
});

function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + " B";
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
  return (bytes / (1024 * 1024)).toFixed(1) + " MB";
}

// ==================== UTILITIES ====================
function getInitials(name) {
  return name.split(" ").map(n => n[0]).join("").toUpperCase().substring(0, 2);
}

function truncate(str, len) {
  return str.length > len ? str.substring(0, len) + "..." : str;
}

function escapeHtml(text) {
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

function formatTime(date) {
  const now = new Date();
  const diff = now - date;

  if (diff < 60000) return "now";
  if (diff < 3600000) return Math.floor(diff / 60000) + "m";
  if (diff < 86400000) return Math.floor(diff / 3600000) + "h";
  return date.toLocaleDateString();
}

function formatMessageTime(date) {
  const now = new Date();
  const isToday = date.toDateString() === now.toDateString();
  const yesterday = new Date(now);
  yesterday.setDate(yesterday.getDate() - 1);
  const isYesterday = date.toDateString() === yesterday.toDateString();

  const time = date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });

  if (isToday) return time;
  if (isYesterday) return `Yesterday ${time}`;
  return date.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ` ${time}`;
}

function logout() {
  loggedOut = true;
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.close();
  }
  location.href = "/login";
}

window.addEventListener("beforeunload", () => {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.close();
  }
});

// ==================== TOPBAR FUNCTIONS ====================
function updateCurrentUser(username, email = null) {
  currentUsername = username;
  const initials = username.substring(0, 2).toUpperCase();
  const displayName = username.charAt(0).toUpperCase() + username.slice(1);

  document.getElementById("currentUserAvatar").textContent = initials;
  document.getElementById("currentUserName").textContent = displayName;
  document.getElementById("dropdownAvatar").textContent = initials;
  document.getElementById("dropdownName").textContent = displayName;
  document.getElementById("dropdownEmail").textContent = email || `${username}@support.com`;
}

let dropdownOpen = false;

function toggleUserMenu(event) {
  if (event) event.stopPropagation();

  const dropdown = document.getElementById("userDropdown");
  const chevron = document.getElementById("dropdownChevron");

  dropdownOpen = !dropdownOpen;

  if (dropdownOpen) {
    dropdown.classList.add("show");
    chevron.style.transform = "rotate(180deg)";
  } else {
    dropdown.classList.remove("show");
    chevron.style.transform = "rotate(0deg)";
  }
}

function closeUserMenu() {
  const dropdown = document.getElementById("userDropdown");
  const chevron = document.getElementById("dropdownChevron");

  dropdownOpen = false;
  dropdown.classList.remove("show");
  chevron.style.transform = "rotate(0deg)";
}

// Close dropdown when clicking outside
document.addEventListener("click", (e) => {
  const wrapper = document.querySelector(".topbar-user-wrapper");
  if (wrapper && !wrapper.contains(e.target)) {
    closeUserMenu();
  }
});

function openProfile() {
  closeUserMenu();
  loadProfilePanel();
  document.getElementById('profileSlideOverlay').classList.add('open');
}

function closeProfile() {
  document.getElementById('profileSlideOverlay').classList.remove('open');
}

async function loadProfilePanel() {
  try {
    const response = await fetch(`${API_BASE}/auth/me`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!response.ok) throw new Error('Failed to load profile');
    const result = await response.json();
    if (result.success) {
      const u = result.data;
      document.getElementById('profileFirstName').value = u.firstName || '';
      document.getElementById('profileLastName').value = u.lastName || '';
      document.getElementById('profileUsername').value = u.username || '';
      document.getElementById('profileEmailField').value = u.email || '';
      document.getElementById('profileAvatarUrl').value = u.avatarUrl || '';
      const fullName = `${u.firstName || ''} ${u.lastName || ''}`.trim() || u.username;
      document.getElementById('profilePanelName').textContent = fullName;
      document.getElementById('profilePanelEmail').textContent = u.email;
      const roleMap = { support_agent: 'Support Agent', admin: 'Administrator', site_admin: 'Site Admin', owner: 'Owner' };
      document.getElementById('profilePanelRole').textContent = roleMap[u.role] || u.role;
      const avatarEl = document.getElementById('profilePanelAvatar');
      if (u.avatarUrl) {
        avatarEl.innerHTML = `<img src="${u.avatarUrl}" alt="Avatar">`;
      } else {
        const initials = u.firstName && u.lastName ? `${u.firstName[0]}${u.lastName[0]}`.toUpperCase() : (u.username || '??').substring(0, 2).toUpperCase();
        avatarEl.innerHTML = `<span>${initials}</span>`;
      }
    }
  } catch (e) {
    console.error('Failed to load profile:', e);
    showToast('Failed to load profile', 'error');
  }
}

async function saveProfilePanel(e) {
  e.preventDefault();
  const btn = document.getElementById('profileSaveBtn');
  const orig = btn.textContent;
  btn.textContent = 'Saving...';
  btn.disabled = true;
  try {
    const response = await fetch(`${API_BASE}/auth/me`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({
        firstName: document.getElementById('profileFirstName').value.trim() || null,
        lastName: document.getElementById('profileLastName').value.trim() || null,
        avatarUrl: document.getElementById('profileAvatarUrl').value.trim() || null
      })
    });
    if (!response.ok) throw new Error('Failed to update profile');
    const result = await response.json();
    if (result.success) {
      showToast('Profile updated successfully!', 'success');
      loadProfilePanel();
    }
  } catch (e) {
    showToast('Failed to update profile', 'error');
  } finally {
    btn.textContent = orig;
    btn.disabled = false;
  }
}

async function changeProfilePassword(e) {
  e.preventDefault();
  const curr = document.getElementById('profileCurrentPassword').value;
  const newPw = document.getElementById('profileNewPassword').value;
  const confirm = document.getElementById('profileConfirmPassword').value;
  if (!curr || !newPw || !confirm) { showToast('Please fill in all password fields', 'error'); return; }
  if (newPw !== confirm) { showToast('New passwords do not match', 'error'); return; }
  if (newPw.length < 6) { showToast('Password must be at least 6 characters', 'error'); return; }
  const btn = document.getElementById('profilePasswordBtn');
  const orig = btn.textContent;
  btn.textContent = 'Updating...';
  btn.disabled = true;
  try {
    const response = await fetch(`${API_BASE}/auth/change-password`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({ currentPassword: curr, newPassword: newPw })
    });
    const result = await response.json();
    if (!response.ok) throw new Error(result.message || 'Failed to change password');
    showToast('Password changed successfully!', 'success');
    document.getElementById('profileCurrentPassword').value = '';
    document.getElementById('profileNewPassword').value = '';
    document.getElementById('profileConfirmPassword').value = '';
  } catch (e) {
    showToast(e.message || 'Failed to change password', 'error');
  } finally {
    btn.textContent = orig;
    btn.disabled = false;
  }
}

// ==================== SETTINGS & THEMES ====================
const themes = [
  {
    id: 'auto',
    name: 'Auto (System)',
    colors: { bg: '#e2e8f0', sidebar: '#f1f5f9', accent: '#6366f1', text: '#475569' }
  },
  {
    id: 'light',
    name: 'Light',
    colors: { bg: '#f1f5f9', sidebar: '#ffffff', accent: '#2563eb', text: '#1e293b' }
  },
  {
    id: 'dark',
    name: 'Dark',
    colors: { bg: '#0f172a', sidebar: '#1e293b', accent: '#6366f1', text: '#e2e8f0' }
  },
  {
    id: 'ocean',
    name: 'Ocean Blue',
    colors: { bg: '#0c1929', sidebar: '#132f4c', accent: '#2196f3', text: '#e3f2fd' }
  },
  {
    id: 'forest',
    name: 'Forest Green',
    colors: { bg: '#0d1f12', sidebar: '#1a3a21', accent: '#4caf50', text: '#e8f5e9' }
  },
  {
    id: 'sunset',
    name: 'Sunset',
    colors: { bg: '#1a1a2e', sidebar: '#2d2d44', accent: '#ff6b6b', text: '#fce4ec' }
  },
  {
    id: 'midnight',
    name: 'Midnight Purple',
    colors: { bg: '#13111c', sidebar: '#1e1a2e', accent: '#a855f7', text: '#e9d5ff' }
  },
  {
    id: 'rose',
    name: 'Rose Gold',
    colors: { bg: '#1c1618', sidebar: '#2d2226', accent: '#f472b6', text: '#fce7f3' }
  },
  {
    id: 'cyber',
    name: 'Cyberpunk',
    colors: { bg: '#0a0a0f', sidebar: '#12121a', accent: '#00ff88', text: '#00ff88' }
  },
  {
    id: 'coffee',
    name: 'Coffee',
    colors: { bg: '#1a1614', sidebar: '#2d2520', accent: '#d97706', text: '#fef3c7' }
  },
  {
    id: 'nord',
    name: 'Nord',
    colors: { bg: '#2e3440', sidebar: '#3b4252', accent: '#88c0d0', text: '#eceff4' }
  },
  {
    id: 'dracula',
    name: 'Dracula',
    colors: { bg: '#282a36', sidebar: '#343746', accent: '#bd93f9', text: '#f8f8f2' }
  },
  {
    id: 'solarized',
    name: 'Solarized',
    colors: { bg: '#002b36', sidebar: '#073642', accent: '#2aa198', text: '#93a1a1' }
  },
  {
    id: 'monokai',
    name: 'Monokai',
    colors: { bg: '#272822', sidebar: '#3e3d32', accent: '#f92672', text: '#f8f8f2' }
  }
];

function getCurrentTheme() {
  return localStorage.getItem('supportDashboardTheme') || 'light';
}

function setTheme(themeId) {
  const theme = themes.find(t => t.id === themeId);
  if (!theme) return;

  if (themeId === 'auto') {
    document.documentElement.removeAttribute('data-theme');
  } else if (themeId === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
  } else {
    document.documentElement.setAttribute('data-theme', themeId);
  }

  localStorage.setItem('supportDashboardTheme', themeId);

  // Update active state in theme cards
  document.querySelectorAll('.theme-card').forEach(card => {
    card.classList.toggle('active', card.dataset.theme === themeId);
  });

  showToast(`Theme changed to ${theme.name}`, 'success');
}

function renderThemeSettings() {
  const currentTheme = getCurrentTheme();

  const html = `
    <div class="settings-section">
      <h3>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
        </svg>
        Theme
      </h3>
      <div class="theme-grid">
        ${themes.map(theme => `
          <div class="theme-card ${currentTheme === theme.id ? 'active' : ''}" data-theme="${theme.id}" onclick="setTheme('${theme.id}')">
            <div class="theme-preview" style="background: ${theme.colors.bg};">
              <div class="preview-sidebar" style="background: ${theme.colors.sidebar};">
                <div class="preview-bar" style="background: ${theme.colors.accent};"></div>
                <div class="preview-bar" style="background: ${theme.colors.text};"></div>
                <div class="preview-bar" style="background: ${theme.colors.text};"></div>
              </div>
              <div class="preview-main">
                <div class="preview-content" style="background: ${theme.colors.text};"></div>
              </div>
            </div>
            <div class="theme-card-name">
              ${theme.name}
              <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </div>
          </div>
        `).join('')}
      </div>
    </div>

    <div class="settings-section">
      <h3>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        About
      </h3>
      <div style="color: var(--text-secondary); font-size: 14px; line-height: 1.6;">
        <p><strong>Support Dashboard</strong></p>
        <p style="margin-top: 8px;">Version 1.0.0</p>
        <p style="margin-top: 4px;">Manage customer conversations with ease.</p>
      </div>
    </div>
  `;

  document.getElementById('settingsModalBody').innerHTML = html;
}

function openSettings() {
  closeUserMenu();
  renderThemeSettings();
  document.getElementById('settingsModal').style.display = 'flex';
}

function openReportIssue() {
  const params = new URLSearchParams(location.search);
  const rSiteId = params.get('siteId') || '';
  const rToken = params.get('token') || '';
  const rName = document.getElementById('currentUserName')?.textContent || '';
  const rEmail = document.getElementById('dropdownEmail')?.textContent || '';
  const qp = new URLSearchParams();
  if (rToken) qp.set('token', rToken);
  if (rSiteId) qp.set('siteId', rSiteId);
  if (rName && rName !== 'Agent') qp.set('name', rName);
  if (rEmail && rEmail !== 'agent@example.com') qp.set('email', rEmail);
  window.open('/report-issue.html?' + qp.toString(), '_blank');
}

function closeSettingsModal() {
  document.getElementById('settingsModal').style.display = 'none';
}

// Initialize theme on page load
(function initTheme() {
  const savedTheme = getCurrentTheme();
  if (savedTheme === 'auto') {
    document.documentElement.removeAttribute('data-theme');
  } else if (savedTheme && savedTheme !== 'light') {
    document.documentElement.setAttribute('data-theme', savedTheme);
  } else if (savedTheme === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
  }
})();

// ==================== BULK SELECT FUNCTIONS ====================
function toggleBulkSelectMode() {
  bulkSelectMode = !bulkSelectMode;
  selectedConversations.clear();

  const bulkActionsBar = document.getElementById('bulkActionsBar');
  const btnBulkSelect = document.getElementById('btnBulkSelect');

  if (bulkSelectMode) {
    bulkActionsBar.style.display = 'flex';
    btnBulkSelect.classList.add('active');
  } else {
    bulkActionsBar.style.display = 'none';
    btnBulkSelect.classList.remove('active');
  }

  updateBulkSelectedCount();
  renderUsers();
}

function toggleConversationSelection(vid) {
  if (selectedConversations.has(vid)) {
    selectedConversations.delete(vid);
  } else {
    selectedConversations.add(vid);
  }
  updateBulkSelectedCount();
  renderUsers();
}

function toggleSelectAll(checked) {
  selectedConversations.clear();
  if (checked) {
    Object.keys(users).forEach(vid => selectedConversations.add(vid));
  }
  updateBulkSelectedCount();
  renderUsers();
}

function updateBulkSelectedCount() {
  const count = selectedConversations.size;
  document.getElementById('bulkSelectedCount').textContent = `${count} selected`;
  document.getElementById('selectAllCheckbox').checked = count > 0 && count === Object.keys(users).length;
}

function cancelBulkSelect() {
  bulkSelectMode = false;
  selectedConversations.clear();
  document.getElementById('bulkActionsBar').style.display = 'none';
  document.getElementById('btnBulkSelect').classList.remove('active');
  renderUsers();
}

async function bulkCloseConversations() {
  if (selectedConversations.size === 0) {
    showToast('No conversations selected', 'error');
    return;
  }

  const result = await Swal.fire({
    title: 'Close Conversations?',
    text: `Close ${selectedConversations.size} selected conversation(s)?`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#22c55e',
    cancelButtonColor: '#64748b',
    confirmButtonText: 'Yes, close them',
    cancelButtonText: 'Cancel'
  });

  if (!result.isConfirmed) return;

  let closed = 0;
  for (const vid of selectedConversations) {
    try {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'close_conversation',
          conversationId: users[vid]?.conversationId,
          visitorId: vid,
          sendCsat: false,
          note: 'Bulk closed',
          status: 'resolved'
        }));

        if (users[vid]) {
          users[vid].isClosed = true;
          users[vid].closedAt = new Date();
          users[vid].closedStatus = 'resolved';
        }
        closed++;
      }
    } catch (err) {
      console.error('Failed to close conversation:', vid, err);
    }
  }

  showToast(`Closed ${closed} conversation(s)`, 'success');
  cancelBulkSelect();
}

async function bulkDeleteConversations() {
  if (selectedConversations.size === 0) {
    showToast('No conversations selected', 'error');
    return;
  }

  const result = await Swal.fire({
    title: 'Delete Conversations?',
    text: `Permanently delete ${selectedConversations.size} conversation(s)? This cannot be undone.`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#ef4444',
    cancelButtonColor: '#64748b',
    confirmButtonText: 'Yes, delete them',
    cancelButtonText: 'Cancel'
  });

  if (!result.isConfirmed) return;

  let deleted = 0;
  for (const vid of selectedConversations) {
    try {
      const user = users[vid];
      if (user && user.conversationId) {
        const response = await fetch(`${API_BASE}/sites/${siteId}/conversations/${user.conversationId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          delete users[vid];
          deleted++;
        }
      }
    } catch (err) {
      console.error('Failed to delete conversation:', vid, err);
    }
  }

  if (selectedConversations.has(currentVisitor)) {
    currentVisitor = null;
    showNoChat();
  }

  showToast(`Deleted ${deleted} conversation(s)`, 'success');
  cancelBulkSelect();
}

// ==================== MESSAGE SEARCH FUNCTIONS ====================
function toggleMessageSearch() {
  const searchBar = document.getElementById('messageSearchBar');
  const isVisible = searchBar.style.display !== 'none';

  if (isVisible) {
    closeMessageSearch();
  } else {
    searchBar.style.display = 'flex';
    document.getElementById('messageSearchInput').focus();
  }
}

function closeMessageSearch() {
  document.getElementById('messageSearchBar').style.display = 'none';
  document.getElementById('messageSearchInput').value = '';
  document.getElementById('searchResultsCount').textContent = '';
  clearSearchHighlights();
  messageSearchResults = [];
  currentSearchIndex = -1;
  // Clean up search empty state
  const noResults = messagesContainer.querySelector('.search-no-results');
  if (noResults) noResults.remove();
}

function searchMessages(query) {
  clearSearchHighlights();
  messageSearchResults = [];
  currentSearchIndex = -1;

  if (!query || query.length < 2 || !currentVisitor || !users[currentVisitor]) {
    document.getElementById('searchResultsCount').textContent = '';
    return;
  }

  const user = users[currentVisitor];
  const lowerQuery = query.toLowerCase();

  // Find all matching messages
  user.messages.forEach((msg, index) => {
    if (msg.text && msg.text.toLowerCase().includes(lowerQuery)) {
      messageSearchResults.push(index);
    }
  });

  const count = messageSearchResults.length;
  document.getElementById('searchResultsCount').textContent = count > 0 ? `${count} found` : 'No results';

  // Remove any previous search-no-results element
  const existingNoResults = messagesContainer.querySelector('.search-no-results');
  if (existingNoResults) existingNoResults.remove();

  if (count > 0) {
    currentSearchIndex = 0;
    highlightSearchResult();
  } else if (query.length >= 2) {
    const noResultsDiv = document.createElement('div');
    noResultsDiv.className = 'search-no-results';
    noResultsDiv.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
      <h4>No results found</h4>
      <ul>
        <li>Try different keywords</li>
        <li>Check your spelling</li>
        <li>Search is limited to this conversation</li>
      </ul>
    `;
    messagesContainer.appendChild(noResultsDiv);
  }
}

function navigateSearchResult(direction) {
  if (messageSearchResults.length === 0) return;

  currentSearchIndex += direction;

  if (currentSearchIndex < 0) {
    currentSearchIndex = messageSearchResults.length - 1;
  } else if (currentSearchIndex >= messageSearchResults.length) {
    currentSearchIndex = 0;
  }

  highlightSearchResult();
}

function highlightSearchResult() {
  clearSearchHighlights();

  if (currentSearchIndex < 0 || currentSearchIndex >= messageSearchResults.length) return;

  const messageIndex = messageSearchResults[currentSearchIndex];
  const messageElements = messagesContainer.querySelectorAll('.message-wrapper');

  if (messageElements[messageIndex]) {
    const element = messageElements[messageIndex];
    element.classList.add('search-highlight');
    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  // Update counter
  document.getElementById('searchResultsCount').textContent =
    `${currentSearchIndex + 1}/${messageSearchResults.length}`;
}

function clearSearchHighlights() {
  messagesContainer.querySelectorAll('.search-highlight').forEach(el => {
    el.classList.remove('search-highlight');
  });
}

// ==================== QUICK REPLIES FUNCTIONS ====================
const DEFAULT_QUICK_REPLIES = [
  "Hello! How can I help you today?",
  "Thank you for contacting us. Let me look into this for you.",
  "I understand your concern. Let me help you resolve this.",
  "Could you please provide more details about the issue?",
  "Is there anything else I can help you with?",
  "Thank you for your patience. I am working on this now.",
  "Have a great day! Feel free to reach out if you need anything else."
];

function getQuickReplies() {
  try {
    const stored = localStorage.getItem('customQuickReplies');
    if (stored) return JSON.parse(stored);
  } catch {}
  return DEFAULT_QUICK_REPLIES;
}

function saveQuickReplies(replies) {
  localStorage.setItem('customQuickReplies', JSON.stringify(replies));
}

function renderQuickReplies() {
  const list = document.getElementById('quickRepliesList');
  const replies = getQuickReplies();

  let html = replies.map((text, idx) => `
    <button class="quick-reply-item" onclick="useQuickReply(this.querySelector('.quick-reply-text').textContent)">
      <span class="quick-reply-text">${escapeHtml(text)}</span>
      <span class="quick-reply-delete" onclick="event.stopPropagation(); deleteQuickReply(${idx})" title="Remove">&times;</span>
    </button>
  `).join('');

  html += `
    <div class="quick-reply-add-wrapper">
      <input type="text" class="quick-reply-add-input" id="quickReplyAddInput" placeholder="Add a custom quick reply..." onkeydown="if(event.key==='Enter'){addQuickReply(); event.preventDefault();}" />
      <button class="quick-reply-add-btn" onclick="addQuickReply()">Add</button>
    </div>
  `;

  list.innerHTML = html;
}

function addQuickReply() {
  const input = document.getElementById('quickReplyAddInput');
  if (!input) return;
  const text = input.value.trim();
  if (!text) return;

  const replies = getQuickReplies();
  replies.push(text);
  saveQuickReplies(replies);
  renderQuickReplies();
  showToast('Quick reply added', 'success');
}

function deleteQuickReply(index) {
  const replies = getQuickReplies();
  replies.splice(index, 1);
  saveQuickReplies(replies);
  renderQuickReplies();
  showToast('Quick reply removed', 'info');
}

function toggleQuickReplies() {
  const panel = document.getElementById('quickRepliesPanel');
  const isVisible = panel.style.display !== 'none';
  panel.style.display = isVisible ? 'none' : 'block';
  if (!isVisible) renderQuickReplies();
}

function useQuickReply(text) {
  const messageInput = document.getElementById('messageInput');
  if (messageInput) {
    messageInput.value = text;
    messageInput.focus();
    // Auto-resize the textarea
    messageInput.style.height = 'auto';
    messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
  }
  toggleQuickReplies();
}

// Toast notification helper
function showToast(message, type = "info") {
  // Remove existing toast
  const existingToast = document.querySelector(".toast-notification");
  if (existingToast) existingToast.remove();

  const toast = document.createElement("div");
  toast.className = "toast-notification";
  toast.style.cssText = `
    position: fixed;
    top: 80px;
    right: 24px;
    padding: 14px 20px;
    background: ${type === "info" ? "#1e293b" : type === "success" ? "#16a34a" : "#dc2626"};
    color: white;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    z-index: 10000;
    animation: slideIn 0.3s ease;
  `;
  toast.textContent = message;

  // Add animation keyframes if not exists
  if (!document.getElementById("toast-styles")) {
    const style = document.createElement("style");
    style.id = "toast-styles";
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
    `;
    document.head.appendChild(style);
  }

  document.body.appendChild(toast);

  setTimeout(() => {
    toast.style.animation = "slideIn 0.3s ease reverse";
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Search functionality
document.getElementById("searchInput").addEventListener("input", (e) => {
  const query = e.target.value.toLowerCase();
  const items = document.querySelectorAll(".user-item");

  items.forEach(item => {
    const name = item.querySelector(".user-name").textContent.toLowerCase();
    const preview = item.querySelector(".user-preview").textContent.toLowerCase();

    if (name.includes(query) || preview.includes(query)) {
      item.style.display = "flex";
    } else {
      item.style.display = "none";
    }
  });
});

// Get username and email from URL params
const usernameFromUrl = params.get("user") || "Agent";
const emailFromUrl = params.get("email") || null;
updateCurrentUser(usernameFromUrl, emailFromUrl);

// ==================== AI ANALYSIS ====================
async function analyzeConversation(conversationId, visitorId) {
  if (!conversationId || !analysisEnabled) return;

  try {
    // Show loading state
    if (currentVisitor === visitorId) {
      analysisContent.innerHTML = '<div class="analysis-empty"><p>Analyzing conversation...</p></div>';
    }

    const response = await fetch(`${API_BASE}/ai/conversations/${conversationId}/analyze`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      throw new Error('Analysis failed');
    }

    const result = await response.json();
    if (result.success && result.data) {
      const analysis = result.data;

      // Store analysis for this visitor
      if (users[visitorId]) {
        users[visitorId].analysis = analysis;
      }

      // Render if this is the current conversation
      if (currentVisitor === visitorId && analysisEnabled) {
        renderAnalysis(analysis);
      }

      console.log("Analysis completed for:", conversationId);
    }
  } catch (error) {
    console.error("Analysis error:", error);
    if (currentVisitor === visitorId) {
      analysisContent.innerHTML = '<div class="analysis-empty"><p>Analysis failed. Try again later.</p></div>';
    }
  }
}

// Analyze message (single message analysis for quick insights)
async function analyzeMessage(message) {
  if (!analysisEnabled) return null;

  try {
    const response = await fetch(`${API_BASE}/ai/analyze-message`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ message: message })
    });

    if (response.ok) {
      const result = await response.json();
      return result.success ? result.data : null;
    }
  } catch (error) {
    console.error("Message analysis error:", error);
  }
  return null;
}

// ==================== TOGGLE HANDLERS ====================
function onAnalysisToggle(enabled) {
  analysisEnabled = enabled;
  console.log("AI Analysis:", enabled ? "ON" : "OFF");

  // Send toggle state to backend
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({
      type: "toggle_analysis",
      enabled: enabled
    }));
  }

  // Update analysis panel display
  if (currentVisitor && users[currentVisitor]) {
    if (enabled && users[currentVisitor].analysis) {
      renderAnalysis(users[currentVisitor].analysis);
    } else if (enabled) {
      // Wait for next customer message - Python server will send analysis via WebSocket
      analysisContent.innerHTML = '<div class="analysis-empty"><p>Waiting for customer message to analyze...</p></div>';
    } else {
      analysisContent.innerHTML = '<div class="analysis-empty"><p>Enable AI Analysis to see insights</p></div>';
    }
  }
}

function onAutoReplyToggle(enabled) {
  autoReplyEnabled = enabled;
  console.log("Auto Reply:", enabled ? "ON" : "OFF");

  // Send toggle state to backend
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({
      type: "toggle_auto_reply",
      enabled: enabled
    }));
  }
}

// Make functions global for onclick handlers
window.selectUser = selectUser;
window.selectEmojiCategory = selectEmojiCategory;
window.insertEmoji = insertEmoji;
window.useReply = useReply;
window.toggleUserMenu = toggleUserMenu;
window.openSettings = openSettings;
window.closeSettingsModal = closeSettingsModal;
window.setTheme = setTheme;
window.openProfile = openProfile;
window.closeProfile = closeProfile;
window.saveProfilePanel = saveProfilePanel;
window.changeProfilePassword = changeProfilePassword;
window.logout = logout;
window.clearPendingFile = clearPendingFile;
window.openImageModal = openImageModal;
window.closeImageModal = closeImageModal;
window.onAnalysisToggle = onAnalysisToggle;
window.onAutoReplyToggle = onAutoReplyToggle;
window.analyzeConversation = analyzeConversation;
window.toggleQuickReplies = toggleQuickReplies;
window.useQuickReply = useQuickReply;

// ==================== SUBSCRIPTION PLAN & AI FEATURES ====================

async function loadSubscriptionPlan() {
  try {
    const response = await fetch(`${API_BASE}/subscriptions/sites/${siteId}/overview`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!response.ok) {
      console.warn('Failed to load subscription plan');
      return;
    }

    const result = await response.json();
    if (result.success && result.data) {
      sitePlan = result.data.plan;
      siteUsage = result.data.usage || [];

      // Check AI features availability
      updateAiFeatureAvailability();
    }
  } catch (error) {
    console.error('Error loading subscription plan:', error);
  }
}

function updateAiFeatureAvailability() {
  if (!sitePlan) {
    // No plan loaded - disable all AI features
    aiAnalysisAvailable = false;
    aiAutoReplyAvailable = false;
    aiAnalysisLimitExhausted = false;
    aiAutoReplyLimitExhausted = false;
  } else {
    // Check if features are enabled in plan
    aiAnalysisAvailable = sitePlan.aiAnalysisEnabled === true;
    aiAutoReplyAvailable = sitePlan.aiAutoReplyEnabled === true;

    // Check if limits are exhausted
    const analysisUsage = siteUsage.find(u => u.metricName === 'ai_analyses');
    const autoReplyUsage = siteUsage.find(u => u.metricName === 'ai_auto_replies');

    if (analysisUsage && sitePlan.maxAiAnalysesPerMonth) {
      aiAnalysisLimitExhausted = analysisUsage.used >= sitePlan.maxAiAnalysesPerMonth;
    }

    if (autoReplyUsage && sitePlan.maxAiAutoRepliesPerMonth) {
      aiAutoReplyLimitExhausted = autoReplyUsage.used >= sitePlan.maxAiAutoRepliesPerMonth;
    }
  }

  // Update UI
  updateAiToggleUI();
}

function updateAiToggleUI() {
  const analysisContainer = document.getElementById('analysisToggleContainer');
  const autoReplyContainer = document.getElementById('autoReplyToggleContainer');
  const analysisBadge = document.getElementById('analysisPremiumBadge');
  const autoReplyBadge = document.getElementById('autoReplyPremiumBadge');
  const analysisToggle = document.getElementById('toggleAnalysis');
  const autoReplyToggle = document.getElementById('toggleAutoReply');
  const analysisUsageIndicator = document.getElementById('analysisUsageIndicator');
  const autoReplyUsageIndicator = document.getElementById('autoReplyUsageIndicator');

  const starIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`;

  // AI Analysis toggle
  if (!aiAnalysisAvailable) {
    analysisContainer.classList.add('disabled');
    analysisBadge.innerHTML = `<span class="premium-badge" onclick="showUpgradeModal('analysis', 'not_enabled')">${starIcon} PRO</span>`;
    analysisBadge.style.display = 'inline';
    analysisToggle.disabled = true;
    analysisToggle.checked = false;
    analysisUsageIndicator.textContent = '';
  } else if (aiAnalysisLimitExhausted) {
    analysisContainer.classList.add('disabled');
    analysisBadge.innerHTML = `<span class="premium-badge" onclick="showUpgradeModal('analysis', 'exhausted')">${starIcon} Limit Reached</span>`;
    analysisBadge.style.display = 'inline';
    analysisToggle.disabled = true;
    analysisToggle.checked = false;
    const usage = siteUsage.find(u => u.metricName === 'ai_analyses');
    if (usage) {
      analysisUsageIndicator.textContent = `(${usage.used}/${sitePlan.maxAiAnalysesPerMonth})`;
      analysisUsageIndicator.className = 'usage-indicator exhausted';
    }
  } else {
    analysisContainer.classList.remove('disabled');
    analysisBadge.style.display = 'none';
    analysisToggle.disabled = false;
    // Show usage if there's a limit
    if (sitePlan && sitePlan.maxAiAnalysesPerMonth) {
      const usage = siteUsage.find(u => u.metricName === 'ai_analyses');
      const used = usage ? usage.used : 0;
      const percentage = (used / sitePlan.maxAiAnalysesPerMonth) * 100;
      analysisUsageIndicator.textContent = `(${used}/${sitePlan.maxAiAnalysesPerMonth})`;
      analysisUsageIndicator.className = percentage >= 80 ? 'usage-indicator warning' : 'usage-indicator';
    } else {
      analysisUsageIndicator.textContent = '';
    }
  }

  // AI Auto Reply toggle
  if (!aiAutoReplyAvailable) {
    autoReplyContainer.classList.add('disabled');
    autoReplyBadge.innerHTML = `<span class="premium-badge" onclick="showUpgradeModal('auto_reply', 'not_enabled')">${starIcon} PRO</span>`;
    autoReplyBadge.style.display = 'inline';
    autoReplyToggle.disabled = true;
    autoReplyToggle.checked = false;
    autoReplyUsageIndicator.textContent = '';
  } else if (aiAutoReplyLimitExhausted) {
    autoReplyContainer.classList.add('disabled');
    autoReplyBadge.innerHTML = `<span class="premium-badge" onclick="showUpgradeModal('auto_reply', 'exhausted')">${starIcon} Limit Reached</span>`;
    autoReplyBadge.style.display = 'inline';
    autoReplyToggle.disabled = true;
    autoReplyToggle.checked = false;
    const usage = siteUsage.find(u => u.metricName === 'ai_auto_replies');
    if (usage) {
      autoReplyUsageIndicator.textContent = `(${usage.used}/${sitePlan.maxAiAutoRepliesPerMonth})`;
      autoReplyUsageIndicator.className = 'usage-indicator exhausted';
    }
  } else {
    autoReplyContainer.classList.remove('disabled');
    autoReplyBadge.style.display = 'none';
    autoReplyToggle.disabled = false;
    // Show usage if there's a limit
    if (sitePlan && sitePlan.maxAiAutoRepliesPerMonth) {
      const usage = siteUsage.find(u => u.metricName === 'ai_auto_replies');
      const used = usage ? usage.used : 0;
      const percentage = (used / sitePlan.maxAiAutoRepliesPerMonth) * 100;
      autoReplyUsageIndicator.textContent = `(${used}/${sitePlan.maxAiAutoRepliesPerMonth})`;
      autoReplyUsageIndicator.className = percentage >= 80 ? 'usage-indicator warning' : 'usage-indicator';
    } else {
      autoReplyUsageIndicator.textContent = '';
    }
  }
}

function showUpgradeModal(feature, reason) {
  const modal = document.getElementById('upgradeModal');
  const title = document.getElementById('upgradeModalTitle');
  const subtitle = document.getElementById('upgradeModalSubtitle');
  const featureName = document.getElementById('upgradeFeatureName');
  const featureDesc = document.getElementById('upgradeFeatureDesc');
  const usageStatus = document.getElementById('upgradeUsageStatus');
  const usageValue = document.getElementById('upgradeUsageValue');

  if (feature === 'analysis') {
    featureName.textContent = 'AI Analysis';
    featureDesc.textContent = 'Get real-time insights about customer sentiment, buying intent, objections, and recommended responses to close more deals.';

    if (reason === 'not_enabled') {
      title.textContent = 'Unlock AI Analysis';
      subtitle.textContent = 'This feature is not included in your current plan';
      usageStatus.style.display = 'none';
    } else if (reason === 'exhausted') {
      title.textContent = 'AI Analysis Limit Reached';
      subtitle.textContent = 'You have used all your AI analyses for this month';
      usageStatus.style.display = 'flex';
      const usage = siteUsage.find(u => u.metricName === 'ai_analyses');
      if (usage && sitePlan) {
        usageValue.textContent = `${usage.used} / ${sitePlan.maxAiAnalysesPerMonth}`;
        usageValue.className = 'value exhausted';
      }
    }
  } else if (feature === 'auto_reply') {
    featureName.textContent = 'AI Auto Reply';
    featureDesc.textContent = 'Let AI automatically respond to customers with intelligent, context-aware messages while you are busy or offline.';

    if (reason === 'not_enabled') {
      title.textContent = 'Unlock AI Auto Reply';
      subtitle.textContent = 'This feature is not included in your current plan';
      usageStatus.style.display = 'none';
    } else if (reason === 'exhausted') {
      title.textContent = 'AI Auto Reply Limit Reached';
      subtitle.textContent = 'You have used all your AI auto replies for this month';
      usageStatus.style.display = 'flex';
      const usage = siteUsage.find(u => u.metricName === 'ai_auto_replies');
      if (usage && sitePlan) {
        usageValue.textContent = `${usage.used} / ${sitePlan.maxAiAutoRepliesPerMonth}`;
        usageValue.className = 'value exhausted';
      }
    }
  }

  modal.classList.add('show');
}

function closeUpgradeModal() {
  document.getElementById('upgradeModal').classList.remove('show');
}

// ==================== EMAIL MODAL ====================
function openEmailModal() {
  if (!currentVisitor || !users[currentVisitor]) return;

  const email = users[currentVisitor].email;
  if (!email) {
    showNotification('No email address available for this visitor', 'error');
    return;
  }

  document.getElementById('emailTo').value = email;
  document.getElementById('emailSubject').value = `Follow-up from ${document.title || 'Support'}`;
  document.getElementById('emailBody').value = `Hi ${users[currentVisitor].name},\n\nThank you for contacting us.\n\n`;

  const modal = document.getElementById('emailModal');
  modal.style.display = 'flex';
  setTimeout(() => modal.classList.add('show'), 10);

  document.getElementById('emailSubject').focus();
}

function closeEmailModal() {
  const modal = document.getElementById('emailModal');
  modal.classList.remove('show');
  setTimeout(() => modal.style.display = 'none', 300);
}

async function sendEmail() {
  const to = document.getElementById('emailTo').value;
  const subject = document.getElementById('emailSubject').value.trim();
  const body = document.getElementById('emailBody').value.trim();

  if (!subject) {
    showNotification('Please enter a subject', 'error');
    document.getElementById('emailSubject').focus();
    return;
  }

  if (!body) {
    showNotification('Please enter a message', 'error');
    document.getElementById('emailBody').focus();
    return;
  }

  const btn = document.getElementById('btnSendEmailSubmit');
  const originalText = btn.innerHTML;
  btn.innerHTML = '<span class="spinner"></span> Sending...';
  btn.disabled = true;

  try {
    const response = await fetch(`${API_BASE}/sites/${siteId}/send-email`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        to: to,
        subject: subject,
        body: body,
        visitorId: currentVisitor
      })
    });

    const result = await response.json();

    if (response.ok && result.success) {
      showNotification('Email sent successfully!', 'success');
      closeEmailModal();
    } else {
      showNotification(result.message || 'Failed to send email', 'error');
    }
  } catch (error) {
    console.error('Error sending email:', error);
    showNotification('Failed to send email. Please try again.', 'error');
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
}

// Attach Send Email button click handler
document.getElementById('btnSendEmail')?.addEventListener('click', openEmailModal);

function showNotification(message, type = 'info') {
  // Create notification element
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    font-size: 14px;
    font-weight: 500;
    z-index: 10001;
    animation: slideIn 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    ${type === 'success' ? 'background: #22c55e;' : type === 'error' ? 'background: #ef4444;' : 'background: #3b82f6;'}
  `;
  notification.textContent = message;
  document.body.appendChild(notification);

  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Load subscription plan on page load
loadSubscriptionPlan();

// ==================== REAL-TIME USAGE UPDATES ====================

function updateAiUsageDisplay(feature, used, limit) {
  console.log(`AI usage update: ${feature} - ${used}/${limit}`);

  if (feature === 'analysis') {
    // Update the internal state
    if (sitePlan) {
      const usage = siteUsage.find(u => u.metricName === 'ai_analyses');
      if (usage) {
        usage.used = used;
      } else {
        siteUsage.push({ metricName: 'ai_analyses', used: used });
      }
    }

    // Update UI
    const indicator = document.getElementById('analysisUsageIndicator');
    if (indicator && limit) {
      indicator.textContent = `(${used}/${limit})`;
      const percentage = (used / limit) * 100;
      if (percentage >= 100) {
        indicator.className = 'usage-indicator exhausted';
      } else if (percentage >= 80) {
        indicator.className = 'usage-indicator warning';
      } else {
        indicator.className = 'usage-indicator';
      }
    }
  } else if (feature === 'auto_reply') {
    // Update the internal state
    if (sitePlan) {
      const usage = siteUsage.find(u => u.metricName === 'ai_auto_replies');
      if (usage) {
        usage.used = used;
      } else {
        siteUsage.push({ metricName: 'ai_auto_replies', used: used });
      }
    }

    // Update UI
    const indicator = document.getElementById('autoReplyUsageIndicator');
    if (indicator && limit) {
      indicator.textContent = `(${used}/${limit})`;
      const percentage = (used / limit) * 100;
      if (percentage >= 100) {
        indicator.className = 'usage-indicator exhausted';
      } else if (percentage >= 80) {
        indicator.className = 'usage-indicator warning';
      } else {
        indicator.className = 'usage-indicator';
      }
    }
  }
}

function handleAiLimitReached(feature, message, used, limit) {
  console.log(`AI limit reached: ${feature} - ${message}`);

  // Update internal state
  if (feature === 'analysis') {
    aiAnalysisLimitExhausted = true;
  } else if (feature === 'auto_reply') {
    aiAutoReplyLimitExhausted = true;
  }

  // Update usage display
  updateAiUsageDisplay(feature, used, limit);

  // Update toggle UI to show limit reached
  updateAiToggleUI();

  // Show notification
  const featureName = feature === 'analysis' ? 'AI Analysis' : 'AI Auto Reply';
  showToast(`${featureName} limit reached! Upgrade your plan for more.`, 'warning');

  // Show upgrade modal
  showUpgradeModal(feature, 'exhausted');
}

// Export upgrade functions
window.showUpgradeModal = showUpgradeModal;
window.closeUpgradeModal = closeUpgradeModal;
window.updateAiUsageDisplay = updateAiUsageDisplay;
window.handleAiLimitReached = handleAiLimitReached;

// ==================== CONNECTION STATUS ====================
function updateConnectionStatus(status) {
  const statusEl = document.getElementById('connectionStatus');
  const dot = statusEl.querySelector('.connection-dot');
  const text = statusEl.querySelector('.connection-text');

  dot.className = 'connection-dot';

  switch(status) {
    case 'connected':
      dot.classList.add('connected');
      text.textContent = 'Connected';
      statusEl.title = 'Connected to server';
      break;
    case 'disconnected':
      dot.classList.add('disconnected');
      text.textContent = 'Disconnected';
      statusEl.title = 'Connection lost';
      break;
    case 'reconnecting':
      dot.classList.add('reconnecting');
      text.textContent = 'Reconnecting...';
      statusEl.title = 'Attempting to reconnect';
      break;
  }
}

// ==================== AGENT STATUS ====================
function toggleAgentStatusMenu() {
  const dropdown = document.getElementById('agentStatusDropdown');
  dropdown.classList.toggle('show');
}

function setAgentStatus(status) {
  agentStatus = status;
  const dot = document.getElementById('agentStatusDot');
  const text = document.getElementById('agentStatusText');
  const dropdown = document.getElementById('agentStatusDropdown');

  dot.className = 'agent-status-dot ' + status;
  text.textContent = status.charAt(0).toUpperCase() + status.slice(1);
  dropdown.classList.remove('show');

  // Notify server of status change
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({
      type: 'agent_status_change',
      status: status
    }));
  }

  showToast(`Status changed to ${status}`, 'success');
}

// Close agent status dropdown when clicking outside
document.addEventListener('click', (e) => {
  const wrapper = document.querySelector('.agent-status-wrapper');
  if (wrapper && !wrapper.contains(e.target)) {
    document.getElementById('agentStatusDropdown').classList.remove('show');
  }
});

// ==================== TRANSFER CONVERSATION ====================
async function loadSiteAgents() {
  try {
    const response = await fetch(`${API_BASE}/sites/${siteId}/agents`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (response.ok) {
      const result = await response.json();
      siteAgents = result.data || result || [];
    }
  } catch (err) {
    console.error('Failed to load agents:', err);
  }
}

// ==================== PLATFORM FEATURE FLAGS ====================
async function loadPlatformFeatures() {
  try {
    const response = await fetch(`${API_BASE}/SiteSettings`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (response.ok) {
      const result = await response.json();
      if (result.data) {
        platformFeatures = {
          supervisorMode: result.data.featureSupervisorMode ?? true,
          aiAnalysis: result.data.featureAiAnalysis ?? true,
          aiAutoReply: result.data.featureAiAutoReply ?? true,
          fileSharing: result.data.featureFileSharing ?? true,
          csatRatings: result.data.featureCsatRatings ?? true,
          visitorInfo: result.data.featureVisitorInfo ?? true,
          cannedResponses: result.data.featureCannedResponses ?? true,
          conversationTransfer: result.data.featureConversationTransfer ?? true,
          teamChat: result.data.featureTeamChat ?? true,
          typingIndicators: result.data.featureTypingIndicators ?? true,
          readReceipts: result.data.featureReadReceipts ?? true,
          internalNotes: result.data.featureInternalNotes ?? true,
          emojiPicker: result.data.featureEmojiPicker ?? true,
          emailSending: result.data.featureEmailSending ?? true,
          conversationSearch: result.data.featureConversationSearch ?? true,
          messageSearch: result.data.featureMessageSearch ?? true,
          bulkActions: result.data.featureBulkActions ?? true,
          themes: result.data.featureThemes ?? true,
          agentStatus: result.data.featureAgentStatus ?? true,
          notifications: result.data.featureNotifications ?? true
        };
        applyFeatureFlags();
      }
    }
  } catch (err) {
    console.error('Failed to load platform features:', err);
  }
}

function applyFeatureFlags() {
  // Supervisor Mode - only hide if disabled, don't override role-based visibility
  const supervisorBtn = document.getElementById('supervisorBtn');
  if (supervisorBtn && !platformFeatures.supervisorMode) {
    supervisorBtn.style.display = 'none';
  } else if (supervisorBtn && isSupervisor && platformFeatures.supervisorMode) {
    supervisorBtn.style.display = 'flex';
  }

  // AI Analysis toggle
  const analysisToggleContainer = document.getElementById('analysisToggleContainer');
  if (analysisToggleContainer) {
    analysisToggleContainer.style.display = platformFeatures.aiAnalysis ? '' : 'none';
  }

  // AI Auto Reply toggle
  const autoReplyToggleContainer = document.getElementById('autoReplyToggleContainer');
  if (autoReplyToggleContainer) {
    autoReplyToggleContainer.style.display = platformFeatures.aiAutoReply ? '' : 'none';
  }

  // File sharing
  const fileAttachBtn = document.getElementById('btnAttach');
  if (fileAttachBtn) {
    fileAttachBtn.style.display = platformFeatures.fileSharing ? '' : 'none';
  }

  // Canned responses / Quick replies
  const quickRepliesBtn = document.getElementById('btnQuickReplies');
  if (quickRepliesBtn) {
    quickRepliesBtn.style.display = platformFeatures.cannedResponses ? '' : 'none';
  }

  // Conversation transfer
  const transferBtn = document.getElementById('btnTransfer');
  if (transferBtn) {
    transferBtn.style.display = platformFeatures.conversationTransfer ? '' : 'none';
  }

  // Team chat button (topbar) and sidebar agents section
  const teamChatBtn = document.getElementById('btnTeamChat');
  if (teamChatBtn) {
    teamChatBtn.style.display = platformFeatures.teamChat ? '' : 'none';
  }
  const agentsSection = document.getElementById('agentsSection');
  if (agentsSection) {
    agentsSection.style.display = platformFeatures.teamChat ? '' : 'none';
  }

  // Close conversation button (CSAT is part of closing)
  const closeConvBtn = document.getElementById('btnCloseConv');
  if (closeConvBtn) {
    closeConvBtn.style.display = platformFeatures.csatRatings ? '' : 'none';
  }

  // Visitor Info Panel (right sidebar)
  const visitorInfoPanel = document.getElementById('visitorInfoPanel');
  if (visitorInfoPanel) {
    visitorInfoPanel.style.display = platformFeatures.visitorInfo ? '' : 'none';
  }

  // Internal Notes section
  const commentsSection = document.getElementById('commentsSection');
  if (commentsSection) {
    commentsSection.style.display = platformFeatures.internalNotes ? '' : 'none';
  }

  // Emoji picker button
  const emojiBtn = document.getElementById('btnEmoji');
  if (emojiBtn) {
    emojiBtn.style.display = platformFeatures.emojiPicker ? '' : 'none';
  }

  // Email sending button
  const sendEmailBtn = document.getElementById('btnSendEmail');
  if (sendEmailBtn && !platformFeatures.emailSending) {
    sendEmailBtn.style.display = 'none';
  }

  // Conversation search (topbar)
  const searchCenter = document.querySelector('.topbar-center');
  if (searchCenter) {
    searchCenter.style.display = platformFeatures.conversationSearch ? '' : 'none';
  }

  // Message search button (in chat header)
  const msgSearchBtn = document.getElementById('btnSearchMessages');
  if (msgSearchBtn) {
    msgSearchBtn.style.display = platformFeatures.messageSearch ? '' : 'none';
  }

  // Bulk actions button
  const bulkSelectBtn = document.getElementById('btnBulkSelect');
  if (bulkSelectBtn) {
    bulkSelectBtn.style.display = platformFeatures.bulkActions ? '' : 'none';
  }

  // Themes / Settings button
  const settingsBtn = document.querySelector('.topbar-btn[title="Settings"]');
  if (settingsBtn) {
    settingsBtn.style.display = platformFeatures.themes ? '' : 'none';
  }

  // Agent status selector
  const agentStatusWrapper = document.querySelector('.agent-status-wrapper');
  if (agentStatusWrapper) {
    agentStatusWrapper.style.display = platformFeatures.agentStatus ? '' : 'none';
  }

  // Notifications button
  const notificationsBtn = document.getElementById('notificationsBtn');
  if (notificationsBtn) {
    notificationsBtn.style.display = platformFeatures.notifications ? '' : 'none';
  }

  console.log('Platform features applied:', platformFeatures);
}

let transferModalTimeout = null;

function openTransferModal() {
  if (!currentVisitor) return;

  const modal = document.getElementById('transferModal');
  const transferAgentsList = document.getElementById('transferAgentsList');

  selectedTransferAgent = null;
  document.getElementById('btnTransferConfirm').disabled = true;
  document.getElementById('transferNote').value = '';
  modal.style.display = 'flex';

  // Show loading state if no agents loaded yet
  if (siteAgents.length === 0) {
    transferAgentsList.innerHTML = '<div class="no-agents" style="text-align:center;padding:20px;"><div class="skeleton-line" style="width:60%;margin:0 auto 8px"></div><div class="skeleton-line" style="width:40%;margin:0 auto"></div><p style="margin-top:12px;color:var(--text-muted);font-size:13px;">Loading available agents...</p></div>';

    // Set timeout for agent loading
    transferModalTimeout = setTimeout(() => {
      if (siteAgents.length === 0) {
        transferAgentsList.innerHTML = `<div class="error-state" style="padding:20px;">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width:36px;height:36px;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <h4>Could not load agents</h4>
          <p>No agents available or request timed out.</p>
          <button class="btn-retry" onclick="retryLoadTransferAgents()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Retry
          </button>
        </div>`;
      }
    }, 5000);
  } else {
    renderTransferAgentsList();
  }
}

function renderTransferAgentsList() {
  const transferAgentsList = document.getElementById('transferAgentsList');
  transferAgentsList.innerHTML = siteAgents.map(agent => `
    <div class="agent-option ${selectedTransferAgent === agent.userId ? 'selected' : ''}"
         onclick="selectTransferAgent('${agent.userId}', '${escapeHtml(agent.name || agent.email)}')">
      <div class="agent-option-avatar">${getInitials(agent.name || agent.email)}</div>
      <div class="agent-option-info">
        <div class="agent-option-name">${escapeHtml(agent.name || 'Agent')}</div>
        <div class="agent-option-email">${escapeHtml(agent.email || '')}</div>
      </div>
      <div class="agent-option-status">
        <span class="agent-status-dot online"></span>
      </div>
    </div>
  `).join('');
}

function retryLoadTransferAgents() {
  const transferAgentsList = document.getElementById('transferAgentsList');
  transferAgentsList.innerHTML = '<div class="no-agents" style="text-align:center;padding:20px;"><p style="color:var(--text-muted);font-size:13px;">Loading available agents...</p></div>';
  // Re-set timeout
  if (transferModalTimeout) clearTimeout(transferModalTimeout);
  transferModalTimeout = setTimeout(() => {
    if (siteAgents.length === 0) {
      transferAgentsList.innerHTML = '<div class="no-agents">No other agents available</div>';
    }
  }, 5000);
}

function closeTransferModal() {
  document.getElementById('transferModal').style.display = 'none';
  selectedTransferAgent = null;
  if (transferModalTimeout) {
    clearTimeout(transferModalTimeout);
    transferModalTimeout = null;
  }
}

function openCsatFeedbackModal() {
  if (!currentVisitor || !users[currentVisitor]) return;

  const user = users[currentVisitor];
  const rating = user.csatRating;
  const feedback = user.csatFeedback;

  if (!rating) return;

  // Build stars
  let starsHtml = '';
  for (let i = 1; i <= 5; i++) {
    starsHtml += i <= rating ? '\u2605' : '\u2606';
  }

  document.getElementById('csatFeedbackStars').textContent = starsHtml;
  document.getElementById('csatFeedbackScore').textContent = `${rating}/5`;

  const feedbackText = document.getElementById('csatFeedbackText');
  if (feedback && feedback.trim()) {
    feedbackText.textContent = feedback;
    feedbackText.classList.remove('csat-feedback-empty');
  } else {
    feedbackText.textContent = 'No comment provided';
    feedbackText.classList.add('csat-feedback-empty');
  }

  document.getElementById('csatFeedbackModal').style.display = 'flex';
}

function closeCsatFeedbackModal() {
  document.getElementById('csatFeedbackModal').style.display = 'none';
}

function selectTransferAgent(agentId, agentName) {
  selectedTransferAgent = { id: agentId, name: agentName };

  // Update UI
  document.querySelectorAll('.agent-option').forEach(el => el.classList.remove('selected'));
  event.currentTarget.classList.add('selected');
  document.getElementById('btnTransferConfirm').disabled = false;
}

async function confirmTransfer() {
  if (!selectedTransferAgent || !currentVisitor) return;

  const user = users[currentVisitor];
  const note = document.getElementById('transferNote').value.trim();

  const result = await Swal.fire({
    title: 'Transfer Conversation?',
    text: `Transfer this conversation to ${selectedTransferAgent.name}?`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#2563eb',
    cancelButtonColor: '#64748b',
    confirmButtonText: 'Yes, transfer',
    cancelButtonText: 'Cancel'
  });

  if (!result.isConfirmed) return;

  try {
    // Send transfer request via WebSocket
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({
        type: 'transfer_conversation',
        conversationId: user.conversationId,
        visitorId: currentVisitor,
        toAgentId: selectedTransferAgent.id,
        note: note
      }));
    }

    showToast(`Conversation transferred to ${selectedTransferAgent.name}`, 'success');
    closeTransferModal();

    // Remove from local list
    delete users[currentVisitor];
    currentVisitor = null;
    showNoChat();
    renderUsers();

  } catch (err) {
    console.error('Transfer failed:', err);
    Swal.fire('Error', 'Failed to transfer conversation', 'error');
  }
}

// ==================== CLOSE CONVERSATION ====================
function openCloseConversationModal() {
  if (!currentVisitor) return;

  const modal = document.getElementById('closeConvModal');
  document.getElementById('sendCsatCheckbox').checked = true;
  document.getElementById('closeConvNote').value = '';
  document.getElementById('closeConvStatus').value = 'resolved';
  modal.style.display = 'flex';
}

function closeCloseConversationModal() {
  document.getElementById('closeConvModal').style.display = 'none';
}

async function confirmCloseConversation() {
  if (!currentVisitor) return;

  const user = users[currentVisitor];
  const sendCsat = document.getElementById('sendCsatCheckbox').checked;
  const note = document.getElementById('closeConvNote').value.trim();
  const status = document.getElementById('closeConvStatus').value;

  try {
    // Send close conversation request via WebSocket
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({
        type: 'close_conversation',
        conversationId: user.conversationId,
        visitorId: currentVisitor,
        sendCsat: sendCsat,
        note: note,
        status: status
      }));
    }

    // Mark conversation as closed locally
    user.isClosed = true;
    user.closedAt = new Date();
    user.closedStatus = status;
    user.status = 'closed'; // Update status for badge display and filtering

    showToast('Conversation closed successfully', 'success');
    closeCloseConversationModal();

    // Update UI to show closed status
    updateChatHeaderForClosedConversation();
    renderUsers();

  } catch (err) {
    console.error('Close conversation failed:', err);
    Swal.fire('Error', 'Failed to close conversation', 'error');
  }
}

function updateChatHeaderForClosedConversation() {
  if (!currentVisitor || !users[currentVisitor]) return;

  const user = users[currentVisitor];
  if (user.isClosed) {
    const statusEl = document.getElementById('chatHeaderStatus');
    if (statusEl) {
      statusEl.innerHTML = `<span class="closed-badge">Closed</span>`;
    }

    // Disable input area
    const inputArea = document.getElementById('chatInputArea');
    if (inputArea) {
      inputArea.classList.add('disabled');
    }

    // Hide close button, show reopen option
    const closeBtn = document.getElementById('btnCloseConv');
    if (closeBtn) {
      closeBtn.style.display = 'none';
    }
  }
}

function displayCsatRating(visitorId, rating, feedback) {
  if (!users[visitorId]) return;

  users[visitorId].csatRating = rating;
  users[visitorId].csatFeedback = feedback;

  // If this is the current conversation, update the CSAT badge
  if (currentVisitor === visitorId) {
    const csatBadge = document.getElementById('csatBadge');
    const csatStars = document.getElementById('csatStars');
    const csatValue = document.getElementById('csatValue');

    if (csatBadge && csatStars && csatValue) {
      // Generate stars
      let starsHtml = '';
      for (let i = 1; i <= 5; i++) {
        starsHtml += i <= rating ? '' : '';
      }
      csatStars.textContent = starsHtml;
      csatValue.textContent = `${rating}/5`;
      csatBadge.style.display = 'flex';
      csatBadge.className = `csat-badge csat-${rating <= 2 ? 'low' : rating <= 3 ? 'medium' : 'high'}`;
    }
  }

  showToast(`Customer rated the conversation: ${rating}/5 stars`, rating >= 4 ? 'success' : 'info');
}

// ==================== TAB TITLE WITH UNREAD COUNT ====================
function updateTabTitle() {
  const totalUnread = Object.values(users).reduce((sum, u) => sum + (u.unread || 0), 0);

  if (totalUnread > 0) {
    document.title = `(${totalUnread}) ${originalTitle}`;
  } else {
    document.title = originalTitle;
  }
}

// Override renderUsers to also update tab title
const originalRenderUsers = renderUsers;
renderUsers = function() {
  originalRenderUsers();
  updateTabTitle();
};

// ==================== COLLABORATION FEATURES ====================

// Agent-to-Agent Chat State
let onlineAgents = {};        // agentId -> {username, status}
let agentChats = {};          // agentId -> {messages: []}
let currentAgentChat = null;  // Currently open agent chat
let agentTypingTimeout = null;
let mentionNotifications = 0;

// Comments State
let conversationComments = {}; // conversationId -> [comments]

// Supervisor State
let isSupervisor = false;
let supervisorData = { agents: [], conversations: [] };
let agentsSectionCollapsed = false;

// Get current user info from URL params
const currentAgentId = params.get("userId") || null;
const currentAgentRole = params.get("role") || "agent";

// ==================== WEBSOCKET HANDLERS FOR COLLABORATION ====================

// Extend ws.onmessage to handle new message types
const originalOnMessage = ws.onmessage;
ws.onmessage = function(e) {
  if (loggedOut) return;
  const data = JSON.parse(e.data);

  // Handle collaboration message types
  switch(data.type) {
    case 'online_agents_list':
      onlineAgents = data.agents || {};
      renderOnlineAgents();
      break;

    case 'agent_joined':
      onlineAgents[data.agentId] = {
        username: data.username,
        status: data.status || 'online'
      };
      renderOnlineAgents();
      showToast(`${data.username} is now online`, 'info');
      break;

    case 'agent_left':
      delete onlineAgents[data.agentId];
      renderOnlineAgents();
      if (currentAgentChat === data.agentId) {
        document.getElementById('agentChatStatus').textContent = 'Offline';
      }
      break;

    case 'agent_status_changed':
      if (onlineAgents[data.agentId]) {
        onlineAgents[data.agentId].status = data.status;
        renderOnlineAgents();
      }
      break;

    case 'agent_message':
      handleIncomingAgentMessage(data);
      break;

    case 'agent_message_sent':
      // Confirmation that message was sent
      break;

    case 'agent_typing_start':
      if (currentAgentChat === data.fromAgentId) {
        document.getElementById('agentChatTyping').style.display = 'flex';
      }
      break;

    case 'agent_typing_stop':
      if (currentAgentChat === data.fromAgentId) {
        document.getElementById('agentChatTyping').style.display = 'none';
      }
      break;

    case 'agent_chat_history':
      if (data.withAgentId && agentChats[data.withAgentId]) {
        agentChats[data.withAgentId].messages = data.messages || [];
        if (currentAgentChat === data.withAgentId) {
          renderAgentChatMessages();
        }
      }
      break;

    case 'new_comment':
      handleNewComment(data);
      break;

    case 'mention_notification':
      handleMentionNotification(data);
      break;

    case 'message_delivered': {
      // Customer's device confirmed delivery of our message
      const vid = data.from || data.visitorId;
      if (vid && users[vid]) {
        const ts = data.timestamp ? new Date(data.timestamp).getTime() : null;
        const msg = ts
          ? users[vid].messages.find(m => m.from === 'support' && Math.abs(m.time.getTime() - ts) < 2000 && !m.deliveredAt)
          : [...users[vid].messages].reverse().find(m => m.from === 'support' && !m.deliveredAt);
        if (msg) {
          msg.deliveredAt = new Date();
          if (currentVisitor === vid) renderMessages();
        }
      }
      break;
    }

    case 'message_read':
    case 'messages_read': {
      // Customer has read our messages
      const vid = data.from || data.visitorId;
      if (vid && users[vid]) {
        const now = new Date();
        users[vid].messages.forEach(m => {
          if (m.from === 'support' && !m.readAt) {
            if (!m.deliveredAt) m.deliveredAt = now;
            m.readAt = now;
          }
        });
        if (currentVisitor === vid) renderMessages();
      }
      break;
    }

    case 'supervisor_data':
      supervisorData = {
        agents: data.agents || [],
        conversations: data.conversations || []
      };
      renderSupervisorView();
      break;

    default:
      // Call original handler for other message types
      if (originalOnMessage) {
        originalOnMessage.call(ws, e);
      }
  }
};

// ==================== ONLINE AGENTS RENDERING ====================

function renderOnlineAgents() {
  const agentsList = document.getElementById('agentsList');
  const agentsPanelList = document.getElementById('agentsPanelList');
  const agentsCount = document.getElementById('agentsCount');

  const agentEntries = Object.entries(onlineAgents);
  agentsCount.textContent = agentEntries.length;

  if (agentEntries.length === 0) {
    const noAgentsHtml = '<div class="no-agents">No other agents online</div>';
    agentsList.innerHTML = noAgentsHtml;
    agentsPanelList.innerHTML = '<div class="no-agents-panel">No other agents online</div>';
    return;
  }

  const html = agentEntries.map(([agentId, agent]) => {
    const initials = agent.username ? agent.username.substring(0, 2).toUpperCase() : 'A';
    const unreadCount = agentChats[agentId]?.unread || 0;
    return `
      <div class="agent-item ${agent.status}" onclick="openAgentChat('${agentId}')">
        <div class="agent-item-avatar">${initials}</div>
        <div class="agent-item-info">
          <span class="agent-item-name">${escapeHtml(agent.username)}</span>
          <span class="agent-item-status">${agent.status}</span>
        </div>
        ${unreadCount > 0 ? `<span class="agent-unread-badge">${unreadCount}</span>` : ''}
      </div>
    `;
  }).join('');

  agentsList.innerHTML = html;
  agentsPanelList.innerHTML = html;
}

function toggleAgentsSectionCollapse() {
  agentsSectionCollapsed = !agentsSectionCollapsed;
  const agentsList = document.getElementById('agentsList');
  const icon = document.getElementById('agentsCollapseIcon');

  if (agentsSectionCollapsed) {
    agentsList.style.display = 'none';
    icon.style.transform = 'rotate(-90deg)';
  } else {
    agentsList.style.display = 'block';
    icon.style.transform = 'rotate(0deg)';
  }
}

function toggleAgentsPanel() {
  const panel = document.getElementById('agentsPanel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

// ==================== AGENT-TO-AGENT CHAT ====================

function openAgentChat(agentId) {
  const agent = onlineAgents[agentId];
  if (!agent) return;

  currentAgentChat = agentId;

  // Initialize chat if not exists
  if (!agentChats[agentId]) {
    agentChats[agentId] = { messages: [], unread: 0 };
    // Request chat history
    ws.send(JSON.stringify({
      type: 'get_agent_chat_history',
      withAgentId: agentId
    }));
  }

  // Clear unread
  agentChats[agentId].unread = 0;
  renderOnlineAgents();

  // Update modal
  const initials = agent.username.substring(0, 2).toUpperCase();
  document.getElementById('agentChatAvatar').textContent = initials;
  document.getElementById('agentChatName').textContent = agent.username;
  document.getElementById('agentChatStatus').textContent = agent.status;

  // Show modal
  document.getElementById('agentChatModal').style.display = 'flex';

  // Render messages
  renderAgentChatMessages();

  // Focus input
  document.getElementById('agentChatInput').focus();

  // Hide agents panel
  document.getElementById('agentsPanel').style.display = 'none';
}

function closeAgentChat() {
  currentAgentChat = null;
  document.getElementById('agentChatModal').style.display = 'none';
  document.getElementById('agentChatTyping').style.display = 'none';
}

function renderAgentChatMessages() {
  const container = document.getElementById('agentChatMessages');
  if (!currentAgentChat || !agentChats[currentAgentChat]) {
    container.innerHTML = '<div class="agent-chat-empty">Start a conversation</div>';
    return;
  }

  const messages = agentChats[currentAgentChat].messages;
  if (messages.length === 0) {
    container.innerHTML = '<div class="agent-chat-empty">Start a conversation</div>';
    return;
  }

  container.innerHTML = messages.map(msg => {
    const isMine = msg.from === currentAgentId || msg.fromName === currentUsername;
    const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
    return `
      <div class="agent-msg ${isMine ? 'mine' : 'theirs'}">
        <div class="agent-msg-bubble">${escapeHtml(msg.message)}</div>
        <div class="agent-msg-time">${time}</div>
      </div>
    `;
  }).join('');

  container.scrollTop = container.scrollHeight;
}

function sendAgentMessage() {
  const input = document.getElementById('agentChatInput');
  const message = input.value.trim();

  if (!message || !currentAgentChat) return;

  const timestamp = new Date().toISOString();

  // Add to local chat
  if (!agentChats[currentAgentChat]) {
    agentChats[currentAgentChat] = { messages: [], unread: 0 };
  }
  agentChats[currentAgentChat].messages.push({
    from: currentAgentId,
    fromName: currentUsername,
    to: currentAgentChat,
    message: message,
    timestamp: timestamp
  });

  // Render
  renderAgentChatMessages();

  // Send via WebSocket
  ws.send(JSON.stringify({
    type: 'agent_message',
    toAgentId: currentAgentChat,
    message: message,
    timestamp: timestamp
  }));

  // Clear input
  input.value = '';

  // Stop typing indicator
  ws.send(JSON.stringify({
    type: 'agent_typing_stop',
    toAgentId: currentAgentChat
  }));
}

function handleIncomingAgentMessage(data) {
  const fromAgentId = data.fromAgentId;

  // Initialize chat if not exists
  if (!agentChats[fromAgentId]) {
    agentChats[fromAgentId] = { messages: [], unread: 0 };
  }

  // Add message
  agentChats[fromAgentId].messages.push({
    from: fromAgentId,
    fromName: data.fromAgentName,
    message: data.message,
    timestamp: data.timestamp
  });

  // If chat is open, render. Otherwise increment unread
  if (currentAgentChat === fromAgentId) {
    renderAgentChatMessages();
  } else {
    agentChats[fromAgentId].unread = (agentChats[fromAgentId].unread || 0) + 1;
    renderOnlineAgents();
    showToast(`Message from ${data.fromAgentName}`, 'info');
  }
}

// Agent typing indicator
document.getElementById('agentChatInput')?.addEventListener('input', () => {
  if (!currentAgentChat) return;

  ws.send(JSON.stringify({
    type: 'agent_typing_start',
    toAgentId: currentAgentChat
  }));

  clearTimeout(agentTypingTimeout);
  agentTypingTimeout = setTimeout(() => {
    ws.send(JSON.stringify({
      type: 'agent_typing_stop',
      toAgentId: currentAgentChat
    }));
  }, 2000);
});

// ==================== CONVERSATION COMMENTS ====================

async function loadComments(conversationId) {
  if (!conversationId) return;

  try {
    const response = await fetch(`${API_BASE}/conversations/${conversationId}/comments`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (response.ok) {
      const result = await response.json();
      conversationComments[conversationId] = result.data || [];
      renderComments();
    }
  } catch (err) {
    console.error('Failed to load comments:', err);
  }
}

function renderComments() {
  const container = document.getElementById('commentsList');
  const countEl = document.getElementById('commentsCount');

  if (!currentVisitor || !users[currentVisitor]) {
    container.innerHTML = '<div class="no-comments">Select a conversation</div>';
    countEl.textContent = '0';
    return;
  }

  const convId = users[currentVisitor].conversationId;
  const comments = conversationComments[convId] || [];
  countEl.textContent = comments.length;

  if (comments.length === 0) {
    container.innerHTML = '<div class="no-comments">No notes yet</div>';
    return;
  }

  container.innerHTML = comments.map(c => {
    const time = new Date(c.createdAt).toLocaleString([], {
      month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
    });
    const initials = c.authorName ? c.authorName.substring(0, 2).toUpperCase() : 'A';

    // Highlight mentions
    let content = escapeHtml(c.content);
    content = content.replace(/@(\w+)/g, '<span class="mention-highlight">@$1</span>');

    return `
      <div class="comment-item">
        <div class="comment-header">
          <div class="comment-avatar">${initials}</div>
          <span class="comment-author">${escapeHtml(c.authorName || 'Agent')}</span>
          <span class="comment-time">${time}</span>
        </div>
        <div class="comment-content">${content}</div>
      </div>
    `;
  }).join('');

  container.scrollTop = container.scrollHeight;
}

async function addComment() {
  const input = document.getElementById('commentInput');
  const content = input.value.trim();

  if (!content || !currentVisitor || !users[currentVisitor]) return;

  const convId = users[currentVisitor].conversationId;
  if (!convId) {
    showToast('No conversation ID available', 'error');
    return;
  }

  // Extract mentions
  const mentions = extractMentions(content);

  try {
    const response = await fetch(`${API_BASE}/conversations/${convId}/comments`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        content: content,
        mentions: mentions
      })
    });

    if (response.ok) {
      const result = await response.json();
      const newComment = result.data || {
        id: Date.now().toString(),
        content: content,
        authorName: currentUsername,
        createdAt: new Date().toISOString(),
        mentions: mentions
      };

      // Add locally
      if (!conversationComments[convId]) {
        conversationComments[convId] = [];
      }
      conversationComments[convId].push(newComment);
      renderComments();

      // Broadcast to other agents
      ws.send(JSON.stringify({
        type: 'new_comment',
        conversationId: convId,
        comment: newComment,
        mentions: mentions
      }));

      input.value = '';
    } else {
      showToast('Failed to add comment', 'error');
    }
  } catch (err) {
    console.error('Failed to add comment:', err);
    showToast('Failed to add comment', 'error');
  }
}

function handleNewComment(data) {
  const convId = data.conversationId;
  if (!convId) return;

  if (!conversationComments[convId]) {
    conversationComments[convId] = [];
  }
  conversationComments[convId].push(data.comment);

  // Re-render if viewing this conversation
  if (currentVisitor && users[currentVisitor]?.conversationId === convId) {
    renderComments();
  }
}

// ==================== MENTION AUTOCOMPLETE ====================

function handleCommentInput(event) {
  const input = event.target;
  const text = input.value;
  const cursorPos = input.selectionStart;

  // Get text before cursor
  const textBeforeCursor = text.substring(0, cursorPos);
  const match = textBeforeCursor.match(/@(\w*)$/);

  if (match) {
    showMentionSuggestions(match[1], input);
  } else {
    hideMentionSuggestions();
  }
}

function showMentionSuggestions(query, input) {
  const dropdown = document.getElementById('mentionsDropdown');
  const queryLower = query.toLowerCase();

  // Combine online agents and site agents
  const allAgents = [
    ...Object.entries(onlineAgents).map(([id, a]) => ({ id, name: a.username })),
    ...siteAgents.filter(a => !onlineAgents[a.userId]).map(a => ({ id: a.userId, name: a.name || a.email }))
  ];

  const filtered = allAgents.filter(a =>
    a.name && a.name.toLowerCase().includes(queryLower)
  );

  if (filtered.length === 0) {
    hideMentionSuggestions();
    return;
  }

  dropdown.innerHTML = filtered.slice(0, 5).map(a => `
    <div class="mention-suggestion" onclick="selectMention('${escapeHtml(a.name)}', '${a.id}')">
      <span class="mention-avatar">${a.name.substring(0, 2).toUpperCase()}</span>
      <span class="mention-name">${escapeHtml(a.name)}</span>
    </div>
  `).join('');

  dropdown.style.display = 'block';
}

function hideMentionSuggestions() {
  document.getElementById('mentionsDropdown').style.display = 'none';
}

function selectMention(name, agentId) {
  const input = document.getElementById('commentInput');
  const text = input.value;
  const cursorPos = input.selectionStart;

  // Find the @ position
  const textBeforeCursor = text.substring(0, cursorPos);
  const atIndex = textBeforeCursor.lastIndexOf('@');

  if (atIndex !== -1) {
    const newText = text.substring(0, atIndex) + '@' + name + ' ' + text.substring(cursorPos);
    input.value = newText;
    input.selectionStart = input.selectionEnd = atIndex + name.length + 2;
  }

  hideMentionSuggestions();
  input.focus();
}

function extractMentions(content) {
  const regex = /@(\w+)/g;
  const mentions = [];
  let match;

  while ((match = regex.exec(content)) !== null) {
    const name = match[1];
    // Find agent ID by name
    for (const [id, agent] of Object.entries(onlineAgents)) {
      if (agent.username.toLowerCase() === name.toLowerCase()) {
        mentions.push(id);
        break;
      }
    }
    // Also check siteAgents
    for (const agent of siteAgents) {
      const agentName = agent.name || agent.email;
      if (agentName && agentName.toLowerCase() === name.toLowerCase()) {
        mentions.push(agent.userId || agent.id);
        break;
      }
    }
  }

  return [...new Set(mentions)]; // Remove duplicates
}

function handleMentionNotification(data) {
  mentionNotifications++;
  updateNotificationBadge();

  showToast(`${data.fromAgent} mentioned you in a note`, 'info');

  // Navigate to conversation if clicked
  if (data.conversationId) {
    // Find visitor with this conversation
    for (const [vid, user] of Object.entries(users)) {
      if (user.conversationId === data.conversationId) {
        selectUser(vid);
        break;
      }
    }
  }
}

function updateNotificationBadge() {
  const badge = document.getElementById('notificationBadge');
  if (mentionNotifications > 0) {
    badge.textContent = mentionNotifications;
    badge.style.display = 'block';
  } else {
    badge.style.display = 'none';
  }
}

// ==================== SUPERVISOR VIEW ====================

function initSupervisorFeatures() {
  // Check if user has supervisor role AND platform feature is enabled
  console.log('initSupervisorFeatures - currentAgentRole:', currentAgentRole);
  if (currentAgentRole && ['admin', 'site_admin', 'supervisor', 'super_admin'].includes(currentAgentRole)) {
    isSupervisor = true;
    const btn = document.getElementById('supervisorBtn');
    if (btn) {
      // Only show if platform feature is also enabled
      btn.style.display = platformFeatures.supervisorMode ? 'flex' : 'none';
      console.log('Supervisor button enabled:', platformFeatures.supervisorMode);
    } else {
      console.error('supervisorBtn element not found');
    }
  }
}

function openSupervisorModal() {
  if (!isSupervisor) return;

  document.getElementById('supervisorModal').style.display = 'flex';
  loadSupervisorData();
}

function closeSupervisorModal() {
  document.getElementById('supervisorModal').style.display = 'none';
}

async function loadSupervisorData() {
  try {
    const response = await fetch(`${API_BASE}/sites/${siteId}/supervisor/overview`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (response.ok) {
      const result = await response.json();
      if (result.success) {
        supervisorData = result.data;
        renderSupervisorView();
      }
    }
  } catch (err) {
    console.error('Failed to load supervisor data:', err);
  }
}

function renderSupervisorView() {
  // Update stats
  document.getElementById('statOnlineAgents').textContent = supervisorData.stats?.onlineAgents || 0;
  document.getElementById('statTotalAgents').textContent = supervisorData.stats?.totalAgents || 0;
  document.getElementById('statActiveConvs').textContent = supervisorData.stats?.totalActiveConversations || 0;
  document.getElementById('statTotalConvs').textContent = supervisorData.stats?.unassignedConversations || 0;

  // Render agents
  const agentsList = document.getElementById('supervisorAgentsList');
  const agents = supervisorData.agents || [];

  if (agents.length === 0) {
    agentsList.innerHTML = '<div class="no-supervisor-data">No agents found</div>';
  } else {
    agentsList.innerHTML = agents.map(agent => {
      const initials = agent.username ? agent.username.substring(0, 2).toUpperCase() : 'A';
      const statusClass = agent.isOnline ? agent.status || 'online' : 'offline';
      return `
        <div class="supervisor-agent-card ${statusClass}">
          <div class="supervisor-agent-avatar">${initials}</div>
          <div class="supervisor-agent-info">
            <span class="supervisor-agent-name">${escapeHtml(agent.username || 'Agent')}</span>
            <span class="supervisor-agent-status">${agent.isOnline ? (agent.status || 'Online') : 'Offline'}</span>
          </div>
        </div>
      `;
    }).join('');
  }

  // Render conversations
  const convsList = document.getElementById('supervisorConversationsList');
  const conversations = supervisorData.conversations || [];

  if (conversations.length === 0) {
    convsList.innerHTML = '<div class="no-supervisor-data">No conversations found</div>';
  } else {
    convsList.innerHTML = conversations.map(conv => {
      const visitorName = conv.visitorName || 'Visitor';
      const initials = visitorName.substring(0, 2).toUpperCase();
      const isActive = conv.status === 'active';
      return `
        <div class="supervisor-conv-card ${isActive ? 'active' : ''}" onclick="viewConversationAsSupervisor('${conv.visitorId}')">
          <div class="supervisor-conv-avatar">${initials}</div>
          <div class="supervisor-conv-info">
            <span class="supervisor-conv-name">${escapeHtml(visitorName)}</span>
            <span class="supervisor-conv-status">${conv.status || 'Unknown'} - ${conv.messageCount || 0} msgs</span>
          </div>
          ${conv.assignedAgentName ? `<span class="supervisor-conv-badge">${escapeHtml(conv.assignedAgentName)}</span>` : '<span class="supervisor-conv-badge unassigned">Unassigned</span>'}
        </div>
      `;
    }).join('');
  }
}

function viewConversationAsSupervisor(visitorId) {
  closeSupervisorModal();
  if (users[visitorId]) {
    selectUser(visitorId);
  } else {
    showToast('Conversation not available in your view', 'info');
  }
}

// ==================== EXTEND SELECT USER FOR COMMENTS ====================

const originalSelectUser = selectUser;
selectUser = function(vid) {
  originalSelectUser(vid);
  // Load comments for this conversation (only if internal notes feature is enabled)
  if (platformFeatures.internalNotes && users[vid]?.conversationId) {
    loadComments(users[vid].conversationId);
  }
  // Re-apply feature flags after selectUser to enforce visibility
  applyFeatureFlags();
};

// ==================== INIT COLLABORATION FEATURES ====================

// Initialize on load - ensure DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initSupervisorFeatures);
} else {
  initSupervisorFeatures();
}

// ==================== ADVANCED FILTERS ====================

let activeFilters = {};
let filterActive = false;
let currentFilterVids = null; // Stores current filter results so renderUsers can use them

function toggleFilterPanel() {
  openFilterDrawer();
}

function openFilterDrawer() {
  const drawer = document.getElementById('filterDrawer');
  const overlay = document.getElementById('filterDrawerOverlay');
  drawer.classList.add('open');
  overlay.classList.add('open');
  document.body.style.overflow = 'hidden';
  // Populate agent dropdown
  const agentSelect = document.getElementById('filterAgent');
  if (agentSelect && agentSelect.options.length <= 1 && siteAgents.length > 0) {
    siteAgents.forEach(a => {
      const opt = document.createElement('option');
      opt.value = a.userId;
      opt.textContent = a.name || a.email;
      agentSelect.appendChild(opt);
    });
  }
}

function closeFilterDrawer() {
  const drawer = document.getElementById('filterDrawer');
  const overlay = document.getElementById('filterDrawerOverlay');
  drawer.classList.remove('open');
  overlay.classList.remove('open');
  document.body.style.overflow = '';
}

function toggleFilterChip(el) {
  el.classList.toggle('active');
}

function clearAllFilters() {
  document.querySelectorAll('.filter-chip.active').forEach(c => c.classList.remove('active'));
  document.getElementById('filterDateFrom').value = '';
  document.getElementById('filterDateTo').value = '';
  document.getElementById('filterAgent').value = '';
  document.getElementById('filterTags').value = '';
  document.getElementById('filterRatingMin').value = '';
  document.getElementById('filterRatingMax').value = '';
  document.getElementById('filterIntent').value = '';
  activeFilters = {};
  filterActive = false;
  currentFilterVids = null; // Clear stored filter results
  const badge = document.getElementById('filterBadge');
  badge.style.display = 'none';
  renderUsers();
}

function applyFilters() {
  activeFilters = {};
  let filterCount = 0;

  // Chip filters (multi-select per group - comma-separated values)
  ['status', 'priority', 'resolutionStatus', 'sentiment', 'urgency'].forEach(group => {
    const activeChips = document.querySelectorAll(`.filter-chip[data-filter="${group}"].active`);
    if (activeChips.length > 0) {
      const values = Array.from(activeChips).map(c => c.dataset.value);
      activeFilters[group] = values.join(',');
      filterCount++;
    }
  });

  // Date range
  const dateFrom = document.getElementById('filterDateFrom').value;
  const dateTo = document.getElementById('filterDateTo').value;
  if (dateFrom) { activeFilters.dateFrom = dateFrom; filterCount++; }
  if (dateTo) { activeFilters.dateTo = dateTo; filterCount++; }

  // Agent
  const agent = document.getElementById('filterAgent').value;
  if (agent) { activeFilters.assignedUserId = agent; filterCount++; }

  // Tags
  const tags = document.getElementById('filterTags').value.trim();
  if (tags) { activeFilters.tags = tags; filterCount++; }

  // Rating
  const ratingMin = document.getElementById('filterRatingMin').value;
  const ratingMax = document.getElementById('filterRatingMax').value;
  if (ratingMin) { activeFilters.ratingMin = parseInt(ratingMin); filterCount++; }
  if (ratingMax) { activeFilters.ratingMax = parseInt(ratingMax); filterCount++; }

  // Intent
  const intent = document.getElementById('filterIntent').value;
  if (intent) { activeFilters.intent = intent; filterCount++; }

  // Update badge
  const badge = document.getElementById('filterBadge');
  if (filterCount > 0) {
    badge.textContent = filterCount;
    badge.style.display = 'inline-flex';
    badge.setAttribute('data-tooltip', `${filterCount} active filter${filterCount > 1 ? 's' : ''}`);
    filterActive = true;
  } else {
    badge.style.display = 'none';
    filterActive = false;
  }

  closeFilterDrawer();
  loadFilteredConversations();
}

async function loadFilteredConversations() {
  if (!filterActive || Object.keys(activeFilters).length === 0) {
    console.log('[Filter] No active filters, showing all');
    renderUsers();
    return;
  }

  const params = new URLSearchParams();
  params.set('pageSize', '200');
  if (activeFilters.status) params.set('status', activeFilters.status);
  if (activeFilters.priority) params.set('priority', activeFilters.priority);
  if (activeFilters.assignedUserId) params.set('assignedUserId', activeFilters.assignedUserId);
  if (activeFilters.dateFrom) params.set('from', activeFilters.dateFrom);
  if (activeFilters.dateTo) params.set('to', activeFilters.dateTo);
  if (activeFilters.tags) params.set('tags', activeFilters.tags);
  if (activeFilters.ratingMin) params.set('ratingMin', activeFilters.ratingMin);
  if (activeFilters.ratingMax) params.set('ratingMax', activeFilters.ratingMax);
  if (activeFilters.resolutionStatus) params.set('resolutionStatus', activeFilters.resolutionStatus);
  if (activeFilters.sentiment) params.set('sentiment', activeFilters.sentiment);
  if (activeFilters.intent) params.set('intent', activeFilters.intent);
  if (activeFilters.urgency) {
    const urgencyMap = { low: 0.3, medium: 0.6, high: 0.8 };
    const maxMap = { low: 0.3, medium: 0.7, high: 1.0 };
    params.set('urgencyScoreMin', urgencyMap[activeFilters.urgency] || 0);
    params.set('urgencyScoreMax', maxMap[activeFilters.urgency] || 1.0);
  }

  try {
    const url = `${API_BASE}/sites/${siteId}/conversations?${params.toString()}`;
    console.log('[Filter] Fetching:', url);
    console.log('[Filter] Active filters:', activeFilters);
    const response = await fetch(url, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    if (!response.ok) {
      console.error('[Filter] API error:', response.status);
      return;
    }
    const result = await response.json();
    console.log('[Filter] API result:', result);
    if (!result.success) {
      console.error('[Filter] API returned success=false');
      return;
    }

    const items = result.data.items || [];
    const filterVids = new Set(items.map(c => c.visitorId));
    currentFilterVids = filterVids; // Store for subsequent renderUsers calls
    console.log('[Filter] Matching visitorIds:', filterVids.size, [...filterVids]);
    renderUsers(filterVids);
  } catch (err) {
    console.error("[Filter] Fetch error:", err);
  }
}

// ==================== WORKFLOW MANAGEMENT ====================

let workflows = [];
let editingWorkflowId = null;

function openWorkflowsModal() {
  document.getElementById('workflowsModal').style.display = 'flex';
  loadWorkflows();
}

function closeWorkflowsModal() {
  document.getElementById('workflowsModal').style.display = 'none';
  hideWorkflowEditor();
}

async function loadWorkflows() {
  try {
    const response = await fetch(`${API_BASE}/sites/${siteId}/workflows`, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    if (!response.ok) return;
    const result = await response.json();
    workflows = result.data || [];
    renderWorkflowsList();
  } catch (err) {
    console.error("Failed to load workflows:", err);
  }
}

function renderWorkflowsList() {
  const container = document.getElementById('workflowsList');
  if (workflows.length === 0) {
    container.innerHTML = '<div class="no-workflows">No workflows configured yet</div>';
    return;
  }

  container.innerHTML = workflows.map(wf => {
    const triggerLabels = {
      new_message: 'New Message',
      customer_join: 'Customer Join',
      conversation_idle: 'Idle',
      sentiment_change: 'Sentiment Change'
    };
    const condStr = wf.conditions.map(c => `${c.field} ${c.operator} ${c.value}`).join(', ');
    const actStr = wf.actions.map(a => `${a.type}: ${a.value}`).join(', ');

    return `
      <div class="workflow-card">
        <div class="workflow-card-header">
          <div class="workflow-card-title">${escapeHtml(wf.name)}</div>
          <div class="workflow-card-actions">
            <label class="workflow-toggle">
              <input type="checkbox" ${wf.isEnabled ? 'checked' : ''} onchange="toggleWorkflow('${wf.id}', this.checked)" />
              <span class="workflow-toggle-slider"></span>
            </label>
            <button class="workflow-edit-btn" onclick="showWorkflowEditor('${wf.id}')">Edit</button>
            <button class="workflow-delete-btn" onclick="deleteWorkflow('${wf.id}')">Del</button>
          </div>
        </div>
        <div class="workflow-card-body">
          <span class="workflow-trigger-badge">${triggerLabels[wf.triggerType] || wf.triggerType}</span>
          ${wf.description ? `<span class="workflow-desc">${escapeHtml(wf.description)}</span>` : ''}
          ${condStr ? `<div class="workflow-detail"><strong>If:</strong> ${escapeHtml(condStr)}</div>` : ''}
          ${actStr ? `<div class="workflow-detail"><strong>Then:</strong> ${escapeHtml(actStr)}</div>` : ''}
          <div class="workflow-meta">Priority: ${wf.priority} | Runs: ${wf.executionCount}</div>
        </div>
      </div>
    `;
  }).join('');
}

function showWorkflowEditor(workflowId) {
  document.getElementById('workflowListView').style.display = 'none';
  document.getElementById('workflowEditorView').style.display = 'block';

  if (workflowId) {
    editingWorkflowId = workflowId;
    const wf = workflows.find(w => w.id === workflowId);
    if (wf) {
      document.getElementById('workflowEditorTitle').textContent = 'Edit Workflow';
      document.getElementById('wfName').value = wf.name;
      document.getElementById('wfDescription').value = wf.description || '';
      document.getElementById('wfTrigger').value = wf.triggerType;
      document.getElementById('wfPriority').value = wf.priority;
      // Rebuild conditions
      document.getElementById('wfConditions').innerHTML = '';
      (wf.conditions || []).forEach(c => addConditionRow(c.field, c.operator, c.value));
      // Rebuild actions
      document.getElementById('wfActions').innerHTML = '';
      (wf.actions || []).forEach(a => addActionRow(a.type, a.value));
    }
  } else {
    editingWorkflowId = null;
    document.getElementById('workflowEditorTitle').textContent = 'New Workflow';
    document.getElementById('wfName').value = '';
    document.getElementById('wfDescription').value = '';
    document.getElementById('wfTrigger').value = 'new_message';
    document.getElementById('wfPriority').value = '0';
    document.getElementById('wfConditions').innerHTML = '';
    document.getElementById('wfActions').innerHTML = '';
  }
}

function hideWorkflowEditor() {
  document.getElementById('workflowListView').style.display = 'block';
  document.getElementById('workflowEditorView').style.display = 'none';
  editingWorkflowId = null;
}

function addConditionRow(field, operator, value) {
  const container = document.getElementById('wfConditions');
  const row = document.createElement('div');
  row.className = 'workflow-condition-row';
  row.innerHTML = `
    <select class="filter-select wf-cond-field">
      <option value="message_text" ${field === 'message_text' ? 'selected' : ''}>Message Text</option>
      <option value="sentiment" ${field === 'sentiment' ? 'selected' : ''}>Sentiment</option>
      <option value="intent" ${field === 'intent' ? 'selected' : ''}>Intent</option>
      <option value="urgency_score" ${field === 'urgency_score' ? 'selected' : ''}>Urgency Score</option>
      <option value="visitor_name" ${field === 'visitor_name' ? 'selected' : ''}>Visitor Name</option>
      <option value="visitor_email" ${field === 'visitor_email' ? 'selected' : ''}>Visitor Email</option>
      <option value="priority" ${field === 'priority' ? 'selected' : ''}>Priority</option>
      <option value="idle_minutes" ${field === 'idle_minutes' ? 'selected' : ''}>Idle Minutes</option>
    </select>
    <select class="filter-select wf-cond-op">
      <option value="contains" ${operator === 'contains' ? 'selected' : ''}>contains</option>
      <option value="equals" ${operator === 'equals' ? 'selected' : ''}>equals</option>
      <option value="not_equals" ${operator === 'not_equals' ? 'selected' : ''}>not equals</option>
      <option value="greater_than" ${operator === 'greater_than' ? 'selected' : ''}>greater than</option>
      <option value="less_than" ${operator === 'less_than' ? 'selected' : ''}>less than</option>
    </select>
    <input type="text" class="filter-input wf-cond-val" value="${escapeHtml(value || '')}" placeholder="Value" />
    <button class="workflow-remove-row" onclick="this.parentElement.remove()">x</button>
  `;
  container.appendChild(row);
}

function addActionRow(type, value) {
  const container = document.getElementById('wfActions');
  const row = document.createElement('div');
  row.className = 'workflow-action-row';
  row.innerHTML = `
    <select class="filter-select wf-act-type">
      <option value="assign_agent" ${type === 'assign_agent' ? 'selected' : ''}>Assign Agent</option>
      <option value="add_tag" ${type === 'add_tag' ? 'selected' : ''}>Add Tag</option>
      <option value="set_priority" ${type === 'set_priority' ? 'selected' : ''}>Set Priority</option>
      <option value="send_notification" ${type === 'send_notification' ? 'selected' : ''}>Send Notification</option>
      <option value="escalate" ${type === 'escalate' ? 'selected' : ''}>Escalate</option>
      <option value="auto_close" ${type === 'auto_close' ? 'selected' : ''}>Auto Close</option>
    </select>
    <input type="text" class="filter-input wf-act-val" value="${escapeHtml(value || '')}" placeholder="Value (e.g., round_robin, billing, high)" />
    <button class="workflow-remove-row" onclick="this.parentElement.remove()">x</button>
  `;
  container.appendChild(row);
}

async function saveWorkflow() {
  const name = document.getElementById('wfName').value.trim();
  if (!name) { showToast('Workflow name is required', 'error'); return; }

  const conditions = [];
  document.querySelectorAll('.workflow-condition-row').forEach(row => {
    conditions.push({
      field: row.querySelector('.wf-cond-field').value,
      operator: row.querySelector('.wf-cond-op').value,
      value: row.querySelector('.wf-cond-val').value
    });
  });

  const actions = [];
  document.querySelectorAll('.workflow-action-row').forEach(row => {
    actions.push({
      type: row.querySelector('.wf-act-type').value,
      value: row.querySelector('.wf-act-val').value
    });
  });

  const payload = {
    name,
    description: document.getElementById('wfDescription').value.trim() || null,
    triggerType: document.getElementById('wfTrigger').value,
    priority: parseInt(document.getElementById('wfPriority').value) || 0,
    conditions,
    actions,
    isEnabled: true
  };

  try {
    const method = editingWorkflowId ? 'PUT' : 'POST';
    const url = editingWorkflowId
      ? `${API_BASE}/sites/${siteId}/workflows/${editingWorkflowId}`
      : `${API_BASE}/sites/${siteId}/workflows`;

    const response = await fetch(url, {
      method,
      headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      showToast('Failed to save workflow', 'error');
      return;
    }

    showToast(editingWorkflowId ? 'Workflow updated' : 'Workflow created', 'success');
    hideWorkflowEditor();
    await loadWorkflows();
    // Notify Python server to reload workflows
    ws.send(JSON.stringify({ type: 'reload_workflows' }));
  } catch (err) {
    console.error("Save workflow error:", err);
    showToast('Error saving workflow', 'error');
  }
}

async function toggleWorkflow(workflowId, enabled) {
  try {
    await fetch(`${API_BASE}/sites/${siteId}/workflows/${workflowId}`, {
      method: 'PUT',
      headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
      body: JSON.stringify({ isEnabled: enabled })
    });
    ws.send(JSON.stringify({ type: 'reload_workflows' }));
  } catch (err) {
    console.error("Toggle workflow error:", err);
  }
}

async function deleteWorkflow(workflowId) {
  if (!confirm('Delete this workflow?')) return;
  try {
    await fetch(`${API_BASE}/sites/${siteId}/workflows/${workflowId}`, {
      method: 'DELETE',
      headers: { "Authorization": `Bearer ${token}` }
    });
    showToast('Workflow deleted', 'success');
    await loadWorkflows();
    ws.send(JSON.stringify({ type: 'reload_workflows' }));
  } catch (err) {
    console.error("Delete workflow error:", err);
  }
}

// Export functions
window.openAgentChat = openAgentChat;
window.closeAgentChat = closeAgentChat;
window.sendAgentMessage = sendAgentMessage;
window.toggleAgentsPanel = toggleAgentsPanel;
window.toggleAgentsSectionCollapse = toggleAgentsSectionCollapse;
window.addComment = addComment;
window.handleCommentInput = handleCommentInput;
window.selectMention = selectMention;
window.openSupervisorModal = openSupervisorModal;
window.closeSupervisorModal = closeSupervisorModal;
window.loadSupervisorData = loadSupervisorData;
window.viewConversationAsSupervisor = viewConversationAsSupervisor;
window.toggleFilterPanel = toggleFilterPanel;
window.openFilterDrawer = openFilterDrawer;
window.closeFilterDrawer = closeFilterDrawer;
window.toggleFilterChip = toggleFilterChip;
window.clearAllFilters = clearAllFilters;
window.applyFilters = applyFilters;
// ==================== KEYBOARD SHORTCUTS (Feature 13) ====================
function openShortcutsModal() {
  document.getElementById('shortcutsModal').style.display = 'flex';
}

function closeShortcutsModal() {
  document.getElementById('shortcutsModal').style.display = 'none';
}

document.addEventListener('keydown', (e) => {
  // Don't trigger shortcuts when typing in inputs/textareas
  const tag = document.activeElement?.tagName;
  const isInput = tag === 'INPUT' || tag === 'TEXTAREA' || document.activeElement?.isContentEditable;

  // Ctrl+K: Focus search
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
    e.preventDefault();
    const searchInput = document.getElementById('searchInput');
    if (searchInput) searchInput.focus();
    return;
  }

  // Ctrl+Enter: Send message
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    e.preventDefault();
    if (typeof send === 'function') send();
    return;
  }

  // Escape: Close modals/panels
  if (e.key === 'Escape') {
    const shortcutsModal = document.getElementById('shortcutsModal');
    if (shortcutsModal && shortcutsModal.style.display !== 'none') {
      closeShortcutsModal();
      return;
    }
    const settingsModal = document.getElementById('settingsModal');
    if (settingsModal && settingsModal.style.display !== 'none') {
      closeSettingsModal();
      return;
    }
    const transferModal = document.getElementById('transferModal');
    if (transferModal && transferModal.style.display !== 'none') {
      closeTransferModal();
      return;
    }
    const searchBar = document.getElementById('messageSearchBar');
    if (searchBar && searchBar.style.display !== 'none') {
      closeMessageSearch();
      return;
    }
    if (emojiPicker && emojiPicker.classList.contains('show')) {
      emojiPicker.classList.remove('show');
      return;
    }
    return;
  }

  // ? : Show shortcuts help (only when not in input)
  if (e.key === '?' && !isInput) {
    e.preventDefault();
    openShortcutsModal();
    return;
  }
});

// ==================== NOTIFICATION SOUND (Feature 15) ====================
let isTabFocused = true;
let notificationSoundMuted = localStorage.getItem('notificationSoundMuted') === 'true';

document.addEventListener('visibilitychange', () => {
  isTabFocused = !document.hidden;
});

function playNotificationSound() {
  if (notificationSoundMuted || isTabFocused) return;
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.frequency.setValueAtTime(880, ctx.currentTime);
    osc.frequency.setValueAtTime(660, ctx.currentTime + 0.1);
    gain.gain.setValueAtTime(0.3, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.3);
  } catch (e) {
    console.warn('Could not play notification sound:', e);
  }
}

function toggleNotificationSound() {
  notificationSoundMuted = !notificationSoundMuted;
  localStorage.setItem('notificationSoundMuted', notificationSoundMuted);
  showToast(notificationSoundMuted ? 'Notification sound muted' : 'Notification sound enabled', 'info');
  // Re-render settings if open
  const settingsBody = document.getElementById('settingsModalBody');
  if (settingsBody && settingsBody.innerHTML.includes('notification-toggle')) {
    renderThemeSettings();
  }
}

// ==================== ENHANCED SETTINGS (Features 6, 15) ====================
const _originalRenderThemeSettings = renderThemeSettings;

// Override renderThemeSettings to add notification setting
renderThemeSettings = function() {
  _originalRenderThemeSettings();
  const body = document.getElementById('settingsModalBody');
  if (!body) return;

  // Add notification sound toggle section
  const notifSection = document.createElement('div');
  notifSection.className = 'settings-section';
  notifSection.innerHTML = `
    <h3>
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
      </svg>
      Notifications
    </h3>
    <div class="notification-toggle">
      <span class="toggle-label">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${notificationSoundMuted ? 'M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2' : 'M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z'}" />
        </svg>
        Notification Sound
      </span>
      <label class="toggle-switch">
        <input type="checkbox" ${!notificationSoundMuted ? 'checked' : ''} onchange="toggleNotificationSound()">
        <span class="toggle-slider"></span>
      </label>
    </div>
  `;

  // Insert before the About section
  const aboutSection = body.querySelector('.settings-section:last-child');
  if (aboutSection) {
    body.insertBefore(notifSection, aboutSection);
  } else {
    body.appendChild(notifSection);
  }
};

// ==================== TOOLTIP DYNAMIC UPDATES (Feature 4) ====================
// Update tooltip text when conversation count changes
const _origRenderUsers = typeof renderUsers === 'function' ? renderUsers : null;

// ==================== GLOBAL FUNCTION EXPORTS ====================
window.openShortcutsModal = openShortcutsModal;
window.closeShortcutsModal = closeShortcutsModal;
window.toggleNotificationSound = toggleNotificationSound;
window.playNotificationSound = playNotificationSound;
window.retryLoadMessages = retryLoadMessages;
window.retryLoadTransferAgents = retryLoadTransferAgents;
window.renderTransferAgentsList = renderTransferAgentsList;
window.addQuickReply = addQuickReply;
window.deleteQuickReply = deleteQuickReply;
window.renderQuickReplies = renderQuickReplies;

window.openWorkflowsModal = openWorkflowsModal;
window.closeWorkflowsModal = closeWorkflowsModal;
window.showWorkflowEditor = showWorkflowEditor;
window.hideWorkflowEditor = hideWorkflowEditor;
window.saveWorkflow = saveWorkflow;
window.toggleWorkflow = toggleWorkflow;
window.deleteWorkflow = deleteWorkflow;
window.addConditionRow = addConditionRow;
window.addActionRow = addActionRow;
window.toggleConvActionsMenu = toggleConvActionsMenu;
window.setConversationPriority = setConversationPriority;
window.addConversationTag = addConversationTag;
window.removeConversationTag = removeConversationTag;
window.reopenConversation = reopenConversation;
</script>

</body>
</html>
