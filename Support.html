<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assistica AI - Support</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="Support.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="topbar-left">
    <div class="topbar-logo" data-brand="icon">
      C
    </div>
    <div class="topbar-brand"><span data-brand="name">Assistica AI</span> <span>Support</span></div>
  </div>

  <div class="topbar-center">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
    </svg>
    <input type="text" placeholder="Search conversations..." id="searchInput" />
  </div>

  <div class="topbar-right">
    <button class="topbar-btn" title="Notifications">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
      </svg>
      <span class="badge"></span>
    </button>

    <button class="topbar-btn" title="Settings" onclick="openSettings()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    </button>

    <button class="topbar-btn" title="Help">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    </button>

    <div class="topbar-divider"></div>

    <div class="topbar-user-wrapper">
      <div class="topbar-user" onclick="toggleUserMenu()" id="userMenuTrigger">
        <div class="topbar-user-avatar" id="currentUserAvatar">A</div>
        <div class="topbar-user-info">
          <div class="topbar-user-name" id="currentUserName">Agent</div>
          <div class="topbar-user-role">Support Agent</div>
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: #64748b;" id="dropdownChevron">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>

      <div class="user-dropdown" id="userDropdown">
        <div class="dropdown-header">
          <div class="dropdown-header-info">
            <div class="dropdown-avatar" id="dropdownAvatar">A</div>
            <div>
              <div class="dropdown-name" id="dropdownName">Agent</div>
              <div class="dropdown-email" id="dropdownEmail">agent@example.com</div>
            </div>
          </div>
        </div>
        <div class="dropdown-menu">
          <button class="dropdown-item" onclick="openProfile()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            My Profile
          </button>
          <button class="dropdown-item" onclick="openSettings()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Settings
          </button>
          <div class="dropdown-divider"></div>
          <button class="dropdown-item logout" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
            Logout
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MAIN LAYOUT -->
<div class="main-layout">

<!-- LEFT SIDEBAR -->
<div class="sidebar">
  <div class="sidebar-header">
    <h2>Conversations</h2>
    <span class="conversation-count" id="conversationCount">0</span>
  </div>
  <div class="users-list" id="usersList">
    <div class="no-users">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" />
      </svg>
      <p>No active conversations</p>
    </div>
  </div>
</div>

<!-- MAIN CONTENT -->
<div class="main-content">

  <!-- CHAT PANEL -->
  <div class="chat-panel" id="chatPanel">
    <div class="no-chat-selected" id="noChatSelected">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
      </svg>
      <h3>Select a conversation</h3>
      <p>Choose a customer from the list to start chatting</p>
    </div>

    <div class="chat-header" id="chatHeader" style="display: none;">
      <div class="chat-header-avatar" id="chatHeaderAvatar">J</div>
      <div class="chat-header-info">
        <h3 id="chatHeaderName">John Doe</h3>
        <p id="chatHeaderStatus">Online</p>
      </div>
      <div class="chat-header-actions">
        <div class="visitor-email-badge" id="visitorEmailBadge" style="display: none;">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
          <span id="visitorEmailText"></span>
        </div>
        <button class="btn-send-email" id="btnSendEmail" style="display: none;" title="Send Email">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
          Send Email
        </button>
      </div>
    </div>

    <div class="messages-container" id="messagesContainer" style="display: none;"></div>

    <div class="chat-input-area" id="chatInputArea" style="display: none; position: relative;">
      <div class="emoji-picker" id="emojiPicker">
        <div class="emoji-search">
          <input type="text" id="emojiSearch" placeholder="Search emojis..." />
        </div>
        <div class="emoji-categories" id="emojiCategories"></div>
        <div class="emoji-grid" id="emojiGrid"></div>
      </div>

      <div id="filePreviewArea"></div>
      <div class="chat-input-wrapper">
        <textarea id="messageInput" placeholder="Type a message..." rows="1"></textarea>
        <div class="input-actions">
          <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx,.txt,.zip" style="display: none;" />
          <button class="btn-attach" id="btnAttach" title="Attach file">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
            </svg>
          </button>
          <button class="btn-emoji" id="btnEmoji" title="Emoji">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </button>
          <button class="btn-send" id="btnSend" title="Send">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div class="image-modal" id="imageModal">
    <button class="image-modal-close" onclick="closeImageModal()">&times;</button>
    <img id="modalImage" src="" alt="Full size image" />
  </div>

  <!-- ANALYSIS PANEL -->
  <div class="analysis-panel">
    <div class="analysis-header">
      <h3>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
        </svg>
        AI Analysis
      </h3>
    </div>
    <div class="analysis-toggles">
      <div class="toggle-container" id="analysisToggleContainer">
        <span class="toggle-label">
          Enable AI Analysis
          <span class="usage-indicator" id="analysisUsageIndicator"></span>
        </span>
        <span id="analysisPremiumBadge" style="display: none;"></span>
        <label class="toggle-switch">
          <input type="checkbox" id="toggleAnalysis" onchange="onAnalysisToggle(this.checked)">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="toggle-container" id="autoReplyToggleContainer">
        <span class="toggle-label">
          Auto Reply
          <span class="usage-indicator" id="autoReplyUsageIndicator"></span>
        </span>
        <span id="autoReplyPremiumBadge" style="display: none;"></span>
        <label class="toggle-switch">
          <input type="checkbox" id="toggleAutoReply" onchange="onAutoReplyToggle(this.checked)">
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>
    <div class="analysis-content" id="analysisContent">
      <div class="analysis-empty">
        <p>Enable AI Analysis to see insights</p>
      </div>
    </div>
  </div>

</div>

</div> <!-- Close main-layout -->

<!-- Settings Modal -->
<div id="settingsModal" class="settings-modal-overlay" style="display: none;" onclick="if(event.target === this) closeSettingsModal()">
  <div class="settings-modal">
    <div class="settings-modal-header">
      <h2>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        Settings
      </h2>
      <button class="settings-modal-close" onclick="closeSettingsModal()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="settings-modal-body" id="settingsModalBody">
      <!-- Theme content will be rendered here -->
    </div>
  </div>
</div>

<!-- Upgrade Modal -->
<div id="upgradeModal" class="upgrade-modal-overlay" onclick="if(event.target === this) closeUpgradeModal()">
  <div class="upgrade-modal">
    <div class="upgrade-modal-header">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
      </svg>
      <h2 id="upgradeModalTitle">Upgrade Required</h2>
      <p id="upgradeModalSubtitle">This feature requires a plan upgrade</p>
    </div>
    <div class="upgrade-modal-body">
      <div class="upgrade-feature-info" id="upgradeFeatureInfo">
        <h3>
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
          <span id="upgradeFeatureName">AI Analysis</span>
        </h3>
        <p id="upgradeFeatureDesc">Get real-time insights about customer sentiment, buying intent, and recommended responses.</p>
      </div>
      <div class="upgrade-usage-status" id="upgradeUsageStatus" style="display: none;">
        <span class="label">Current Usage</span>
        <span class="value" id="upgradeUsageValue">0 / 0</span>
      </div>

      <!-- Contact Admin Message -->
      <div class="upgrade-contact-admin">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <p>Please contact your <strong>Site Administrator</strong> to upgrade your plan and unlock this feature.</p>
      </div>

      <div class="upgrade-modal-actions">
        <button class="btn-upgrade" onclick="closeUpgradeModal()" style="width: 100%;">
          <span style="display: flex; align-items: center; justify-content: center; gap: 6px;">
            Got it
          </span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Email Compose Modal -->
<div id="emailModal" class="email-modal-overlay" style="display: none;" onclick="if(event.target === this) closeEmailModal()">
  <div class="email-modal">
    <div class="email-modal-header">
      <h3>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
        </svg>
        Send Email
      </h3>
      <button class="email-modal-close" onclick="closeEmailModal()">&times;</button>
    </div>
    <div class="email-modal-body">
      <div class="email-form-group">
        <label>To</label>
        <input type="email" id="emailTo" readonly />
      </div>
      <div class="email-form-group">
        <label>Subject</label>
        <input type="text" id="emailSubject" placeholder="Enter subject..." />
      </div>
      <div class="email-form-group">
        <label>Message</label>
        <textarea id="emailBody" rows="8" placeholder="Write your message..."></textarea>
      </div>
    </div>
    <div class="email-modal-footer">
      <button class="btn-cancel" onclick="closeEmailModal()">Cancel</button>
      <button class="btn-send" id="btnSendEmailSubmit" onclick="sendEmail()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
        </svg>
        Send Email
      </button>
    </div>
  </div>
</div>

<script src="/config.js"></script>
<script src="/branding.js"></script>
<script>
// ==================== CONFIG ====================
const params = new URLSearchParams(window.location.search);
const siteId = params.get("siteId");
const token = params.get("token");

if (!siteId || !token) {
  alert("Unauthorized");
  location.href = "/login";
  throw new Error("Missing auth");
}

// Get username from token (we'll update this when connected)
let currentUsername = "Agent";

// ==================== STATE ====================
let currentVisitor = null;
let loggedOut = false;
let pendingFile = null;
let analysisEnabled = false;  // Toggle 1: AI Analysis (default OFF)
let autoReplyEnabled = false; // Toggle 2: Auto Reply (default OFF)
const users = {}; // visitorId -> { name, messages: [], typing: false, unread: 0, lastActivity: Date, analysis: null }

// Plan/Subscription state
let sitePlan = null;
let siteUsage = [];
let aiAnalysisAvailable = false;
let aiAutoReplyAvailable = false;
let aiAnalysisLimitExhausted = false;
let aiAutoReplyLimitExhausted = false;

// ==================== WEBSOCKET ====================
const wsProtocol = location.protocol === "https:" ? "wss:" : "ws:";
const ws = new WebSocket(`${wsProtocol}//${location.host}/ws?siteId=${siteId}&role=support&token=${token}`);

ws.onopen = () => {
  console.log("Connected to support WebSocket");
  console.log("Triggering loadHistoricalConversations...");
  loadHistoricalConversations();
};

ws.onmessage = (e) => {
  if (loggedOut) return;
  const data = JSON.parse(e.data);

  // New visitor joined
  if (data.type === "user_joined") {
    const vid = data.visitorId;
    if (!users[vid]) {
      users[vid] = {
        name: data.name,
        email: data.email,
        conversationId: data.conversationId,
        messages: [],
        typing: false,
        unread: 0,
        lastActivity: new Date(),
        analysis: null,
        isOnline: true
      };
    } else {
      // User exists from historical data, update online status
      users[vid].isOnline = true;
      users[vid].lastActivity = new Date();
      if (data.conversationId) users[vid].conversationId = data.conversationId;
      if (data.email) users[vid].email = data.email;
    }
    renderUsers();
    if (!currentVisitor) selectUser(vid);
  }

  // Visitor left
  if (data.type === "user_left") {
    if (users[data.visitorId]) {
      users[data.visitorId].isOnline = false;
      renderUsers();
      // Update header status if this is current conversation
      if (currentVisitor === data.visitorId) {
        const statusEl = document.getElementById("chatHeaderStatus");
        if (statusEl) {
          statusEl.textContent = "Offline";
          statusEl.style.color = "#94a3b8";
        }
      }
    }
  }

  // Typing indicators
  if (data.type === "typing_start") {
    if (users[data.visitorId]) {
      users[data.visitorId].typing = true;
      renderUsers();
      if (currentVisitor === data.visitorId) showTypingIndicator();
    }
  }

  if (data.type === "typing_stop") {
    if (users[data.visitorId]) {
      users[data.visitorId].typing = false;
      renderUsers();
      if (currentVisitor === data.visitorId) hideTypingIndicator();
    }
  }

  // Customer message
  if (data.type === "message") {
    const vid = data.from;
    if (!users[vid]) {
      users[vid] = {
        name: data.name || vid,
        messages: [],
        typing: false,
        unread: 0,
        lastActivity: new Date(),
        analysis: null,
        conversationId: data.conversationId || null
      };
    }

    // Update conversationId if provided
    if (data.conversationId) {
      users[vid].conversationId = data.conversationId;
    }

    const msgObj = {
      from: "customer",
      text: data.message,
      time: new Date()
    };

    if (data.file) {
      msgObj.file = data.file;
    }

    users[vid].messages.push(msgObj);
    users[vid].lastActivity = new Date();
    users[vid].typing = false;

    if (vid !== currentVisitor) {
      users[vid].unread++;
    }

    renderUsers();

    if (vid === currentVisitor) {
      renderMessages();
      hideTypingIndicator();
    }

    // Note: Don't call analyzeConversation here - Python server already sends analysis via WebSocket
    // The analysis will arrive via data.type === "analysis" message
  }

  // AI analysis (only store/display if enabled) - received from Python WebSocket
  if (data.type === "analysis") {
    if (users[data.from]) {
      users[data.from].analysis = data.analysis;
      if (currentVisitor === data.from && analysisEnabled) {
        renderAnalysis(data.analysis);
      }
    }
  }

  // Auto-reply sent notification
  if (data.type === "auto_reply_sent") {
    const vid = data.to;
    if (users[vid]) {
      // Add auto-reply to messages
      users[vid].messages.push({
        from: "support",
        text: data.message,
        time: new Date(),
        isAutoReply: true
      });
      users[vid].lastActivity = new Date();

      // Update UI if this is the current conversation
      if (currentVisitor === vid) {
        renderMessages();
      }
      renderUsers();

      // Show toast notification
      showToast(`Auto-replied to ${users[vid].name}`, "success");
    }
  }

  // AI usage update - real-time usage tracking
  if (data.type === "ai_usage_update") {
    updateAiUsageDisplay(data.feature, data.used, data.limit);
  }

  // AI limit reached notification
  if (data.type === "ai_limit_reached") {
    handleAiLimitReached(data.feature, data.message, data.used, data.limit);
  }

  // Welcome message sent notification
  if (data.type === "welcome_sent") {
    const vid = data.visitorId;
    if (users[vid]) {
      // Add welcome message to conversation
      users[vid].messages.push({
        from: "support",
        text: data.message,
        time: new Date(),
        isWelcome: true
      });

      // Update UI if this is the current conversation
      if (currentVisitor === vid) {
        renderMessages();
      }
    }
  }
};

ws.onclose = () => {
  if (!loggedOut) {
    console.log("WebSocket closed");
  }
};

// ==================== LOAD HISTORICAL DATA ====================
const API_BASE = CONFIG.API_BASE;

async function loadHistoricalConversations() {
  console.log("Loading historical conversations...");
  console.log("API_BASE:", API_BASE);
  console.log("siteId:", siteId);
  console.log("token:", token ? token.substring(0, 50) + "..." : "null");

  try {
    const url = `${API_BASE}/sites/${siteId}/conversations`;
    console.log("Fetching:", url);

    const response = await fetch(url, {
      headers: { "Authorization": `Bearer ${token}` }
    });

    console.log("Response status:", response.status);

    if (!response.ok) {
      const errorText = await response.text();
      console.error("API error:", response.status, errorText);
      return;
    }

    const result = await response.json();
    console.log("API result:", result);

    if (!result.success) {
      console.error("API returned failure:", result);
      return;
    }

    const conversations = result.data.items || [];
    console.log("Found", conversations.length, "conversations");

    for (const conv of conversations) {
      const vid = conv.visitorId;
      console.log("Adding conversation:", conv.visitorName, "vid:", vid);
      if (!users[vid]) {
        users[vid] = {
          name: conv.visitorName || "Visitor",
          email: conv.visitorEmail,
          conversationId: conv.id,
          messages: [],
          typing: false,
          unread: conv.unreadCount || 0,
          lastActivity: new Date(conv.lastMessageAt || conv.createdAt),
          lastMessagePreview: conv.lastMessagePreview,
          analysis: null,
          isOnline: false
        };
      } else {
        // Merge historical data into existing user (e.g., from WebSocket user_joined)
        if (!users[vid].conversationId) {
          users[vid].conversationId = conv.id;
        }
        if (!users[vid].email) {
          users[vid].email = conv.visitorEmail;
        }
        users[vid].lastMessagePreview = users[vid].lastMessagePreview || conv.lastMessagePreview;
        users[vid].unread = users[vid].unread || conv.unreadCount || 0;

        // If this is the currently selected user and messages weren't loaded yet, load them now
        if (currentVisitor === vid && !users[vid].messagesLoaded && users[vid].conversationId) {
          loadConversationMessages(vid);
        }
      }
    }

    console.log("Users after loading:", Object.keys(users).length);
    renderUsers();

    // Auto-select first conversation if any
    const firstVid = Object.keys(users)[0];
    if (firstVid && !currentVisitor) {
      console.log("Auto-selecting first user:", firstVid);
      selectUser(firstVid);
    }
  } catch (err) {
    console.error("Failed to load conversations:", err);
  }
}

async function loadConversationMessages(visitorId) {
  const user = users[visitorId];
  console.log("Loading messages for visitor:", visitorId, "conversationId:", user?.conversationId);

  if (!user || !user.conversationId) {
    console.log("No user or conversation ID found");
    return;
  }

  // Skip if already loaded
  if (user.messagesLoaded) {
    console.log("Messages already loaded");
    return;
  }

  try {
    const url = `${API_BASE}/conversations/${user.conversationId}/messages`;
    console.log("Fetching messages from:", url);

    const response = await fetch(url, {
      headers: { "Authorization": `Bearer ${token}` }
    });

    console.log("Messages response status:", response.status);

    if (!response.ok) {
      const errorText = await response.text();
      console.error("Messages API error:", response.status, errorText);
      return;
    }

    const result = await response.json();
    console.log("Messages result:", result);

    if (!result.success) {
      console.error("Messages API returned failure:", result);
      return;
    }

    const messages = result.data.items || [];
    console.log("Found", messages.length, "messages");

    // Convert API messages to local format
    user.messages = messages.map(m => ({
      from: m.senderType === "visitor" ? "customer" : "support",
      text: m.content,
      time: new Date(m.createdAt),
      file: m.file ? {
        url: `${location.origin}${m.file.url}`,
        original_name: m.file.originalName,
        is_image: m.file.mimeType?.startsWith("image/"),
        size: m.file.fileSize
      } : null
    }));

    user.messagesLoaded = true;

    if (currentVisitor === visitorId) {
      renderMessages();
    }
  } catch (err) {
    console.error("Failed to load messages:", err);
  }
}

// Historical data is loaded in ws.onopen handler above

// ==================== DOM ELEMENTS ====================
const usersList = document.getElementById("usersList");
const chatHeader = document.getElementById("chatHeader");
const chatHeaderAvatar = document.getElementById("chatHeaderAvatar");
const chatHeaderName = document.getElementById("chatHeaderName");
const messagesContainer = document.getElementById("messagesContainer");
const chatInputArea = document.getElementById("chatInputArea");
const noChatSelected = document.getElementById("noChatSelected");
const messageInput = document.getElementById("messageInput");
const analysisContent = document.getElementById("analysisContent");
const emojiPicker = document.getElementById("emojiPicker");

// ==================== RENDER FUNCTIONS ====================
function renderUsers() {
  // Update conversation count
  const count = Object.keys(users).length;
  document.getElementById("conversationCount").textContent = count;

  if (count === 0) {
    usersList.innerHTML = `
      <div class="no-users">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" />
        </svg>
        <p>No active conversations</p>
      </div>
    `;
    return;
  }

  usersList.innerHTML = Object.entries(users)
    .sort((a, b) => b[1].lastActivity - a[1].lastActivity)
    .map(([vid, user]) => {
      const initials = getInitials(user.name);
      const lastMsg = user.messages[user.messages.length - 1];

      // Better preview logic
      let preview;
      if (user.typing) {
        preview = "typing...";
      } else if (lastMsg && lastMsg.text) {
        const prefix = lastMsg.from === "support" ? "You: " : "";
        preview = prefix + truncate(lastMsg.text, 25);
      } else if (user.lastMessagePreview) {
        preview = truncate(user.lastMessagePreview, 25);
      } else {
        preview = user.isOnline ? "Online now" : "No messages";
      }

      const timeStr = formatTime(user.lastActivity);

      return `
        <div class="user-item ${vid === currentVisitor ? 'active' : ''}" onclick="selectUser('${vid}')">
          <div class="user-avatar">
            ${initials}
            ${user.isOnline ? '<span class="status-dot"></span>' : '<span class="status-dot" style="background:#94a3b8;"></span>'}
          </div>
          <div class="user-info">
            <div class="user-name">${escapeHtml(user.name)}</div>
            <div class="user-preview ${user.typing ? 'typing' : ''}">${escapeHtml(preview)}</div>
          </div>
          <div class="user-meta">
            <span class="user-time">${timeStr}</span>
            ${user.unread > 0 ? `<span class="unread-badge">${user.unread}</span>` : ''}
          </div>
          <button class="btn-delete-conv" onclick="event.stopPropagation(); deleteConversation('${vid}')" title="Delete conversation">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
        </div>
      `;
    }).join('');
}

function selectUser(vid) {
  currentVisitor = vid;
  users[vid].unread = 0;

  // Show chat UI
  noChatSelected.style.display = "none";
  chatHeader.style.display = "flex";
  messagesContainer.style.display = "flex";
  chatInputArea.style.display = "block";

  // Update header
  chatHeaderAvatar.textContent = getInitials(users[vid].name);
  chatHeaderName.textContent = users[vid].name;

  // Update email badge and Send Email button
  const email = users[vid].email || "";
  const emailBadge = document.getElementById("visitorEmailBadge");
  const emailText = document.getElementById("visitorEmailText");
  const btnSendEmail = document.getElementById("btnSendEmail");

  if (email) {
    emailBadge.style.display = "flex";
    emailText.textContent = email;
    btnSendEmail.style.display = "flex";
  } else {
    emailBadge.style.display = "none";
    btnSendEmail.style.display = "none";
  }

  // Update online status
  const statusEl = document.getElementById("chatHeaderStatus");
  if (statusEl) {
    statusEl.textContent = users[vid].isOnline ? "Online" : "Offline";
    statusEl.style.color = users[vid].isOnline ? "#22c55e" : "#94a3b8";
  }

  renderUsers();

  // Load messages from API if not already loaded
  if (!users[vid].messagesLoaded && users[vid].conversationId) {
    messagesContainer.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">Loading messages...</div>';
    loadConversationMessages(vid);
  } else {
    renderMessages();
  }

  if (analysisEnabled) {
    if (users[vid].analysis) {
      renderAnalysis(users[vid].analysis);
    } else {
      analysisContent.innerHTML = '<div class="analysis-empty"><p>Waiting for customer message to analyze...</p></div>';
    }
  } else {
    analysisContent.innerHTML = '<div class="analysis-empty"><p>Enable AI Analysis to see insights</p></div>';
  }

  messageInput.focus();
}

function showNoChat() {
  noChatSelected.style.display = "flex";
  chatHeader.style.display = "none";
  messagesContainer.style.display = "none";
  chatInputArea.style.display = "none";
  analysisContent.innerHTML = '<div class="analysis-empty"><p>Select a conversation to see AI-powered insights</p></div>';
}

async function deleteConversation(vid) {
  const user = users[vid];
  if (!user) return;

  const result = await Swal.fire({
    title: 'Delete Conversation?',
    text: `Are you sure you want to delete the conversation with ${user.name}? This action cannot be undone.`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#ef4444',
    cancelButtonColor: '#64748b',
    confirmButtonText: 'Yes, delete it',
    cancelButtonText: 'Cancel'
  });

  if (!result.isConfirmed) return;

  try {
    const conversationId = user.conversationId;
    if (!conversationId) {
      // No conversation ID means it's a live session without DB record
      delete users[vid];
      if (currentVisitor === vid) {
        currentVisitor = null;
        showNoChat();
      }
      renderUsers();
      return;
    }

    const response = await fetch(`${API_BASE}/sites/${siteId}/conversations/${conversationId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (response.ok) {
      delete users[vid];
      if (currentVisitor === vid) {
        currentVisitor = null;
        showNoChat();
      }
      renderUsers();
      console.log('Conversation deleted successfully');
    } else {
      const error = await response.json();
      Swal.fire('Error', 'Failed to delete conversation: ' + (error.detail || 'Unknown error'), 'error');
    }
  } catch (error) {
    console.error('Error deleting conversation:', error);
    Swal.fire('Error', 'Failed to delete conversation', 'error');
  }
}

function renderMessages() {
  if (!currentVisitor || !users[currentVisitor]) return;

  const msgs = users[currentVisitor].messages;
  messagesContainer.innerHTML = msgs.map(m => {
    let fileHtml = '';
    if (m.file) {
      if (m.file.is_image) {
        fileHtml = `
          <div class="message-file">
            <img class="message-image" src="${m.file.url}" alt="${escapeHtml(m.file.original_name)}" onclick="openImageModal('${m.file.url}')" />
          </div>
        `;
      } else {
        fileHtml = `
          <div class="message-file">
            <a class="file-attachment" href="${m.file.url}" download="${escapeHtml(m.file.original_name)}">
              <div class="file-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
              </div>
              <div class="file-info">
                <div class="file-name">${escapeHtml(m.file.original_name)}</div>
                <div class="file-size">${formatFileSize(m.file.size)}</div>
              </div>
            </a>
          </div>
        `;
      }
    }

    const autoReplyBadge = m.isAutoReply ? '<span class="auto-reply-badge">AUTO</span>' : '';
    const hasText = m.text && m.text.trim();
    const hasFile = m.file;

    // Skip empty messages
    if (!hasText && !hasFile) return '';

    return `
      <div class="message-wrapper ${m.from === 'customer' ? 'customer' : 'support'}">
        <div class="message-bubble ${!hasText && hasFile ? 'file-only' : ''}">
          ${hasText ? `<div class="message-text">${escapeHtml(m.text)}</div>` : ''}
          ${fileHtml}
        </div>
        <div class="message-time">${autoReplyBadge}${formatMessageTime(m.time)}</div>
      </div>
    `;
  }).join('');

  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showTypingIndicator() {
  const existing = document.getElementById("typingIndicator");
  if (existing) return;

  const div = document.createElement("div");
  div.id = "typingIndicator";
  div.className = "typing-indicator";
  div.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
  messagesContainer.appendChild(div);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideTypingIndicator() {
  const existing = document.getElementById("typingIndicator");
  if (existing) existing.remove();
}

function renderAnalysis(a) {
  if (!a) {
    analysisContent.innerHTML = '<div class="analysis-empty"><p>No analysis data available</p></div>';
    return;
  }

  console.log("Analysis data received:", a);

  // Handle both Python WebSocket format and .NET API format
  // Python format: interest_level, conversion_percentage, objection, next_action, suggested_reply
  // .NET API format: sentiment, sentimentScore, summary, suggestedResponses[], intent

  // Map sentiment to interest level if needed
  let interestLevel = a.interest_level || a.interestLevel;
  if (!interestLevel && a.sentiment) {
    // Map sentiment to interest level
    const sentimentMap = { 'positive': 'High', 'neutral': 'Medium', 'negative': 'Low' };
    interestLevel = sentimentMap[a.sentiment.toLowerCase()] || 'Medium';
  }
  interestLevel = interestLevel || 'Unknown';
  const interestClass = interestLevel.toLowerCase().replace(/\s+/g, '-');

  // Map sentiment score to conversion percentage if needed
  let conversionPercentage = a.conversion_percentage || a.conversionPercentage;
  if (conversionPercentage === undefined && a.sentimentScore !== undefined) {
    // Convert sentiment score (-1 to 1) to percentage (0-100)
    conversionPercentage = Math.round((a.sentimentScore + 1) * 50);
  }
  conversionPercentage = conversionPercentage || 50;

  // Use summary or intent as objection/context
  const objection = a.objection || a.objectionDetected || (a.intent ? `Intent: ${a.intent}` : 'None detected');

  // Use summary as next action if available
  const nextAction = a.next_action || a.nextAction || a.recommendedAction || a.summary || 'No recommendation';

  // Get suggested reply - handle both string and array formats
  let suggestedReply = a.suggested_reply || a.suggestedReply || '';
  if (!suggestedReply && a.suggestedResponses && a.suggestedResponses.length > 0) {
    suggestedReply = a.suggestedResponses[0];
  }

  analysisContent.innerHTML = `
    <div class="analysis-card">
      <div class="analysis-card-header">Interest Level</div>
      <div class="interest-badge ${interestClass}">${escapeHtml(interestLevel)}</div>
    </div>

    <div class="analysis-card">
      <div class="analysis-card-header">Conversion Probability</div>
      <div class="conversion-value">${conversionPercentage}%</div>
      <div class="conversion-bar">
        <div class="conversion-fill" style="width: ${conversionPercentage}%"></div>
      </div>
    </div>

    <div class="analysis-card">
      <div class="analysis-card-header">Objection Detected</div>
      <div class="analysis-card-value">${escapeHtml(objection)}</div>
    </div>

    <div class="analysis-card">
      <div class="analysis-card-header">Recommended Action</div>
      <div class="analysis-card-value">${escapeHtml(nextAction)}</div>
    </div>

    <div class="suggested-reply">
      <div class="suggested-reply-header">
        <span>Suggested Reply</span>
        <button class="btn-use-reply" onclick="useReply()">Use This</button>
      </div>
      <div class="suggested-reply-text">${escapeHtml(suggestedReply) || 'No suggestion available'}</div>
    </div>
  `;
}

// ==================== SEND MESSAGE ====================
async function send() {
  if (!currentVisitor) return;

  const text = messageInput.value.trim();
  if (!text && !pendingFile) return;

  // If there's a file, upload it first
  if (pendingFile) {
    const formData = new FormData();
    formData.append("file", pendingFile);
    formData.append("siteId", siteId);
    formData.append("token", token);

    try {
      const response = await fetch("/upload", {
        method: "POST",
        body: formData
      });

      if (!response.ok) {
        const error = await response.json();
        alert(error.detail || "Failed to upload file");
        return;
      }

      const fileData = await response.json();

      // Add message locally
      users[currentVisitor].messages.push({
        from: "support",
        text: text,
        file: fileData,
        time: new Date()
      });

      renderMessages();

      // Send via WebSocket
      ws.send(JSON.stringify({
        to: currentVisitor,
        message: text,
        file: fileData
      }));
    } catch (error) {
      alert("Failed to upload file");
      return;
    }

    // Clear pending file
    clearPendingFile();
  } else {
    // Text only message
    users[currentVisitor].messages.push({
      from: "support",
      text: text,
      time: new Date()
    });

    renderMessages();

    ws.send(JSON.stringify({
      to: currentVisitor,
      message: text
    }));
  }

  // Stop typing indicator
  ws.send(JSON.stringify({
    type: "support_typing_stop",
    to: currentVisitor
  }));

  messageInput.value = "";
  messageInput.style.height = "auto";
}

function useReply() {
  if (!currentVisitor || !users[currentVisitor].analysis) return;
  const a = users[currentVisitor].analysis;
  let suggestedReply = a.suggested_reply || a.suggestedReply || '';
  // Handle array format from .NET API
  if (!suggestedReply && a.suggestedResponses && a.suggestedResponses.length > 0) {
    suggestedReply = a.suggestedResponses[0];
  }
  if (suggestedReply) {
    messageInput.value = suggestedReply;
    messageInput.focus();
  }
}

// ==================== TYPING INDICATOR ====================
let typingTimeout = null;
let isTyping = false;

messageInput.addEventListener("input", () => {
  // Auto-resize textarea
  messageInput.style.height = "auto";
  messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + "px";

  // Send typing indicator
  if (!currentVisitor) return;

  if (!isTyping) {
    isTyping = true;
    ws.send(JSON.stringify({
      type: "support_typing",
      to: currentVisitor
    }));
  }

  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => {
    isTyping = false;
    ws.send(JSON.stringify({
      type: "support_typing_stop",
      to: currentVisitor
    }));
  }, 2000);
});

messageInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});

// ==================== EMOJI PICKER ====================
const EMOJI_DATA = {
  "Smileys": ["ðŸ˜€","ðŸ˜ƒ","ðŸ˜„","ðŸ˜","ðŸ˜…","ðŸ˜‚","ðŸ¤£","ðŸ˜Š","ðŸ˜‡","ðŸ™‚","ðŸ˜‰","ðŸ˜Œ","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ˜—","ðŸ˜™","ðŸ˜š","ðŸ˜‹","ðŸ˜›","ðŸ˜œ","ðŸ¤ª","ðŸ˜","ðŸ¤‘","ðŸ¤—","ðŸ¤­","ðŸ¤«","ðŸ¤”","ðŸ¤","ðŸ¤¨","ðŸ˜","ðŸ˜‘","ðŸ˜¶","ðŸ˜","ðŸ˜’","ðŸ™„","ðŸ˜¬","ðŸ˜®â€ðŸ’¨","ðŸ¤¥","ðŸ˜Œ","ðŸ˜”","ðŸ˜ª","ðŸ¤¤","ðŸ˜´","ðŸ˜·","ðŸ¤’","ðŸ¤•","ðŸ¤¢","ðŸ¤®","ðŸ¤§","ðŸ¥µ","ðŸ¥¶","ðŸ¥´","ðŸ˜µ","ðŸ¤¯","ðŸ¤ ","ðŸ¥³","ðŸ¥¸","ðŸ˜Ž","ðŸ¤“","ðŸ§"],
  "Gestures": ["ðŸ‘‹","ðŸ¤š","ðŸ–ï¸","âœ‹","ðŸ––","ðŸ‘Œ","ðŸ¤Œ","ðŸ¤","âœŒï¸","ðŸ¤ž","ðŸ¤Ÿ","ðŸ¤˜","ðŸ¤™","ðŸ‘ˆ","ðŸ‘‰","ðŸ‘†","ðŸ–•","ðŸ‘‡","â˜ï¸","ðŸ‘","ðŸ‘Ž","âœŠ","ðŸ‘Š","ðŸ¤›","ðŸ¤œ","ðŸ‘","ðŸ™Œ","ðŸ‘","ðŸ¤²","ðŸ¤","ðŸ™"],
  "Hearts": ["â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ–¤","ðŸ¤","ðŸ¤Ž","ðŸ’”","â¤ï¸â€ðŸ”¥","â¤ï¸â€ðŸ©¹","â£ï¸","ðŸ’•","ðŸ’ž","ðŸ’“","ðŸ’—","ðŸ’–","ðŸ’˜","ðŸ’"],
  "Objects": ["ðŸ’¼","ðŸ“","ðŸ“‚","ðŸ“…","ðŸ“†","ðŸ“Œ","ðŸ“","ðŸ“Ž","ðŸ”—","ðŸ“","âœï¸","ðŸ”","ðŸ”Ž","ðŸ”","ðŸ”’","ðŸ”“","ðŸ’¡","ðŸ“§","ðŸ“¨","ðŸ“©","ðŸ“¤","ðŸ“¥","ðŸ“¦","ðŸ·ï¸","ðŸ’°","ðŸ’³","ðŸŽ","ðŸŽ‰","ðŸŽŠ"],
  "Symbols": ["âœ…","âŒ","â“","â—","ðŸ’¯","ðŸ”¥","â­","ðŸ’«","âœ¨","ðŸŽ¯","ðŸ’¢","ðŸ’¬","ðŸ‘ï¸â€ðŸ—¨ï¸","ðŸ””","ðŸ”•","ðŸ“¢","ðŸ“£","â°","â±ï¸","â²ï¸","ðŸ”´","ðŸŸ ","ðŸŸ¡","ðŸŸ¢","ðŸ”µ","ðŸŸ£","âš«","âšª","ðŸŸ¤"]
};

let currentEmojiCategory = "Smileys";

function initEmojiPicker() {
  const categoriesDiv = document.getElementById("emojiCategories");
  const categoryIcons = {
    "Smileys": "ðŸ˜€",
    "Gestures": "ðŸ‘‹",
    "Hearts": "â¤ï¸",
    "Objects": "ðŸ’¼",
    "Symbols": "âœ…"
  };

  categoriesDiv.innerHTML = Object.keys(EMOJI_DATA).map(cat => `
    <button class="emoji-category-btn ${cat === currentEmojiCategory ? 'active' : ''}"
            onclick="selectEmojiCategory('${cat}')" title="${cat}">
      ${categoryIcons[cat]}
    </button>
  `).join('');

  renderEmojis();
}

function selectEmojiCategory(cat) {
  currentEmojiCategory = cat;
  document.querySelectorAll(".emoji-category-btn").forEach(btn => btn.classList.remove("active"));
  event.target.classList.add("active");
  renderEmojis();
}

function renderEmojis(filter = "") {
  const grid = document.getElementById("emojiGrid");
  let emojis = EMOJI_DATA[currentEmojiCategory];

  if (filter) {
    emojis = Object.values(EMOJI_DATA).flat().filter(e => e.includes(filter));
  }

  grid.innerHTML = emojis.map(e => `
    <span class="emoji-item" onclick="insertEmoji('${e}')">${e}</span>
  `).join('');
}

function insertEmoji(emoji) {
  const input = messageInput;
  const start = input.selectionStart;
  const end = input.selectionEnd;
  const text = input.value;

  input.value = text.substring(0, start) + emoji + text.substring(end);
  input.selectionStart = input.selectionEnd = start + emoji.length;
  input.focus();

  emojiPicker.classList.remove("show");
}

document.getElementById("btnEmoji").addEventListener("click", () => {
  emojiPicker.classList.toggle("show");
  if (emojiPicker.classList.contains("show")) {
    initEmojiPicker();
  }
});

document.getElementById("emojiSearch").addEventListener("input", (e) => {
  renderEmojis(e.target.value);
});

// Close emoji picker when clicking outside
document.addEventListener("click", (e) => {
  if (!emojiPicker.contains(e.target) && e.target.id !== "btnEmoji" && !e.target.closest("#btnEmoji")) {
    emojiPicker.classList.remove("show");
  }
});

document.getElementById("btnSend").addEventListener("click", send);

// ==================== FILE HANDLING ====================
const fileInput = document.getElementById("fileInput");
const filePreviewArea = document.getElementById("filePreviewArea");

document.getElementById("btnAttach").addEventListener("click", () => {
  fileInput.click();
});

fileInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  // Check file size (10MB limit)
  if (file.size > 10 * 1024 * 1024) {
    alert("File is too large. Maximum size is 10MB.");
    fileInput.value = "";
    return;
  }

  pendingFile = file;
  showFilePreview(file);
});

function showFilePreview(file) {
  const isImage = file.type.startsWith("image/");

  let previewHtml = `
    <div class="file-preview">
      ${isImage ? `<img src="${URL.createObjectURL(file)}" alt="Preview" />` : `
        <div class="file-preview-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg>
        </div>
      `}
      <div class="file-preview-info">
        <div class="file-preview-name">${escapeHtml(file.name)}</div>
        <div class="file-preview-size">${formatFileSize(file.size)}</div>
      </div>
      <button class="file-preview-remove" onclick="clearPendingFile()" title="Remove">&times;</button>
    </div>
  `;

  filePreviewArea.innerHTML = previewHtml;
}

function clearPendingFile() {
  pendingFile = null;
  fileInput.value = "";
  filePreviewArea.innerHTML = "";
}

function openImageModal(url) {
  const modal = document.getElementById("imageModal");
  const img = document.getElementById("modalImage");
  img.src = url;
  modal.classList.add("show");
}

function closeImageModal() {
  document.getElementById("imageModal").classList.remove("show");
}

// Close modal on background click
document.getElementById("imageModal").addEventListener("click", (e) => {
  if (e.target.id === "imageModal") {
    closeImageModal();
  }
});

function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + " B";
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
  return (bytes / (1024 * 1024)).toFixed(1) + " MB";
}

// ==================== UTILITIES ====================
function getInitials(name) {
  return name.split(" ").map(n => n[0]).join("").toUpperCase().substring(0, 2);
}

function truncate(str, len) {
  return str.length > len ? str.substring(0, len) + "..." : str;
}

function escapeHtml(text) {
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

function formatTime(date) {
  const now = new Date();
  const diff = now - date;

  if (diff < 60000) return "now";
  if (diff < 3600000) return Math.floor(diff / 60000) + "m";
  if (diff < 86400000) return Math.floor(diff / 3600000) + "h";
  return date.toLocaleDateString();
}

function formatMessageTime(date) {
  const now = new Date();
  const isToday = date.toDateString() === now.toDateString();
  const yesterday = new Date(now);
  yesterday.setDate(yesterday.getDate() - 1);
  const isYesterday = date.toDateString() === yesterday.toDateString();

  const time = date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });

  if (isToday) return time;
  if (isYesterday) return `Yesterday ${time}`;
  return date.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ` ${time}`;
}

function logout() {
  loggedOut = true;
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.close();
  }
  location.href = "/login";
}

window.addEventListener("beforeunload", () => {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.close();
  }
});

// ==================== TOPBAR FUNCTIONS ====================
function updateCurrentUser(username, email = null) {
  currentUsername = username;
  const initials = username.substring(0, 2).toUpperCase();
  const displayName = username.charAt(0).toUpperCase() + username.slice(1);

  document.getElementById("currentUserAvatar").textContent = initials;
  document.getElementById("currentUserName").textContent = displayName;
  document.getElementById("dropdownAvatar").textContent = initials;
  document.getElementById("dropdownName").textContent = displayName;
  document.getElementById("dropdownEmail").textContent = email || `${username}@support.com`;
}

let dropdownOpen = false;

function toggleUserMenu(event) {
  if (event) event.stopPropagation();

  const dropdown = document.getElementById("userDropdown");
  const chevron = document.getElementById("dropdownChevron");

  dropdownOpen = !dropdownOpen;

  if (dropdownOpen) {
    dropdown.classList.add("show");
    chevron.style.transform = "rotate(180deg)";
  } else {
    dropdown.classList.remove("show");
    chevron.style.transform = "rotate(0deg)";
  }
}

function closeUserMenu() {
  const dropdown = document.getElementById("userDropdown");
  const chevron = document.getElementById("dropdownChevron");

  dropdownOpen = false;
  dropdown.classList.remove("show");
  chevron.style.transform = "rotate(0deg)";
}

// Close dropdown when clicking outside
document.addEventListener("click", (e) => {
  const wrapper = document.querySelector(".topbar-user-wrapper");
  if (wrapper && !wrapper.contains(e.target)) {
    closeUserMenu();
  }
});

function openProfile() {
  closeUserMenu();
  // Use port 8000 for static HTML pages
  window.location.href = `http://${location.hostname}:8000/profile.html?siteId=${siteId}&token=${token}`;
}

// ==================== SETTINGS & THEMES ====================
const themes = [
  {
    id: 'light',
    name: 'Light',
    colors: { bg: '#f1f5f9', sidebar: '#ffffff', accent: '#2563eb', text: '#1e293b' }
  },
  {
    id: 'dark',
    name: 'Dark',
    colors: { bg: '#0f172a', sidebar: '#1e293b', accent: '#6366f1', text: '#e2e8f0' }
  },
  {
    id: 'ocean',
    name: 'Ocean Blue',
    colors: { bg: '#0c1929', sidebar: '#132f4c', accent: '#2196f3', text: '#e3f2fd' }
  },
  {
    id: 'forest',
    name: 'Forest Green',
    colors: { bg: '#0d1f12', sidebar: '#1a3a21', accent: '#4caf50', text: '#e8f5e9' }
  },
  {
    id: 'sunset',
    name: 'Sunset',
    colors: { bg: '#1a1a2e', sidebar: '#2d2d44', accent: '#ff6b6b', text: '#fce4ec' }
  },
  {
    id: 'midnight',
    name: 'Midnight Purple',
    colors: { bg: '#13111c', sidebar: '#1e1a2e', accent: '#a855f7', text: '#e9d5ff' }
  },
  {
    id: 'rose',
    name: 'Rose Gold',
    colors: { bg: '#1c1618', sidebar: '#2d2226', accent: '#f472b6', text: '#fce7f3' }
  },
  {
    id: 'cyber',
    name: 'Cyberpunk',
    colors: { bg: '#0a0a0f', sidebar: '#12121a', accent: '#00ff88', text: '#00ff88' }
  },
  {
    id: 'coffee',
    name: 'Coffee',
    colors: { bg: '#1a1614', sidebar: '#2d2520', accent: '#d97706', text: '#fef3c7' }
  },
  {
    id: 'nord',
    name: 'Nord',
    colors: { bg: '#2e3440', sidebar: '#3b4252', accent: '#88c0d0', text: '#eceff4' }
  },
  {
    id: 'dracula',
    name: 'Dracula',
    colors: { bg: '#282a36', sidebar: '#343746', accent: '#bd93f9', text: '#f8f8f2' }
  },
  {
    id: 'solarized',
    name: 'Solarized',
    colors: { bg: '#002b36', sidebar: '#073642', accent: '#2aa198', text: '#93a1a1' }
  },
  {
    id: 'monokai',
    name: 'Monokai',
    colors: { bg: '#272822', sidebar: '#3e3d32', accent: '#f92672', text: '#f8f8f2' }
  }
];

function getCurrentTheme() {
  return localStorage.getItem('supportDashboardTheme') || 'light';
}

function setTheme(themeId) {
  const theme = themes.find(t => t.id === themeId);
  if (!theme) return;

  if (themeId === 'light') {
    document.documentElement.removeAttribute('data-theme');
  } else {
    document.documentElement.setAttribute('data-theme', themeId);
  }

  localStorage.setItem('supportDashboardTheme', themeId);

  // Update active state in theme cards
  document.querySelectorAll('.theme-card').forEach(card => {
    card.classList.toggle('active', card.dataset.theme === themeId);
  });

  showToast(`Theme changed to ${theme.name}`, 'success');
}

function renderThemeSettings() {
  const currentTheme = getCurrentTheme();

  const html = `
    <div class="settings-section">
      <h3>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
        </svg>
        Theme
      </h3>
      <div class="theme-grid">
        ${themes.map(theme => `
          <div class="theme-card ${currentTheme === theme.id ? 'active' : ''}" data-theme="${theme.id}" onclick="setTheme('${theme.id}')">
            <div class="theme-preview" style="background: ${theme.colors.bg};">
              <div class="preview-sidebar" style="background: ${theme.colors.sidebar};">
                <div class="preview-bar" style="background: ${theme.colors.accent};"></div>
                <div class="preview-bar" style="background: ${theme.colors.text};"></div>
                <div class="preview-bar" style="background: ${theme.colors.text};"></div>
              </div>
              <div class="preview-main">
                <div class="preview-content" style="background: ${theme.colors.text};"></div>
              </div>
            </div>
            <div class="theme-card-name">
              ${theme.name}
              <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </div>
          </div>
        `).join('')}
      </div>
    </div>

    <div class="settings-section">
      <h3>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        About
      </h3>
      <div style="color: var(--text-secondary); font-size: 14px; line-height: 1.6;">
        <p><strong>Support Dashboard</strong></p>
        <p style="margin-top: 8px;">Version 1.0.0</p>
        <p style="margin-top: 4px;">Manage customer conversations with ease.</p>
      </div>
    </div>
  `;

  document.getElementById('settingsModalBody').innerHTML = html;
}

function openSettings() {
  closeUserMenu();
  renderThemeSettings();
  document.getElementById('settingsModal').style.display = 'flex';
}

function closeSettingsModal() {
  document.getElementById('settingsModal').style.display = 'none';
}

// Initialize theme on page load
(function initTheme() {
  const savedTheme = getCurrentTheme();
  if (savedTheme && savedTheme !== 'light') {
    document.documentElement.setAttribute('data-theme', savedTheme);
  }
})();

// Toast notification helper
function showToast(message, type = "info") {
  // Remove existing toast
  const existingToast = document.querySelector(".toast-notification");
  if (existingToast) existingToast.remove();

  const toast = document.createElement("div");
  toast.className = "toast-notification";
  toast.style.cssText = `
    position: fixed;
    top: 80px;
    right: 24px;
    padding: 14px 20px;
    background: ${type === "info" ? "#1e293b" : type === "success" ? "#16a34a" : "#dc2626"};
    color: white;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    z-index: 10000;
    animation: slideIn 0.3s ease;
  `;
  toast.textContent = message;

  // Add animation keyframes if not exists
  if (!document.getElementById("toast-styles")) {
    const style = document.createElement("style");
    style.id = "toast-styles";
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
    `;
    document.head.appendChild(style);
  }

  document.body.appendChild(toast);

  setTimeout(() => {
    toast.style.animation = "slideIn 0.3s ease reverse";
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Search functionality
document.getElementById("searchInput").addEventListener("input", (e) => {
  const query = e.target.value.toLowerCase();
  const items = document.querySelectorAll(".user-item");

  items.forEach(item => {
    const name = item.querySelector(".user-name").textContent.toLowerCase();
    const preview = item.querySelector(".user-preview").textContent.toLowerCase();

    if (name.includes(query) || preview.includes(query)) {
      item.style.display = "flex";
    } else {
      item.style.display = "none";
    }
  });
});

// Get username and email from URL params
const usernameFromUrl = params.get("user") || "Agent";
const emailFromUrl = params.get("email") || null;
updateCurrentUser(usernameFromUrl, emailFromUrl);

// ==================== AI ANALYSIS ====================
async function analyzeConversation(conversationId, visitorId) {
  if (!conversationId || !analysisEnabled) return;

  try {
    // Show loading state
    if (currentVisitor === visitorId) {
      analysisContent.innerHTML = '<div class="analysis-empty"><p>Analyzing conversation...</p></div>';
    }

    const response = await fetch(`${API_BASE}/ai/conversations/${conversationId}/analyze`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      throw new Error('Analysis failed');
    }

    const result = await response.json();
    if (result.success && result.data) {
      const analysis = result.data;

      // Store analysis for this visitor
      if (users[visitorId]) {
        users[visitorId].analysis = analysis;
      }

      // Render if this is the current conversation
      if (currentVisitor === visitorId && analysisEnabled) {
        renderAnalysis(analysis);
      }

      console.log("Analysis completed for:", conversationId);
    }
  } catch (error) {
    console.error("Analysis error:", error);
    if (currentVisitor === visitorId) {
      analysisContent.innerHTML = '<div class="analysis-empty"><p>Analysis failed. Try again later.</p></div>';
    }
  }
}

// Analyze message (single message analysis for quick insights)
async function analyzeMessage(message) {
  if (!analysisEnabled) return null;

  try {
    const response = await fetch(`${API_BASE}/ai/analyze-message`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ message: message })
    });

    if (response.ok) {
      const result = await response.json();
      return result.success ? result.data : null;
    }
  } catch (error) {
    console.error("Message analysis error:", error);
  }
  return null;
}

// ==================== TOGGLE HANDLERS ====================
function onAnalysisToggle(enabled) {
  analysisEnabled = enabled;
  console.log("AI Analysis:", enabled ? "ON" : "OFF");

  // Send toggle state to backend
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({
      type: "toggle_analysis",
      enabled: enabled
    }));
  }

  // Update analysis panel display
  if (currentVisitor && users[currentVisitor]) {
    if (enabled && users[currentVisitor].analysis) {
      renderAnalysis(users[currentVisitor].analysis);
    } else if (enabled) {
      // Wait for next customer message - Python server will send analysis via WebSocket
      analysisContent.innerHTML = '<div class="analysis-empty"><p>Waiting for customer message to analyze...</p></div>';
    } else {
      analysisContent.innerHTML = '<div class="analysis-empty"><p>Enable AI Analysis to see insights</p></div>';
    }
  }
}

function onAutoReplyToggle(enabled) {
  autoReplyEnabled = enabled;
  console.log("Auto Reply:", enabled ? "ON" : "OFF");

  // Send toggle state to backend
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({
      type: "toggle_auto_reply",
      enabled: enabled
    }));
  }
}

// Make functions global for onclick handlers
window.selectUser = selectUser;
window.selectEmojiCategory = selectEmojiCategory;
window.insertEmoji = insertEmoji;
window.useReply = useReply;
window.toggleUserMenu = toggleUserMenu;
window.openSettings = openSettings;
window.closeSettingsModal = closeSettingsModal;
window.setTheme = setTheme;
window.openProfile = openProfile;
window.logout = logout;
window.clearPendingFile = clearPendingFile;
window.openImageModal = openImageModal;
window.closeImageModal = closeImageModal;
window.onAnalysisToggle = onAnalysisToggle;
window.onAutoReplyToggle = onAutoReplyToggle;
window.analyzeConversation = analyzeConversation;

// ==================== SUBSCRIPTION PLAN & AI FEATURES ====================

async function loadSubscriptionPlan() {
  try {
    const response = await fetch(`${API_BASE}/subscriptions/sites/${siteId}/overview`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!response.ok) {
      console.warn('Failed to load subscription plan');
      return;
    }

    const result = await response.json();
    if (result.success && result.data) {
      sitePlan = result.data.plan;
      siteUsage = result.data.usage || [];

      // Check AI features availability
      updateAiFeatureAvailability();
    }
  } catch (error) {
    console.error('Error loading subscription plan:', error);
  }
}

function updateAiFeatureAvailability() {
  if (!sitePlan) {
    // No plan loaded - disable all AI features
    aiAnalysisAvailable = false;
    aiAutoReplyAvailable = false;
    aiAnalysisLimitExhausted = false;
    aiAutoReplyLimitExhausted = false;
  } else {
    // Check if features are enabled in plan
    aiAnalysisAvailable = sitePlan.aiAnalysisEnabled === true;
    aiAutoReplyAvailable = sitePlan.aiAutoReplyEnabled === true;

    // Check if limits are exhausted
    const analysisUsage = siteUsage.find(u => u.metricName === 'ai_analyses');
    const autoReplyUsage = siteUsage.find(u => u.metricName === 'ai_auto_replies');

    if (analysisUsage && sitePlan.maxAiAnalysesPerMonth) {
      aiAnalysisLimitExhausted = analysisUsage.used >= sitePlan.maxAiAnalysesPerMonth;
    }

    if (autoReplyUsage && sitePlan.maxAiAutoRepliesPerMonth) {
      aiAutoReplyLimitExhausted = autoReplyUsage.used >= sitePlan.maxAiAutoRepliesPerMonth;
    }
  }

  // Update UI
  updateAiToggleUI();
}

function updateAiToggleUI() {
  const analysisContainer = document.getElementById('analysisToggleContainer');
  const autoReplyContainer = document.getElementById('autoReplyToggleContainer');
  const analysisBadge = document.getElementById('analysisPremiumBadge');
  const autoReplyBadge = document.getElementById('autoReplyPremiumBadge');
  const analysisToggle = document.getElementById('toggleAnalysis');
  const autoReplyToggle = document.getElementById('toggleAutoReply');
  const analysisUsageIndicator = document.getElementById('analysisUsageIndicator');
  const autoReplyUsageIndicator = document.getElementById('autoReplyUsageIndicator');

  const starIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`;

  // AI Analysis toggle
  if (!aiAnalysisAvailable) {
    analysisContainer.classList.add('disabled');
    analysisBadge.innerHTML = `<span class="premium-badge" onclick="showUpgradeModal('analysis', 'not_enabled')">${starIcon} PRO</span>`;
    analysisBadge.style.display = 'inline';
    analysisToggle.disabled = true;
    analysisToggle.checked = false;
    analysisUsageIndicator.textContent = '';
  } else if (aiAnalysisLimitExhausted) {
    analysisContainer.classList.add('disabled');
    analysisBadge.innerHTML = `<span class="premium-badge" onclick="showUpgradeModal('analysis', 'exhausted')">${starIcon} Limit Reached</span>`;
    analysisBadge.style.display = 'inline';
    analysisToggle.disabled = true;
    analysisToggle.checked = false;
    const usage = siteUsage.find(u => u.metricName === 'ai_analyses');
    if (usage) {
      analysisUsageIndicator.textContent = `(${usage.used}/${sitePlan.maxAiAnalysesPerMonth})`;
      analysisUsageIndicator.className = 'usage-indicator exhausted';
    }
  } else {
    analysisContainer.classList.remove('disabled');
    analysisBadge.style.display = 'none';
    analysisToggle.disabled = false;
    // Show usage if there's a limit
    if (sitePlan && sitePlan.maxAiAnalysesPerMonth) {
      const usage = siteUsage.find(u => u.metricName === 'ai_analyses');
      const used = usage ? usage.used : 0;
      const percentage = (used / sitePlan.maxAiAnalysesPerMonth) * 100;
      analysisUsageIndicator.textContent = `(${used}/${sitePlan.maxAiAnalysesPerMonth})`;
      analysisUsageIndicator.className = percentage >= 80 ? 'usage-indicator warning' : 'usage-indicator';
    } else {
      analysisUsageIndicator.textContent = '';
    }
  }

  // AI Auto Reply toggle
  if (!aiAutoReplyAvailable) {
    autoReplyContainer.classList.add('disabled');
    autoReplyBadge.innerHTML = `<span class="premium-badge" onclick="showUpgradeModal('auto_reply', 'not_enabled')">${starIcon} PRO</span>`;
    autoReplyBadge.style.display = 'inline';
    autoReplyToggle.disabled = true;
    autoReplyToggle.checked = false;
    autoReplyUsageIndicator.textContent = '';
  } else if (aiAutoReplyLimitExhausted) {
    autoReplyContainer.classList.add('disabled');
    autoReplyBadge.innerHTML = `<span class="premium-badge" onclick="showUpgradeModal('auto_reply', 'exhausted')">${starIcon} Limit Reached</span>`;
    autoReplyBadge.style.display = 'inline';
    autoReplyToggle.disabled = true;
    autoReplyToggle.checked = false;
    const usage = siteUsage.find(u => u.metricName === 'ai_auto_replies');
    if (usage) {
      autoReplyUsageIndicator.textContent = `(${usage.used}/${sitePlan.maxAiAutoRepliesPerMonth})`;
      autoReplyUsageIndicator.className = 'usage-indicator exhausted';
    }
  } else {
    autoReplyContainer.classList.remove('disabled');
    autoReplyBadge.style.display = 'none';
    autoReplyToggle.disabled = false;
    // Show usage if there's a limit
    if (sitePlan && sitePlan.maxAiAutoRepliesPerMonth) {
      const usage = siteUsage.find(u => u.metricName === 'ai_auto_replies');
      const used = usage ? usage.used : 0;
      const percentage = (used / sitePlan.maxAiAutoRepliesPerMonth) * 100;
      autoReplyUsageIndicator.textContent = `(${used}/${sitePlan.maxAiAutoRepliesPerMonth})`;
      autoReplyUsageIndicator.className = percentage >= 80 ? 'usage-indicator warning' : 'usage-indicator';
    } else {
      autoReplyUsageIndicator.textContent = '';
    }
  }
}

function showUpgradeModal(feature, reason) {
  const modal = document.getElementById('upgradeModal');
  const title = document.getElementById('upgradeModalTitle');
  const subtitle = document.getElementById('upgradeModalSubtitle');
  const featureName = document.getElementById('upgradeFeatureName');
  const featureDesc = document.getElementById('upgradeFeatureDesc');
  const usageStatus = document.getElementById('upgradeUsageStatus');
  const usageValue = document.getElementById('upgradeUsageValue');

  if (feature === 'analysis') {
    featureName.textContent = 'AI Analysis';
    featureDesc.textContent = 'Get real-time insights about customer sentiment, buying intent, objections, and recommended responses to close more deals.';

    if (reason === 'not_enabled') {
      title.textContent = 'Unlock AI Analysis';
      subtitle.textContent = 'This feature is not included in your current plan';
      usageStatus.style.display = 'none';
    } else if (reason === 'exhausted') {
      title.textContent = 'AI Analysis Limit Reached';
      subtitle.textContent = 'You have used all your AI analyses for this month';
      usageStatus.style.display = 'flex';
      const usage = siteUsage.find(u => u.metricName === 'ai_analyses');
      if (usage && sitePlan) {
        usageValue.textContent = `${usage.used} / ${sitePlan.maxAiAnalysesPerMonth}`;
        usageValue.className = 'value exhausted';
      }
    }
  } else if (feature === 'auto_reply') {
    featureName.textContent = 'AI Auto Reply';
    featureDesc.textContent = 'Let AI automatically respond to customers with intelligent, context-aware messages while you are busy or offline.';

    if (reason === 'not_enabled') {
      title.textContent = 'Unlock AI Auto Reply';
      subtitle.textContent = 'This feature is not included in your current plan';
      usageStatus.style.display = 'none';
    } else if (reason === 'exhausted') {
      title.textContent = 'AI Auto Reply Limit Reached';
      subtitle.textContent = 'You have used all your AI auto replies for this month';
      usageStatus.style.display = 'flex';
      const usage = siteUsage.find(u => u.metricName === 'ai_auto_replies');
      if (usage && sitePlan) {
        usageValue.textContent = `${usage.used} / ${sitePlan.maxAiAutoRepliesPerMonth}`;
        usageValue.className = 'value exhausted';
      }
    }
  }

  modal.classList.add('show');
}

function closeUpgradeModal() {
  document.getElementById('upgradeModal').classList.remove('show');
}

// ==================== EMAIL MODAL ====================
function openEmailModal() {
  if (!currentVisitor || !users[currentVisitor]) return;

  const email = users[currentVisitor].email;
  if (!email) {
    showNotification('No email address available for this visitor', 'error');
    return;
  }

  document.getElementById('emailTo').value = email;
  document.getElementById('emailSubject').value = `Follow-up from ${document.title || 'Support'}`;
  document.getElementById('emailBody').value = `Hi ${users[currentVisitor].name},\n\nThank you for contacting us.\n\n`;

  const modal = document.getElementById('emailModal');
  modal.style.display = 'flex';
  setTimeout(() => modal.classList.add('show'), 10);

  document.getElementById('emailSubject').focus();
}

function closeEmailModal() {
  const modal = document.getElementById('emailModal');
  modal.classList.remove('show');
  setTimeout(() => modal.style.display = 'none', 300);
}

async function sendEmail() {
  const to = document.getElementById('emailTo').value;
  const subject = document.getElementById('emailSubject').value.trim();
  const body = document.getElementById('emailBody').value.trim();

  if (!subject) {
    showNotification('Please enter a subject', 'error');
    document.getElementById('emailSubject').focus();
    return;
  }

  if (!body) {
    showNotification('Please enter a message', 'error');
    document.getElementById('emailBody').focus();
    return;
  }

  const btn = document.getElementById('btnSendEmailSubmit');
  const originalText = btn.innerHTML;
  btn.innerHTML = '<span class="spinner"></span> Sending...';
  btn.disabled = true;

  try {
    const response = await fetch(`${API_BASE}/sites/${siteId}/send-email`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        to: to,
        subject: subject,
        body: body,
        visitorId: currentVisitor
      })
    });

    const result = await response.json();

    if (response.ok && result.success) {
      showNotification('Email sent successfully!', 'success');
      closeEmailModal();
    } else {
      showNotification(result.message || 'Failed to send email', 'error');
    }
  } catch (error) {
    console.error('Error sending email:', error);
    showNotification('Failed to send email. Please try again.', 'error');
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
}

// Attach Send Email button click handler
document.getElementById('btnSendEmail')?.addEventListener('click', openEmailModal);

function showNotification(message, type = 'info') {
  // Create notification element
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    font-size: 14px;
    font-weight: 500;
    z-index: 10001;
    animation: slideIn 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    ${type === 'success' ? 'background: #22c55e;' : type === 'error' ? 'background: #ef4444;' : 'background: #3b82f6;'}
  `;
  notification.textContent = message;
  document.body.appendChild(notification);

  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Load subscription plan on page load
loadSubscriptionPlan();

// ==================== REAL-TIME USAGE UPDATES ====================

function updateAiUsageDisplay(feature, used, limit) {
  console.log(`AI usage update: ${feature} - ${used}/${limit}`);

  if (feature === 'analysis') {
    // Update the internal state
    if (sitePlan) {
      const usage = siteUsage.find(u => u.metricName === 'ai_analyses');
      if (usage) {
        usage.used = used;
      } else {
        siteUsage.push({ metricName: 'ai_analyses', used: used });
      }
    }

    // Update UI
    const indicator = document.getElementById('analysisUsageIndicator');
    if (indicator && limit) {
      indicator.textContent = `(${used}/${limit})`;
      const percentage = (used / limit) * 100;
      if (percentage >= 100) {
        indicator.className = 'usage-indicator exhausted';
      } else if (percentage >= 80) {
        indicator.className = 'usage-indicator warning';
      } else {
        indicator.className = 'usage-indicator';
      }
    }
  } else if (feature === 'auto_reply') {
    // Update the internal state
    if (sitePlan) {
      const usage = siteUsage.find(u => u.metricName === 'ai_auto_replies');
      if (usage) {
        usage.used = used;
      } else {
        siteUsage.push({ metricName: 'ai_auto_replies', used: used });
      }
    }

    // Update UI
    const indicator = document.getElementById('autoReplyUsageIndicator');
    if (indicator && limit) {
      indicator.textContent = `(${used}/${limit})`;
      const percentage = (used / limit) * 100;
      if (percentage >= 100) {
        indicator.className = 'usage-indicator exhausted';
      } else if (percentage >= 80) {
        indicator.className = 'usage-indicator warning';
      } else {
        indicator.className = 'usage-indicator';
      }
    }
  }
}

function handleAiLimitReached(feature, message, used, limit) {
  console.log(`AI limit reached: ${feature} - ${message}`);

  // Update internal state
  if (feature === 'analysis') {
    aiAnalysisLimitExhausted = true;
  } else if (feature === 'auto_reply') {
    aiAutoReplyLimitExhausted = true;
  }

  // Update usage display
  updateAiUsageDisplay(feature, used, limit);

  // Update toggle UI to show limit reached
  updateAiToggleUI();

  // Show notification
  const featureName = feature === 'analysis' ? 'AI Analysis' : 'AI Auto Reply';
  showToast(`${featureName} limit reached! Upgrade your plan for more.`, 'warning');

  // Show upgrade modal
  showUpgradeModal(feature, 'exhausted');
}

// Export upgrade functions
window.showUpgradeModal = showUpgradeModal;
window.closeUpgradeModal = closeUpgradeModal;
window.updateAiUsageDisplay = updateAiUsageDisplay;
window.handleAiLimitReached = handleAiLimitReached;
</script>

</body>
</html>
