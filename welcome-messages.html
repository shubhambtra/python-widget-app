<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Welcome Messages - Support Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  min-height: 100vh;
  background: #f1f5f9;
  color: #1e293b;
}

/* ==================== TOP BAR ==================== */
.topbar {
  height: 60px;
  background: #fff;
  border-bottom: 1px solid #e2e8f0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 24px;
  position: sticky;
  top: 0;
  z-index: 100;
}

.topbar-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.topbar-logo {
  width: 36px;
  height: 36px;
  background: white;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
}

.topbar-logo svg {
  width: 20px;
  height: 20px;
}

.topbar-brand {
  font-size: 18px;
  font-weight: 700;
  color: #1e293b;
}

.topbar-brand span {
  color: #2563eb;
}

.topbar-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.btn-back {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: #f1f5f9;
  border: none;
  border-radius: 8px;
  color: #64748b;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  text-decoration: none;
}

.btn-back:hover {
  background: #e2e8f0;
  color: #1e293b;
}

.btn-back svg {
  width: 18px;
  height: 18px;
}

/* ==================== MAIN CONTENT ==================== */
.main-content {
  max-width: 900px;
  margin: 0 auto;
  padding: 32px 24px;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 32px;
}

.page-header-text h1 {
  font-size: 28px;
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 8px;
}

.page-header-text p {
  font-size: 15px;
  color: #64748b;
}

/* ==================== CARDS ==================== */
.card {
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  border: 1px solid #e2e8f0;
  margin-bottom: 24px;
  overflow: hidden;
}

.card-header {
  padding: 20px 24px;
  border-bottom: 1px solid #e2e8f0;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.card-title {
  font-size: 16px;
  font-weight: 600;
  color: #1e293b;
  display: flex;
  align-items: center;
  gap: 10px;
}

.card-title svg {
  width: 20px;
  height: 20px;
  color: #2563eb;
}

.card-body {
  padding: 24px;
}

/* ==================== INFO BOX ==================== */
.info-box {
  background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
  border: 1px solid #bfdbfe;
  border-radius: 12px;
  padding: 16px 20px;
  margin-bottom: 24px;
  display: flex;
  align-items: flex-start;
  gap: 12px;
}

.info-box svg {
  width: 20px;
  height: 20px;
  color: #2563eb;
  flex-shrink: 0;
  margin-top: 2px;
}

.info-box p {
  font-size: 14px;
  color: #1e40af;
  line-height: 1.5;
}

/* ==================== MESSAGE LIST ==================== */
.message-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.message-item {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  padding: 16px 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  transition: all 0.2s;
}

.message-item:hover {
  border-color: #cbd5e1;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.message-item.inactive {
  opacity: 0.6;
}

.message-item.editing {
  background: #fff;
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.message-order {
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 14px;
  font-weight: 600;
  flex-shrink: 0;
}

.message-content {
  flex: 1;
  min-width: 0;
}

.message-text {
  font-size: 15px;
  color: #1e293b;
  line-height: 1.5;
  word-break: break-word;
}

.message-meta {
  font-size: 12px;
  color: #94a3b8;
  margin-top: 4px;
}

.message-actions {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
}

.message-btn {
  width: 36px;
  height: 36px;
  border: none;
  background: #fff;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #64748b;
  transition: all 0.2s;
  border: 1px solid #e2e8f0;
}

.message-btn:hover {
  background: #f1f5f9;
  color: #1e293b;
}

.message-btn.danger:hover {
  background: #fee2e2;
  color: #dc2626;
  border-color: #fecaca;
}

.message-btn svg {
  width: 18px;
  height: 18px;
}

/* ==================== TOGGLE SWITCH ==================== */
.toggle-switch {
  position: relative;
  width: 44px;
  height: 24px;
  flex-shrink: 0;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: #cbd5e1;
  transition: 0.3s;
  border-radius: 24px;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background: white;
  transition: 0.3s;
  border-radius: 50%;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
}

input:checked + .toggle-slider {
  background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
}

input:checked + .toggle-slider:before {
  transform: translateX(20px);
}

/* ==================== ADD MESSAGE FORM ==================== */
.add-form {
  display: flex;
  gap: 12px;
  margin-bottom: 24px;
}

.add-form-input {
  flex: 1;
  padding: 14px 18px;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  font-size: 15px;
  font-family: inherit;
  color: #1e293b;
  transition: all 0.2s;
  background: #fff;
}

.add-form-input:focus {
  outline: none;
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.add-form-input::placeholder {
  color: #94a3b8;
}

/* ==================== EDIT FORM ==================== */
.edit-form {
  display: flex;
  gap: 12px;
  flex: 1;
}

.edit-input {
  flex: 1;
  padding: 10px 14px;
  border: 2px solid #2563eb;
  border-radius: 8px;
  font-size: 15px;
  font-family: inherit;
  color: #1e293b;
  background: #fff;
}

.edit-input:focus {
  outline: none;
}

/* ==================== BUTTONS ==================== */
.btn {
  padding: 12px 20px;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  font-family: inherit;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  border: none;
}

.btn-primary {
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  color: white;
}

.btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}

.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.btn-secondary {
  background: #f1f5f9;
  color: #64748b;
}

.btn-secondary:hover {
  background: #e2e8f0;
  color: #1e293b;
}

.btn-sm {
  padding: 8px 14px;
  font-size: 13px;
}

.btn svg {
  width: 18px;
  height: 18px;
}

/* ==================== EMPTY STATE ==================== */
.empty-state {
  text-align: center;
  padding: 48px 24px;
  color: #64748b;
}

.empty-state svg {
  width: 64px;
  height: 64px;
  color: #cbd5e1;
  margin-bottom: 16px;
}

.empty-state h3 {
  font-size: 18px;
  font-weight: 600;
  color: #475569;
  margin-bottom: 8px;
}

.empty-state p {
  font-size: 14px;
  color: #94a3b8;
}

/* ==================== PREVIEW ==================== */
.preview-section {
  margin-top: 32px;
}

.preview-title {
  font-size: 14px;
  font-weight: 600;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 16px;
}

.preview-chat {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-radius: 16px;
  padding: 24px;
  max-width: 400px;
}

.preview-message {
  background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
  color: white;
  padding: 12px 16px;
  border-radius: 16px 16px 4px 16px;
  font-size: 14px;
  line-height: 1.5;
  max-width: 280px;
  margin-bottom: 8px;
}

.preview-time {
  font-size: 11px;
  color: #94a3b8;
}

/* ==================== TOAST ==================== */
.toast-container {
  position: fixed;
  top: 80px;
  right: 24px;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.toast {
  padding: 16px 20px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
  display: flex;
  align-items: center;
  gap: 12px;
  animation: slideIn 0.3s ease;
  min-width: 300px;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(100%);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.toast.success {
  border-left: 4px solid #22c55e;
}

.toast.error {
  border-left: 4px solid #ef4444;
}

.toast-icon {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.toast.success .toast-icon {
  background: #dcfce7;
  color: #22c55e;
}

.toast.error .toast-icon {
  background: #fee2e2;
  color: #ef4444;
}

.toast-message {
  flex: 1;
  font-size: 14px;
  color: #1e293b;
}

/* ==================== LOADING ==================== */
.spinner {
  width: 18px;
  height: 18px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-overlay {
  position: absolute;
  inset: 0;
  background: rgba(255, 255, 255, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 16px;
}

/* ==================== RESPONSIVE ==================== */
@media (max-width: 768px) {
  .main-content {
    padding: 20px 16px;
  }

  .page-header {
    flex-direction: column;
    gap: 16px;
  }

  .add-form {
    flex-direction: column;
  }

  .message-item {
    flex-wrap: wrap;
  }

  .message-actions {
    width: 100%;
    justify-content: flex-end;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #e2e8f0;
  }
}
</style>
</head>

<body>
  <!-- TOP BAR -->
  <header class="topbar">
    <div class="topbar-left">
      <div class="topbar-logo">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
      </div>
      <div class="topbar-brand">Chat<span>App</span></div>
    </div>
    <div class="topbar-right">
      <a href="#" class="btn-back" onclick="goBack()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to Dashboard
      </a>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="main-content">
    <div class="page-header">
      <div class="page-header-text">
        <h1>Welcome Messages</h1>
        <p>Configure automatic messages sent when customers start a chat</p>
      </div>
    </div>

    <!-- Info Box -->
    <div class="info-box">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <p>The first active message in the list will be automatically sent to customers when they start a new chat. You can add multiple messages and reorder them as needed.</p>
    </div>

    <!-- Add Message Form -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg>
          Add New Message
        </div>
      </div>
      <div class="card-body">
        <form class="add-form" onsubmit="addMessage(event)">
          <input type="text" class="add-form-input" id="newMessageInput" placeholder="Enter your welcome message..." maxlength="500" required>
          <button type="submit" class="btn btn-primary" id="addBtn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            Add Message
          </button>
        </form>
      </div>
    </div>

    <!-- Messages List -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
          </svg>
          Your Messages
          <span id="messageCount" style="font-weight: 400; color: #64748b;"></span>
        </div>
      </div>
      <div class="card-body" id="messagesContainer">
        <!-- Messages will be loaded here -->
      </div>
    </div>

    <!-- Preview Section -->
    <div class="preview-section" id="previewSection" style="display: none;">
      <div class="preview-title">Preview</div>
      <div class="preview-chat">
        <div class="preview-message" id="previewMessage">
          Hello! How can I help you today?
        </div>
        <div class="preview-time">Just now</div>
      </div>
    </div>
  </main>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

<script src="/config.js"></script>
<script>
// ==================== CONFIG ====================
const params = new URLSearchParams(location.search);
const siteId = params.get("siteId");
const token = params.get("token");

if (!siteId || !token) {
  alert("Missing siteId or token. Please access this page from the Support Dashboard.");
  window.location.href = "/Support.html";
}

const API_BASE = CONFIG.API_BASE;

// ==================== STATE ====================
let messages = [];
let editingId = null;

// ==================== INIT ====================
document.addEventListener("DOMContentLoaded", () => {
  loadMessages();
});

// ==================== API CALLS ====================
async function loadMessages() {
  try {
    const response = await fetch(`${API_BASE}/sites/${siteId}/welcome-messages`, {
      headers: {
        "Authorization": `Bearer ${token}`
      }
    });

    if (!response.ok) throw new Error("Failed to load messages");

    const result = await response.json();
    if (result.success) {
      messages = result.data || [];
      renderMessages();
      updatePreview();
    }
  } catch (error) {
    showToast("Failed to load messages", "error");
    console.error(error);
  }
}

async function addMessage(e) {
  e.preventDefault();

  const input = document.getElementById("newMessageInput");
  const message = input.value.trim();

  if (!message) return;

  const btn = document.getElementById("addBtn");
  const originalText = btn.innerHTML;
  btn.innerHTML = '<div class="spinner"></div>';
  btn.disabled = true;

  try {
    const response = await fetch(`${API_BASE}/sites/${siteId}/welcome-messages`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ message })
    });

    if (!response.ok) throw new Error("Failed to add message");

    const result = await response.json();
    if (result.success) {
      messages.push(result.data);
      renderMessages();
      updatePreview();
      input.value = "";
      showToast("Message added successfully!", "success");
    }
  } catch (error) {
    showToast("Failed to add message", "error");
    console.error(error);
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
}

async function updateMessage(id, data) {
  try {
    const response = await fetch(`${API_BASE}/sites/${siteId}/welcome-messages/${id}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify(data)
    });

    if (!response.ok) throw new Error("Failed to update message");

    const result = await response.json();
    if (result.success) {
      const index = messages.findIndex(m => m.id === id);
      if (index !== -1) {
        messages[index] = result.data;
      }
      renderMessages();
      updatePreview();
      return true;
    }
  } catch (error) {
    showToast("Failed to update message", "error");
    console.error(error);
    return false;
  }
}

async function deleteMessage(id) {
  if (!confirm("Are you sure you want to delete this message?")) return;

  try {
    const response = await fetch(`${API_BASE}/sites/${siteId}/welcome-messages/${id}`, {
      method: "DELETE",
      headers: {
        "Authorization": `Bearer ${token}`
      }
    });

    if (!response.ok) throw new Error("Failed to delete message");

    messages = messages.filter(m => m.id !== id);
    renderMessages();
    updatePreview();
    showToast("Message deleted", "success");
  } catch (error) {
    showToast("Failed to delete message", "error");
    console.error(error);
  }
}

async function toggleActive(id, isActive) {
  await updateMessage(id, { isActive });
}

async function moveMessage(id, direction) {
  const index = messages.findIndex(m => m.id === id);
  if (index === -1) return;

  const newIndex = direction === "up" ? index - 1 : index + 1;
  if (newIndex < 0 || newIndex >= messages.length) return;

  // Swap in local array
  [messages[index], messages[newIndex]] = [messages[newIndex], messages[index]];

  // Update display orders
  const messageIds = messages.map(m => m.id);

  try {
    const response = await fetch(`${API_BASE}/sites/${siteId}/welcome-messages/reorder`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ messageIds })
    });

    if (!response.ok) throw new Error("Failed to reorder");

    // Update local display orders
    messages.forEach((m, i) => m.displayOrder = i);
    renderMessages();
    updatePreview();
  } catch (error) {
    // Revert on error
    loadMessages();
    showToast("Failed to reorder messages", "error");
  }
}

// ==================== RENDER ====================
function renderMessages() {
  const container = document.getElementById("messagesContainer");
  const countEl = document.getElementById("messageCount");

  if (messages.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
        <h3>No welcome messages yet</h3>
        <p>Add your first message above to greet customers automatically</p>
      </div>
    `;
    countEl.textContent = "";
    return;
  }

  countEl.textContent = `(${messages.length})`;

  container.innerHTML = `
    <div class="message-list">
      ${messages.map((msg, index) => `
        <div class="message-item ${!msg.isActive ? 'inactive' : ''} ${editingId === msg.id ? 'editing' : ''}" data-id="${msg.id}">
          <div class="message-order">${index + 1}</div>

          ${editingId === msg.id ? `
            <form class="edit-form" onsubmit="saveEdit(event, '${msg.id}')">
              <input type="text" class="edit-input" id="editInput-${msg.id}" value="${escapeHtml(msg.message)}" maxlength="500" required>
              <button type="submit" class="btn btn-primary btn-sm">Save</button>
              <button type="button" class="btn btn-secondary btn-sm" onclick="cancelEdit()">Cancel</button>
            </form>
          ` : `
            <div class="message-content">
              <div class="message-text">${escapeHtml(msg.message)}</div>
              <div class="message-meta">${msg.isActive ? 'Active' : 'Inactive'} ${index === 0 && msg.isActive ? '- Will be sent to customers' : ''}</div>
            </div>

            <div class="message-actions">
              <button class="message-btn" onclick="moveMessage('${msg.id}', 'up')" title="Move up" ${index === 0 ? 'disabled style="opacity:0.3"' : ''}>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                </svg>
              </button>
              <button class="message-btn" onclick="moveMessage('${msg.id}', 'down')" title="Move down" ${index === messages.length - 1 ? 'disabled style="opacity:0.3"' : ''}>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <label class="toggle-switch" title="${msg.isActive ? 'Deactivate' : 'Activate'}">
                <input type="checkbox" ${msg.isActive ? 'checked' : ''} onchange="toggleActive('${msg.id}', this.checked)">
                <span class="toggle-slider"></span>
              </label>
              <button class="message-btn" onclick="startEdit('${msg.id}')" title="Edit">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
              </button>
              <button class="message-btn danger" onclick="deleteMessage('${msg.id}')" title="Delete">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          `}
        </div>
      `).join('')}
    </div>
  `;
}

function updatePreview() {
  const previewSection = document.getElementById("previewSection");
  const previewMessage = document.getElementById("previewMessage");

  const activeMessage = messages.find(m => m.isActive);

  if (activeMessage) {
    previewSection.style.display = "block";
    previewMessage.textContent = activeMessage.message;
  } else {
    previewSection.style.display = "none";
  }
}

// ==================== EDIT ====================
function startEdit(id) {
  editingId = id;
  renderMessages();
  setTimeout(() => {
    const input = document.getElementById(`editInput-${id}`);
    if (input) {
      input.focus();
      input.setSelectionRange(input.value.length, input.value.length);
    }
  }, 50);
}

function cancelEdit() {
  editingId = null;
  renderMessages();
}

async function saveEdit(e, id) {
  e.preventDefault();
  const input = document.getElementById(`editInput-${id}`);
  const newMessage = input.value.trim();

  if (!newMessage) return;

  const success = await updateMessage(id, { message: newMessage });
  if (success) {
    editingId = null;
    showToast("Message updated!", "success");
  }
}

// ==================== HELPERS ====================
function escapeHtml(text) {
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

function goBack() {
  window.location.href = `http://${location.hostname}:8000/Support.html?siteId=${siteId}&token=${token}`;
}

// ==================== TOAST ====================
function showToast(message, type = "success") {
  const container = document.getElementById("toastContainer");

  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <div class="toast-icon">
      ${type === "success" ? `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      ` : `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      `}
    </div>
    <span class="toast-message">${message}</span>
  `;

  container.appendChild(toast);

  setTimeout(() => {
    toast.style.animation = "slideIn 0.3s ease reverse";
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}
</script>
</body>
</html>
