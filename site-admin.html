<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Site Admin Dashboard - ChatApp</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<link rel="stylesheet" href="site-admin.css">
</head>

<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
</div>

<div class="app-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <div class="sidebar-logo-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
        </div>
        <div class="sidebar-logo-text" data-brand="name">ChatApp</div>
      </div>
      <div class="site-selector" id="siteSelector">
        <div class="site-selector-name" id="siteName">Loading...</div>
        <div class="site-selector-domain" id="siteDomain">---</div>
      </div>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-section-title">Dashboard</div>
        <div class="nav-item active" data-section="overview">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
          </svg>
          Overview
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Management</div>
        <div class="nav-item" data-section="agents">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
          Agents
        </div>
        <div class="nav-item" data-section="messages">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
          </svg>
          Welcome Messages
        </div>
        <div class="nav-item" id="knowledgeBaseLink">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
          </svg>
          Knowledge Base
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Configuration</div>
        <div class="nav-item" data-section="settings">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          Site Settings
        </div>
        <div class="nav-item" data-section="widget">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
          </svg>
          Widget Design
        </div>
        <div class="nav-item" data-section="subscription">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Subscription
        </div>
        <div class="nav-item" data-section="billing">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
          </svg>
          Billing
        </div>
      </div>
    </nav>

    <div class="sidebar-footer">
      <div class="user-info" onclick="logout()">
        <div class="user-avatar" id="userAvatar">A</div>
        <div class="user-details">
          <div class="user-name" id="userName">Admin</div>
          <div class="user-role">Site Owner</div>
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="#64748b">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <div class="topbar">
      <h1 class="topbar-title" id="sectionTitle">Overview</h1>
      <div class="topbar-actions">
        <a href="/support/login" class="btn btn-secondary">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          Open Support Chat
        </a>
      </div>
    </div>

    <div class="content-area">
      <!-- Overview Section -->
      <section class="section active" id="section-overview">
        <div class="stats-grid" id="statsGrid">
          <!-- Stats will be loaded dynamically -->
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              Agent Performance
            </div>
          </div>
          <div class="card-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Agent</th>
                    <th>Conversations</th>
                    <th>Avg Response</th>
                    <th>Rating</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="agentPerformanceTable">
                  <!-- Agent data will be loaded -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Agents Section -->
      <section class="section" id="section-agents">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
              Support Agents
            </div>
            <button class="btn btn-primary" onclick="showAddAgentModal()">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
              </svg>
              Add Agent
            </button>
          </div>
          <div class="card-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Agent</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Can View</th>
                    <th>Can Respond</th>
                    <th>Can Close</th>
                    <th>Admin</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="agentsTable">
                  <!-- Agents will be loaded -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Welcome Messages Section -->
      <section class="section" id="section-messages">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
              </svg>
              Welcome Messages
            </div>
            <button class="btn btn-primary" onclick="showAddMessageModal()">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
              </svg>
              Add Message
            </button>
          </div>
          <div class="card-body" id="welcomeMessagesContainer">
            <!-- Messages will be loaded -->
          </div>
        </div>
      </section>

      <!-- Site Settings Section -->
      <section class="section" id="section-settings">
        <!-- Integration Card -->
        <div class="card" style="margin-bottom: 24px;">
          <div class="card-header">
            <div class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
              </svg>
              Integration & API Key
            </div>
          </div>
          <div class="card-body">
            <div style="margin-bottom: 24px;">
              <label class="form-label">Your Site API Key</label>
              <div style="display: flex; gap: 12px; align-items: center;">
                <div style="flex: 1; position: relative;">
                  <input type="text" class="form-input" id="siteApiKey" readonly style="font-family: 'Courier New', monospace; padding-right: 100px; background: #f1f5f9;">
                  <button type="button" onclick="toggleKeyVisibility()" id="toggleKeyBtn" style="position: absolute; right: 60px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #64748b; padding: 8px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                  </button>
                  <button type="button" onclick="copyApiKey()" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #64748b; padding: 8px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                  </button>
                </div>
                <button type="button" class="btn btn-secondary" onclick="regenerateApiKey()" style="white-space: nowrap;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="margin-right: 6px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                  Regenerate
                </button>
              </div>
              <p class="form-help" style="margin-top: 8px;">Keep this key secret. Use it to authenticate API requests and widget initialization.</p>
            </div>

            <div style="margin-bottom: 24px;">
              <label class="form-label">Site ID</label>
              <div style="display: flex; gap: 12px; align-items: center;">
                <input type="text" class="form-input" id="displaySiteId" readonly style="font-family: 'Courier New', monospace; background: #f1f5f9; flex: 1;">
                <button type="button" class="btn btn-secondary" onclick="copySiteId()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="margin-right: 6px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                  </svg>
                  Copy
                </button>
              </div>
            </div>

            <div>
              <label class="form-label">Widget Installation Code</label>
              <p class="form-help" style="margin-bottom: 12px;">Add this code snippet to your website, just before the closing <code>&lt;/body&gt;</code> tag:</p>
              <div style="position: relative;">
                <pre id="installCode" style="background: #1e293b; color: #e2e8f0; padding: 20px; border-radius: 10px; font-size: 13px; overflow-x: auto; margin: 0; line-height: 1.6;"></pre>
                <button type="button" onclick="copyInstallCode()" style="position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.1); border: none; border-radius: 6px; padding: 8px 12px; color: white; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 6px;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                  </svg>
                  Copy Code
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Site Information Card -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
              </svg>
              Site Information
            </div>
          </div>
          <div class="card-body">
            <form id="siteSettingsForm" onsubmit="saveSiteSettings(event)">
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">Site Name</label>
                  <input type="text" class="form-input" id="settingSiteName" placeholder="My Company Support">
                </div>
                <div class="form-group">
                  <label class="form-label">Domain</label>
                  <input type="text" class="form-input" id="settingDomain" placeholder="support.mycompany.com">
                </div>
                <div class="form-group">
                  <label class="form-label">Company Name</label>
                  <input type="text" class="form-input" id="settingCompanyName" placeholder="My Company Inc.">
                </div>
                <div class="form-group">
                  <label class="form-label">Company Website</label>
                  <input type="url" class="form-input" id="settingCompanyWebsite" placeholder="https://mycompany.com">
                </div>
                <div class="form-group">
                  <label class="form-label">Industry</label>
                  <select class="form-select" id="settingIndustry">
                    <option value="">Select Industry</option>
                    <option value="technology">Technology</option>
                    <option value="ecommerce">E-Commerce</option>
                    <option value="healthcare">Healthcare</option>
                    <option value="finance">Finance</option>
                    <option value="education">Education</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Timezone</label>
                  <select class="form-select" id="settingTimezone">
                    <option value="UTC">UTC</option>
                    <option value="America/New_York">Eastern Time</option>
                    <option value="America/Chicago">Central Time</option>
                    <option value="America/Denver">Mountain Time</option>
                    <option value="America/Los_Angeles">Pacific Time</option>
                    <option value="Europe/London">London</option>
                    <option value="Europe/Paris">Paris</option>
                    <option value="Asia/Tokyo">Tokyo</option>
                    <option value="Asia/Kolkata">India</option>
                  </select>
                </div>
              </div>

              <h3 style="margin: 32px 0 16px; font-size: 16px; font-weight: 600;">AI Settings</h3>
              <div class="toggle-group">
                <div>
                  <div class="toggle-label">Enable AI Features</div>
                  <div class="toggle-desc">Use AI to analyze conversations and suggest responses</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="settingAiEnabled">
                  <span class="toggle-slider"></span>
                </label>
              </div>

              <div class="form-group" style="margin-top: 20px;">
                <label class="form-label">AI Model</label>
                <select class="form-select" id="settingAiModel">
                  <option value="gpt-4o-mini">GPT-4o Mini (Fast)</option>
                  <option value="gpt-4o">GPT-4o (Balanced)</option>
                  <option value="gpt-4-turbo">GPT-4 Turbo (Best)</option>
                </select>
              </div>

              <div style="margin-top: 32px;">
                <button type="submit" class="btn btn-primary">Save Changes</button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Widget Design Section -->
      <section class="section" id="section-widget">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                </svg>
                Widget Customization
              </div>
            </div>
            <div class="card-body">
              <form id="widgetForm" onsubmit="saveWidgetConfig(event)">
                <div class="form-group">
                  <label class="form-label">Primary Color</label>
                  <div class="color-picker-group">
                    <input type="color" class="color-input" id="widgetPrimaryColor" value="#2563eb">
                    <input type="text" class="form-input" id="widgetPrimaryColorText" value="#2563eb" style="flex: 1;">
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">Secondary Color</label>
                  <div class="color-picker-group">
                    <input type="color" class="color-input" id="widgetSecondaryColor" value="#7c3aed">
                    <input type="text" class="form-input" id="widgetSecondaryColorText" value="#7c3aed" style="flex: 1;">
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">Position</label>
                  <select class="form-select" id="widgetPosition">
                    <option value="bottom-right">Bottom Right</option>
                    <option value="bottom-left">Bottom Left</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">Welcome Message</label>
                  <input type="text" class="form-input" id="widgetWelcomeMessage" placeholder="Hi there! How can we help?">
                </div>

                <div class="form-group">
                  <label class="form-label">Offline Message</label>
                  <input type="text" class="form-input" id="widgetOfflineMessage" placeholder="We're offline. Leave a message!">
                </div>

                <h3 style="margin: 24px 0 16px; font-size: 15px; font-weight: 600;">Features</h3>

                <div class="toggle-group">
                  <div>
                    <div class="toggle-label">Show Agent Avatar</div>
                  </div>
                  <label class="toggle-switch">
                    <input type="checkbox" id="widgetShowAvatar" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>

                <div class="toggle-group">
                  <div>
                    <div class="toggle-label">Enable Emoji</div>
                  </div>
                  <label class="toggle-switch">
                    <input type="checkbox" id="widgetEnableEmoji" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>

                <div class="toggle-group">
                  <div>
                    <div class="toggle-label">Enable File Upload</div>
                  </div>
                  <label class="toggle-switch">
                    <input type="checkbox" id="widgetEnableFileUpload" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>

                <div class="toggle-group">
                  <div>
                    <div class="toggle-label">Sound Notifications</div>
                  </div>
                  <label class="toggle-switch">
                    <input type="checkbox" id="widgetEnableSound" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>

                <div style="margin-top: 24px;">
                  <button type="submit" class="btn btn-primary">Save Widget Settings</button>
                </div>
              </form>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">Live Preview</div>
            </div>
            <div class="card-body">
              <div class="widget-preview">
                <div class="preview-widget">
                  <div class="preview-header" id="previewHeader" style="background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);">
                    <div class="preview-avatar" id="previewAvatar" style="background: rgba(255,255,255,0.2);">S</div>
                    <div class="preview-info">
                      <h4>Support</h4>
                      <span style="color: rgba(255,255,255,0.8);">Online</span>
                    </div>
                  </div>
                  <div class="preview-messages">
                    <div class="preview-message support" id="previewMessage" style="background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);">
                      Hi there! How can we help you today?
                    </div>
                  </div>
                  <div class="preview-input">
                    <div class="preview-input-field">Type a message...</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Subscription Section -->
      <section class="section" id="section-subscription">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Current Plan
            </div>
          </div>
          <div class="card-body" id="planInfo">
            <div style="text-align: center; padding: 40px; color: #64748b;">Loading plan information...</div>
          </div>
        </div>

        <div class="card" style="margin-top: 24px;">
          <div class="card-header">
            <div class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              Usage This Month
            </div>
          </div>
          <div class="card-body" id="usageInfo">
            <div style="text-align: center; padding: 40px; color: #64748b;">Loading usage data...</div>
          </div>
        </div>

        <div class="card" style="margin-top: 24px;">
          <div class="card-header">
            <div class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
              </svg>
              Upgrade Plan
            </div>
          </div>
          <div class="card-body" id="upgradePlansContainer">
            <div style="text-align: center; padding: 40px; color: #64748b;">Loading available plans...</div>
          </div>
        </div>
      </section>

      <!-- Billing Section -->
      <section class="section" id="section-billing">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
              </svg>
              Billing Information
            </div>
          </div>
          <div class="card-body">
            <form id="billingForm" onsubmit="saveBillingInfo(event)">
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">Billing Email</label>
                  <input type="email" class="form-input" id="billingEmail" placeholder="billing@company.com">
                </div>
                <div class="form-group">
                  <label class="form-label">Billing Name</label>
                  <input type="text" class="form-input" id="billingName" placeholder="Company Inc.">
                </div>
                <div class="form-group">
                  <label class="form-label">Phone</label>
                  <input type="tel" class="form-input" id="billingPhone" placeholder="+1 (555) 000-0000">
                </div>
                <div class="form-group">
                  <label class="form-label">Tax ID</label>
                  <input type="text" class="form-input" id="billingTaxId" placeholder="US123456789">
                </div>
                <div class="form-group full">
                  <label class="form-label">Address Line 1</label>
                  <input type="text" class="form-input" id="billingAddress1" placeholder="123 Main Street">
                </div>
                <div class="form-group full">
                  <label class="form-label">Address Line 2</label>
                  <input type="text" class="form-input" id="billingAddress2" placeholder="Suite 100">
                </div>
                <div class="form-group">
                  <label class="form-label">City</label>
                  <input type="text" class="form-input" id="billingCity" placeholder="San Francisco">
                </div>
                <div class="form-group">
                  <label class="form-label">State/Province</label>
                  <input type="text" class="form-input" id="billingState" placeholder="California">
                </div>
                <div class="form-group">
                  <label class="form-label">Postal Code</label>
                  <input type="text" class="form-input" id="billingPostal" placeholder="94105">
                </div>
                <div class="form-group">
                  <label class="form-label">Country</label>
                  <input type="text" class="form-input" id="billingCountry" placeholder="United States">
                </div>
              </div>

              <div style="margin-top: 32px;">
                <button type="submit" class="btn btn-primary">Save Billing Info</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Invoices Card -->
        <div class="card" style="margin-top: 24px;">
          <div class="card-header">
            <div class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              Payment History & Invoices
            </div>
          </div>
          <div class="card-body">
            <div id="invoicesContainer">
              <div style="text-align: center; padding: 40px; color: #64748b;">
                <div class="loading-spinner" style="margin: 0 auto 16px;"></div>
                Loading invoices...
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>

<!-- Add Agent Modal -->
<div class="modal-overlay" id="addAgentModal">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">Add New Agent</h2>
      <button class="modal-close" onclick="closeModal('addAgentModal')">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <form onsubmit="addAgent(event)">
      <div class="form-group">
        <label class="form-label">Email Address</label>
        <input type="email" class="form-input" id="newAgentEmail" placeholder="agent@company.com" required>
        <div class="form-help">The agent must already have an account</div>
      </div>

      <h4 style="margin: 20px 0 12px; font-size: 14px; font-weight: 600;">Permissions</h4>

      <div class="toggle-group">
        <div class="toggle-label">Can View Conversations</div>
        <label class="toggle-switch">
          <input type="checkbox" id="newAgentCanView" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="toggle-group">
        <div class="toggle-label">Can Respond to Messages</div>
        <label class="toggle-switch">
          <input type="checkbox" id="newAgentCanRespond" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="toggle-group">
        <div class="toggle-label">Can Close Conversations</div>
        <label class="toggle-switch">
          <input type="checkbox" id="newAgentCanClose" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="toggle-group">
        <div class="toggle-label">Can Manage Settings (Admin)</div>
        <label class="toggle-switch">
          <input type="checkbox" id="newAgentCanManage">
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal('addAgentModal')">Cancel</button>
        <button type="submit" class="btn btn-primary">Add Agent</button>
      </div>
    </form>
  </div>
</div>

<!-- Add Message Modal -->
<div class="modal-overlay" id="addMessageModal">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">Add Welcome Message</h2>
      <button class="modal-close" onclick="closeModal('addMessageModal')">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <form onsubmit="addWelcomeMessage(event)">
      <div class="form-group">
        <label class="form-label">Message</label>
        <textarea class="form-input" id="newMessageText" rows="3" placeholder="Hi! Welcome to our support. How can I help you today?" required style="resize: vertical;"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal('addMessageModal')">Cancel</button>
        <button type="submit" class="btn btn-primary">Add Message</button>
      </div>
    </form>
  </div>
</div>

<!-- Upgrade Plan Modal -->
<div class="modal-overlay" id="upgradePlanModal">
  <div class="modal" style="max-width: 600px;">
    <div class="modal-header">
      <h2 class="modal-title">Upgrade Subscription Plan</h2>
      <button class="modal-close" onclick="closeModal('upgradePlanModal')">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div id="upgradePlanContent">
      <div style="text-align: center; padding: 40px; color: #64748b;">Loading plan details...</div>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div class="modal-overlay" id="paymentModal">
  <div class="modal" style="max-width: 500px;">
    <div class="modal-header">
      <h2 class="modal-title">Choose Payment Method</h2>
      <button class="modal-close" onclick="closeModal('paymentModal')">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div style="padding: 0 24px 24px;">
      <div id="paymentPlanSummary" style="background: #f8fafc; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
        <!-- Plan summary will be inserted here -->
      </div>

      <div class="form-group">
        <label class="form-label">Billing Cycle</label>
        <select class="form-input" id="billingCycle" onchange="updatePaymentSummary()">
          <option value="monthly">Monthly</option>
          <option value="yearly">Yearly (Save 20%)</option>
        </select>
      </div>

      <div id="paymentTotal" style="background: linear-gradient(135deg, #0ea5e9, #2563eb); color: white; border-radius: 8px; padding: 16px; margin: 20px 0; text-align: center;">
        <!-- Total will be inserted here -->
      </div>

      <div style="font-size: 14px; font-weight: 600; color: #64748b; margin-bottom: 12px; text-align: center;">Select Payment Method</div>

      <div style="display: flex; flex-direction: column; gap: 12px;">
        <!-- Razorpay Button -->
        <button onclick="payWithRazorpay()" class="btn" style="width: 100%; padding: 16px; background: #2563eb; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4.5 7.5L12 3l7.5 4.5v9L12 21l-7.5-4.5v-9zm7.5 9l6-3.5V8.5l-6 3.5v4.5zm-6-4.5l6 3.5V11L6 7.5v4.5zm6-1.5l6-3.5-6-3.5-6 3.5 6 3.5z"/>
          </svg>
          Pay with Razorpay
        </button>

        <!-- PayPal Button -->
        <button onclick="payWithPayPal()" class="btn" style="width: 100%; padding: 16px; background: #0070ba; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7.076 21.337H2.47a.641.641 0 0 1-.633-.74L4.944.901C5.026.382 5.474 0 5.998 0h7.46c2.57 0 4.578.543 5.69 1.81 1.01 1.15 1.304 2.42 1.012 4.287-.023.143-.047.288-.077.437-.983 5.05-4.349 6.797-8.647 6.797h-2.19c-.524 0-.968.382-1.05.9l-1.12 7.106zm14.146-14.42a3.35 3.35 0 0 0-.607-.541c-.013.076-.026.175-.041.254-.59 3.025-2.566 6.082-8.557 6.082H9.927l-1.67 10.588h4.083c.458 0 .85-.332.922-.784l.038-.196.73-4.617.047-.254c.071-.452.464-.784.922-.784h.58c3.761 0 6.705-1.528 7.566-5.95.36-1.847.174-3.388-.924-4.476z"/>
          </svg>
          Pay with PayPal
        </button>
      </div>

      <div style="text-align: center; margin-top: 16px; font-size: 12px; color: #94a3b8;">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 4px;">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
        </svg>
        Secure payment processing. Your data is encrypted.
      </div>

      <div class="modal-footer" style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
        <button type="button" class="btn btn-secondary" onclick="closeModal('paymentModal')" style="width: 100%;">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script src="/config.js"></script>
<script src="/branding.js"></script>
<script>
// ==================== CONFIG ====================
const params = new URLSearchParams(location.search);
const siteId = params.get("siteId");
const token = params.get("token");

if (!siteId || !token) {
  location.href = "/login";
}

const API_BASE = CONFIG.API_BASE;

// ==================== STATE ====================
let siteData = null;
let agents = [];
let welcomeMessages = [];
let widgetConfig = {};
let availablePlans = [];
let currentPlanId = null;
let selectedUpgradePlan = null;

// ==================== INIT ====================
document.addEventListener("DOMContentLoaded", async () => {
  setupNavigation();
  await loadAllData();
  hideLoading();
  // Handle PayPal return callback
  handlePayPalReturn();
});

async function loadAllData() {
  try {
    await Promise.all([
      loadSiteInfo(),
      loadAnalytics(),
      loadAgents(),
      loadWelcomeMessages(),
      loadWidgetConfig(),
      loadBillingInfo(),
      loadInvoices(),
      loadSubscriptionInfo(),
      loadAvailablePlans()
    ]);
  } catch (err) {
    console.error("Error loading data:", err);
    showToast("Failed to load some data", "error");
  }
}

// ==================== NAVIGATION ====================
function setupNavigation() {
  document.querySelectorAll(".nav-item").forEach(item => {
    item.addEventListener("click", () => {
      const section = item.dataset.section;
      showSection(section);
    });
  });

  // Knowledge Base link handler
  const knowledgeLink = document.getElementById("knowledgeBaseLink");
  if (knowledgeLink) {
    knowledgeLink.addEventListener("click", () => {
      window.location.href = `/knowledge-base.html?siteId=${siteId}&token=${token}`;
    });
  }
}

function showSection(sectionId) {
  // Update nav
  document.querySelectorAll(".nav-item").forEach(item => {
    item.classList.toggle("active", item.dataset.section === sectionId);
  });

  // Update sections
  document.querySelectorAll(".section").forEach(section => {
    section.classList.toggle("active", section.id === `section-${sectionId}`);
  });

  // Update title
  const titles = {
    overview: "Overview",
    agents: "Agents",
    messages: "Welcome Messages",
    settings: "Site Settings",
    widget: "Widget Design",
    subscription: "Subscription",
    billing: "Billing"
  };
  document.getElementById("sectionTitle").textContent = titles[sectionId] || "Dashboard";
}

// ==================== API HELPERS ====================
async function apiGet(endpoint) {
  console.log('API GET:', endpoint);
  try {
    const res = await fetch(`${API_BASE}${endpoint}`, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    console.log('API GET response:', res.status, res.statusText);
    if (!res.ok) {
      const text = await res.text();
      console.error('API error response:', text);
      throw new Error(`API error: ${res.status}`);
    }
    const text = await res.text();
    if (!text) {
      console.log('Empty response for:', endpoint);
      return null;
    }
    const data = JSON.parse(text);
    return data.success ? data.data : data;
  } catch (err) {
    console.error('API GET error:', endpoint, err);
    throw err;
  }
}

async function apiPost(endpoint, body) {
  console.log('API POST:', endpoint, body);
  try {
    const res = await fetch(`${API_BASE}${endpoint}`, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });
    if (!res.ok) {
      const text = await res.text();
      console.error('API POST error:', text);
      throw new Error(`API error: ${res.status}`);
    }
    const text = await res.text();
    if (!text) return null;
    return JSON.parse(text).data;
  } catch (err) {
    console.error('API POST error:', endpoint, err);
    throw err;
  }
}

async function apiPut(endpoint, body) {
  console.log('API PUT:', endpoint, body);
  try {
    const res = await fetch(`${API_BASE}${endpoint}`, {
      method: "PUT",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });
    if (!res.ok) {
      const text = await res.text();
      console.error('API PUT error:', text);
      throw new Error(`API error: ${res.status}`);
    }
    const text = await res.text();
    if (!text) return null;
    return JSON.parse(text).data;
  } catch (err) {
    console.error('API PUT error:', endpoint, err);
    throw err;
  }
}

async function apiDelete(endpoint) {
  console.log('API DELETE:', endpoint);
  try {
    const res = await fetch(`${API_BASE}${endpoint}`, {
      method: "DELETE",
      headers: { "Authorization": `Bearer ${token}` }
    });
    if (!res.ok) throw new Error(`API error: ${res.status}`);
    return true;
  } catch (err) {
    console.error('API DELETE error:', endpoint, err);
    throw err;
  }
}

// ==================== LOAD DATA ====================
async function loadSiteInfo() {
  siteData = await apiGet(`/sites/${siteId}`);
  document.getElementById("siteName").textContent = siteData.name || "My Site";
  document.getElementById("siteDomain").textContent = siteData.domain || "No domain";

  // Fill settings form
  document.getElementById("settingSiteName").value = siteData.name || "";
  document.getElementById("settingDomain").value = siteData.domain || "";
  document.getElementById("settingCompanyName").value = siteData.companyName || "";
  document.getElementById("settingCompanyWebsite").value = siteData.companyWebsite || "";
  document.getElementById("settingIndustry").value = siteData.industry || "";
  document.getElementById("settingTimezone").value = siteData.timezone || "UTC";
  document.getElementById("settingAiEnabled").checked = siteData.aiEnabled !== false;
  document.getElementById("settingAiModel").value = siteData.aiModel || "gpt-4o-mini";

  // Fill integration info
  updateApiKeyDisplay(siteData.apiKey || "");
  document.getElementById("displaySiteId").value = siteId;
  updateInstallCode();
}

// ==================== API KEY & INTEGRATION ====================
let apiKeyVisible = false;
let actualApiKey = "";

function updateApiKeyDisplay(key) {
  actualApiKey = key;
  const input = document.getElementById("siteApiKey");
  input.value = apiKeyVisible ? key : maskApiKey(key);
}

function maskApiKey(key) {
  if (!key) return "";
  return key.substring(0, 7) + "â€¢".repeat(20) + key.substring(key.length - 4);
}

function toggleKeyVisibility() {
  apiKeyVisible = !apiKeyVisible;
  const input = document.getElementById("siteApiKey");
  input.value = apiKeyVisible ? actualApiKey : maskApiKey(actualApiKey);
}

function copyApiKey() {
  navigator.clipboard.writeText(actualApiKey).then(() => {
    showToast("API key copied to clipboard!", "success");
  }).catch(() => {
    showToast("Failed to copy", "error");
  });
}

function copySiteId() {
  navigator.clipboard.writeText(siteId).then(() => {
    showToast("Site ID copied to clipboard!", "success");
  }).catch(() => {
    showToast("Failed to copy", "error");
  });
}

function copyInstallCode() {
  const code = document.getElementById("installCode").textContent;
  navigator.clipboard.writeText(code).then(() => {
    showToast("Installation code copied!", "success");
  }).catch(() => {
    showToast("Failed to copy", "error");
  });
}

function updateInstallCode() {
  const widgetUrl = CONFIG.WIDGET_URL;
  const code = '<!-- ChatApp Widget -->\n' +
    '<script>\n' +
    '  (function(w,d,s,o){\n' +
    '    w.ChatAppWidget=o;w[o]=w[o]||function(){(w[o].q=w[o].q||[]).push(arguments)};\n' +
    '    var js=d.createElement(s),fs=d.getElementsByTagName(s)[0];\n' +
    "    js.src='" + widgetUrl + "/static/widget.js';\n" +
    '    js.async=1;fs.parentNode.insertBefore(js,fs);\n' +
    "  })(window,document,'script','chatapp');\n" +
    '\n' +
    "  chatapp('init', {\n" +
    "    siteId: '" + siteId + "',\n" +
    "    apiKey: '" + actualApiKey + "'\n" +
    '  });\n' +
    '</' + 'script>';
  document.getElementById("installCode").textContent = code;
}

async function regenerateApiKey() {
  if (!confirm("Are you sure you want to regenerate your API key? The old key will stop working immediately.")) {
    return;
  }
  try {
    const result = await apiPost(`/sites/${siteId}/regenerate-api-key`, {});
    const newKey = result.apiKey || result;
    actualApiKey = newKey;
    updateApiKeyDisplay(newKey);
    updateInstallCode();
    showToast("API key regenerated!", "success");
  } catch (err) {
    showToast("Failed to regenerate API key", "error");
  }
}

async function loadAnalytics() {
  try {
    const stats = await apiGet(`/sites/${siteId}/analytics/dashboard`);
    renderStats(stats);
    renderAgentPerformance(stats.agentPerformance || []);
  } catch (err) {
    console.error("Analytics error:", err);
    renderStats({});
  }
}

function renderStats(stats) {
  document.getElementById("statsGrid").innerHTML = `
    <div class="stat-card">
      <div class="stat-icon blue">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
      </div>
      <div class="stat-value">${stats.totalConversations || 0}</div>
      <div class="stat-label">Total Conversations</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon green">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
      </div>
      <div class="stat-value">${stats.activeVisitors || 0}</div>
      <div class="stat-label">Active Visitors</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon purple">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <div class="stat-value">${formatTime(stats.averageResponseTime)}</div>
      <div class="stat-label">Avg Response Time</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon orange">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
        </svg>
      </div>
      <div class="stat-value">${stats.averageRating ? stats.averageRating.toFixed(1) : "N/A"}</div>
      <div class="stat-label">Avg Rating</div>
    </div>
  `;
}

function renderAgentPerformance(agentPerf) {
  const tbody = document.getElementById("agentPerformanceTable");
  if (!agentPerf.length) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #64748b;">No agent data available</td></tr>';
    return;
  }
  tbody.innerHTML = agentPerf.map(agent => `
    <tr>
      <td><strong>${escapeHtml(agent.agentName || "Unknown")}</strong></td>
      <td>${agent.conversationsHandled || 0}</td>
      <td>${formatTime(agent.averageResponseTime)}</td>
      <td>${agent.averageRating ? agent.averageRating.toFixed(1) : "N/A"}</td>
      <td>
        <span class="status-badge ${agent.isOnline ? 'online' : 'offline'}">
          <span class="status-dot"></span>
          ${agent.isOnline ? 'Online' : 'Offline'}
        </span>
      </td>
    </tr>
  `).join("");
}

async function loadAgents() {
  agents = await apiGet(`/sites/${siteId}/agents`);
  renderAgents();
}

function renderAgents() {
  const tbody = document.getElementById("agentsTable");
  if (!agents.length) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #64748b;">No agents added yet</td></tr>';
    return;
  }
  tbody.innerHTML = agents.map(agent => `
    <tr>
      <td><strong>${escapeHtml(agent.username || agent.firstName || "Unknown")}</strong></td>
      <td>${escapeHtml(agent.email || "")}</td>
      <td>
        <span class="status-badge ${agent.status === 'online' ? 'online' : 'offline'}">
          <span class="status-dot"></span>
          ${agent.status === 'online' ? 'Online' : 'Offline'}
        </span>
      </td>
      <td>${agent.canView ? 'Yes' : 'No'}</td>
      <td>${agent.canRespond ? 'Yes' : 'No'}</td>
      <td>${agent.canCloseConversations ? 'Yes' : 'No'}</td>
      <td>${agent.canManageSettings ? 'Yes' : 'No'}</td>
      <td>
        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="removeAgent('${agent.userId}')">Remove</button>
      </td>
    </tr>
  `).join("");
}

async function loadWelcomeMessages() {
  welcomeMessages = await apiGet(`/sites/${siteId}/welcome-messages`);
  renderWelcomeMessages();
}

function renderWelcomeMessages() {
  const container = document.getElementById("welcomeMessagesContainer");
  if (!welcomeMessages.length) {
    container.innerHTML = `
      <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
        <h3>No welcome messages</h3>
        <p>Add a message to greet customers automatically</p>
      </div>
    `;
    return;
  }

  container.innerHTML = welcomeMessages.map((msg, i) => `
    <div style="display: flex; align-items: center; gap: 16px; padding: 16px; background: #f8fafc; border-radius: 12px; margin-bottom: 12px;">
      <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">${i + 1}</div>
      <div style="flex: 1;">
        <div style="font-size: 14px; color: #1e293b;">${escapeHtml(msg.message)}</div>
        <div style="font-size: 12px; color: ${msg.isActive ? '#16a34a' : '#94a3b8'}; margin-top: 4px;">${msg.isActive ? 'Active' : 'Inactive'}</div>
      </div>
      <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="deleteWelcomeMessage('${msg.id}')">Delete</button>
    </div>
  `).join("");
}

const defaultWidgetConfig = {
  primaryColor: "#2563eb",
  secondaryColor: "#7c3aed",
  position: "bottom-right",
  welcomeMessage: "Hello! How can we help you today?",
  offlineMessage: "We're currently offline. Leave a message and we'll get back to you.",
  showAgentAvatar: true,
  enableEmoji: true,
  enableFileUpload: true,
  enableSoundNotifications: true
};

async function loadWidgetConfig() {
  try {
    widgetConfig = await apiGet(`/sites/${siteId}/widget-config`);
    if (!widgetConfig || Object.keys(widgetConfig).length === 0) {
      widgetConfig = { ...defaultWidgetConfig };
    }
    fillWidgetForm();
    updateWidgetPreview();
  } catch (err) {
    console.error("Widget config error:", err);
    widgetConfig = { ...defaultWidgetConfig };
    fillWidgetForm();
    updateWidgetPreview();
  }
}

function fillWidgetForm() {
  document.getElementById("widgetPrimaryColor").value = widgetConfig.primaryColor || "#2563eb";
  document.getElementById("widgetPrimaryColorText").value = widgetConfig.primaryColor || "#2563eb";
  document.getElementById("widgetSecondaryColor").value = widgetConfig.secondaryColor || "#7c3aed";
  document.getElementById("widgetSecondaryColorText").value = widgetConfig.secondaryColor || "#7c3aed";
  document.getElementById("widgetPosition").value = widgetConfig.position || "bottom-right";
  document.getElementById("widgetWelcomeMessage").value = widgetConfig.welcomeMessage || "";
  document.getElementById("widgetOfflineMessage").value = widgetConfig.offlineMessage || "";
  document.getElementById("widgetShowAvatar").checked = widgetConfig.showAgentAvatar !== false;
  document.getElementById("widgetEnableEmoji").checked = widgetConfig.enableEmoji !== false;
  document.getElementById("widgetEnableFileUpload").checked = widgetConfig.enableFileUpload !== false;
  document.getElementById("widgetEnableSound").checked = widgetConfig.enableSoundNotifications !== false;

  // Sync color inputs
  document.getElementById("widgetPrimaryColor").addEventListener("input", (e) => {
    document.getElementById("widgetPrimaryColorText").value = e.target.value;
    updateWidgetPreview();
  });
  document.getElementById("widgetSecondaryColor").addEventListener("input", (e) => {
    document.getElementById("widgetSecondaryColorText").value = e.target.value;
    updateWidgetPreview();
  });
}

function updateWidgetPreview() {
  const primary = document.getElementById("widgetPrimaryColor").value;
  const secondary = document.getElementById("widgetSecondaryColor").value;
  const gradient = `linear-gradient(135deg, ${primary} 0%, ${secondary} 100%)`;

  document.getElementById("previewHeader").style.background = gradient;
  document.getElementById("previewMessage").style.background = gradient;
  document.getElementById("previewAvatar").style.background = "rgba(255,255,255,0.2)";
}

async function loadBillingInfo() {
  try {
    const billing = await apiGet(`/sites/${siteId}/billing`);
    document.getElementById("billingEmail").value = billing.billingEmail || "";
    document.getElementById("billingName").value = billing.billingName || "";
    document.getElementById("billingPhone").value = billing.billingPhone || "";
    document.getElementById("billingTaxId").value = billing.taxId || "";
    document.getElementById("billingAddress1").value = billing.billingAddressLine1 || "";
    document.getElementById("billingAddress2").value = billing.billingAddressLine2 || "";
    document.getElementById("billingCity").value = billing.billingCity || "";
    document.getElementById("billingState").value = billing.billingState || "";
    document.getElementById("billingPostal").value = billing.billingPostalCode || "";
    document.getElementById("billingCountry").value = billing.billingCountry || "";
  } catch (err) {
    console.error("Billing error:", err);
  }
}

async function loadSubscriptionInfo() {
  try {
    const overview = await apiGet(`/subscriptions/sites/${siteId}/overview`);
    renderPlanInfo(overview);
    renderUsageInfo(overview);
  } catch (err) {
    console.error("Subscription error:", err);
    document.getElementById("planInfo").innerHTML = `
      <div style="text-align: center; padding: 40px; color: #ef4444;">
        Failed to load subscription information
      </div>
    `;
    document.getElementById("usageInfo").innerHTML = `
      <div style="text-align: center; padding: 40px; color: #ef4444;">
        Failed to load usage information
      </div>
    `;
  }
}

function renderPlanInfo(overview) {
  const container = document.getElementById("planInfo");

  if (!overview.plan) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div style="font-size: 48px; margin-bottom: 16px;">&#128274;</div>
        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">No Active Plan</div>
        <div style="color: #64748b; margin-bottom: 24px;">Contact support to get started with a plan.</div>
      </div>
    `;
    return;
  }

  const plan = overview.plan;
  const subscription = overview.subscription;

  // Save current plan ID for filtering upgrade options
  currentPlanId = plan.id;

  container.innerHTML = `
    <div style="display: flex; align-items: flex-start; gap: 24px; flex-wrap: wrap;">
      <div style="flex: 1; min-width: 280px;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
          <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #0ea5e9, #2563eb); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
            <svg width="24" height="24" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <div>
            <div style="font-size: 24px; font-weight: 700;">${plan.name}</div>
            <div style="color: #64748b; font-size: 14px;">${plan.description || 'Standard plan'}</div>
          </div>
        </div>

        ${subscription ? `
          <div style="display: flex; gap: 24px; flex-wrap: wrap; margin-top: 20px;">
            <div>
              <div style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Status</div>
              <div style="font-size: 14px; font-weight: 600; color: ${subscription.status === 'active' ? '#10b981' : '#f59e0b'}; margin-top: 4px;">
                ${subscription.status.charAt(0).toUpperCase() + subscription.status.slice(1)}
              </div>
            </div>
            <div>
              <div style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Billing Cycle</div>
              <div style="font-size: 14px; font-weight: 600; margin-top: 4px;">
                ${subscription.billingCycle.charAt(0).toUpperCase() + subscription.billingCycle.slice(1)}
              </div>
            </div>
            <div>
              <div style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Renews On</div>
              <div style="font-size: 14px; font-weight: 600; margin-top: 4px;">
                ${new Date(subscription.currentPeriodEnd).toLocaleDateString()}
              </div>
            </div>
          </div>
        ` : ''}
      </div>

      <div style="background: #f8fafc; border-radius: 12px; padding: 20px; min-width: 200px;">
        <div style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Plan Limits</div>
        <div style="display: grid; gap: 8px;">
          <div style="display: flex; justify-content: space-between; font-size: 14px;">
            <span style="color: #64748b;">Agents</span>
            <span style="font-weight: 600;">${plan.maxAgents || 'Unlimited'}</span>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 14px;">
            <span style="color: #64748b;">Conversations/mo</span>
            <span style="font-weight: 600;">${plan.maxConversationsPerMonth || 'Unlimited'}</span>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 14px;">
            <span style="color: #64748b;">Messages/mo</span>
            <span style="font-weight: 600;">${plan.maxMessagesPerMonth || 'Unlimited'}</span>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 14px;">
            <span style="color: #64748b;">Max File Size</span>
            <span style="font-weight: 600;">${plan.maxFileSizeMb || 10} MB</span>
          </div>
        </div>
      </div>
    </div>
  `;
}

function renderUsageInfo(overview) {
  const container = document.getElementById("usageInfo");
  const usage = overview.usage || [];

  if (usage.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #64748b;">
        No usage data available for this billing period.
      </div>
    `;
    return;
  }

  const usageItems = usage.map(item => {
    const percentage = item.percentageUsed || 0;
    const color = percentage > 90 ? '#ef4444' : percentage > 70 ? '#f59e0b' : '#10b981';

    return `
      <div style="background: #f8fafc; border-radius: 12px; padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <div style="font-size: 14px; font-weight: 600; text-transform: capitalize;">${item.metricName.replace(/_/g, ' ')}</div>
          <div style="font-size: 14px; color: #64748b;">
            <span style="font-weight: 600; color: #1e293b;">${item.used}</span> / ${item.limit || '&infin;'}
          </div>
        </div>
        <div style="height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
          <div style="height: 100%; width: ${Math.min(percentage, 100)}%; background: ${color}; border-radius: 4px; transition: width 0.3s;"></div>
        </div>
        <div style="font-size: 12px; color: #64748b; margin-top: 8px;">
          ${percentage.toFixed(1)}% used
        </div>
      </div>
    `;
  }).join('');

  container.innerHTML = `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
      ${usageItems}
    </div>
    <div style="margin-top: 16px; font-size: 12px; color: #64748b;">
      Period: ${usage[0] ? new Date(usage[0].periodStart).toLocaleDateString() : ''} - ${usage[0] ? new Date(usage[0].periodEnd).toLocaleDateString() : ''}
    </div>
  `;
}

// ==================== UPGRADE PLAN ====================
async function loadAvailablePlans() {
  try {
    const plans = await apiGet('/subscriptions/plans');
    availablePlans = plans || [];
    renderUpgradePlans();
  } catch (err) {
    console.error("Plans error:", err);
    document.getElementById("upgradePlansContainer").innerHTML = `
      <div style="text-align: center; padding: 40px; color: #ef4444;">
        Failed to load available plans
      </div>
    `;
  }
}

function renderUpgradePlans() {
  const container = document.getElementById("upgradePlansContainer");

  if (availablePlans.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #64748b;">
        No upgrade plans available at this time.
      </div>
    `;
    return;
  }

  // Filter out current plan
  const upgradePlans = availablePlans.filter(plan => plan.id !== currentPlanId);

  if (upgradePlans.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div style="font-size: 48px; margin-bottom: 16px;">&#127775;</div>
        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">You're on the best plan!</div>
        <div style="color: #64748b;">There are no higher tier plans available.</div>
      </div>
    `;
    return;
  }

  const plansHtml = upgradePlans.map(plan => {
    const isPopular = plan.name.toLowerCase().includes('pro') || plan.name.toLowerCase().includes('business');
    return `
      <div style="background: ${isPopular ? 'linear-gradient(135deg, #f0f9ff, #e0f2fe)' : '#f8fafc'}; border: 2px solid ${isPopular ? '#0ea5e9' : '#e2e8f0'}; border-radius: 16px; padding: 24px; position: relative; transition: transform 0.2s, box-shadow 0.2s;"
           onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 24px rgba(0,0,0,0.1)';"
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
        ${isPopular ? '<div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #0ea5e9, #2563eb); color: white; padding: 4px 16px; border-radius: 20px; font-size: 12px; font-weight: 600;">POPULAR</div>' : ''}

        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 24px; font-weight: 700; color: #1e293b;">${plan.name}</div>
          <div style="font-size: 14px; color: #64748b; margin-top: 4px;">${plan.description || 'Professional features'}</div>
        </div>

        <div style="text-align: center; margin-bottom: 24px;">
          <div style="display: flex; align-items: baseline; justify-content: center; gap: 4px;">
            <span style="font-size: 14px; color: #64748b;">$</span>
            <span style="font-size: 48px; font-weight: 800; color: #1e293b;">${plan.monthlyPrice || 0}</span>
            <span style="font-size: 14px; color: #64748b;">/mo</span>
          </div>
          <div style="font-size: 12px; color: #64748b; margin-top: 4px;">or $${plan.annualPrice || (plan.monthlyPrice * 12 * 0.8).toFixed(0)}/year (save 20%)</div>
        </div>

        <div style="display: grid; gap: 12px; margin-bottom: 24px;">
          <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
            <svg width="16" height="16" fill="none" stroke="#10b981" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
            </svg>
            <span>Up to ${plan.maxAgents || 'Unlimited'} agents</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
            <svg width="16" height="16" fill="none" stroke="#10b981" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
            </svg>
            <span>${plan.maxConversationsPerMonth || 'Unlimited'} conversations/mo</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
            <svg width="16" height="16" fill="none" stroke="#10b981" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
            </svg>
            <span>${plan.maxMessagesPerMonth || 'Unlimited'} messages/mo</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
            <svg width="16" height="16" fill="none" stroke="#10b981" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
            </svg>
            <span>${plan.maxFileSizeMb || 10} MB file uploads</span>
          </div>
        </div>

        <button onclick="selectUpgradePlan('${plan.id}')" class="btn btn-primary" style="width: 100%; padding: 12px; font-size: 16px;">
          Upgrade to ${plan.name}
        </button>
      </div>
    `;
  }).join('');

  container.innerHTML = `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px;">
      ${plansHtml}
    </div>
  `;
}

function selectUpgradePlan(planId) {
  selectedUpgradePlan = availablePlans.find(p => p.id === planId);
  if (!selectedUpgradePlan) {
    showToast("Plan not found", "error");
    return;
  }
  openPaymentModal();
}

function openPaymentModal() {
  if (!selectedUpgradePlan) return;

  const plan = selectedUpgradePlan;

  document.getElementById("paymentPlanSummary").innerHTML = `
    <div style="display: flex; align-items: center; gap: 16px;">
      <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #0ea5e9, #2563eb); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
        <svg width="24" height="24" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
        </svg>
      </div>
      <div>
        <div style="font-size: 18px; font-weight: 700;">${plan.name}</div>
        <div style="font-size: 14px; color: #64748b;">${plan.description || 'Upgrade your subscription'}</div>
      </div>
    </div>
  `;

  updatePaymentSummary();
  openModal('paymentModal');
}

function updatePaymentSummary() {
  if (!selectedUpgradePlan) return;

  const plan = selectedUpgradePlan;
  const billingCycle = document.getElementById("billingCycle").value;
  const isYearly = billingCycle === 'yearly';
  const price = isYearly ? (plan.annualPrice || plan.monthlyPrice * 12 * 0.8) : plan.monthlyPrice;
  const period = isYearly ? 'year' : 'month';

  document.getElementById("paymentTotal").innerHTML = `
    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">Total Amount</div>
    <div style="font-size: 32px; font-weight: 700;">$${price.toFixed(2)}<span style="font-size: 16px; font-weight: 400;">/${period}</span></div>
    ${isYearly ? '<div style="font-size: 12px; margin-top: 4px; opacity: 0.8;">You save 20% with yearly billing!</div>' : ''}
  `;
}

function formatCardNumber(input) {
  let value = input.value.replace(/\D/g, '');
  value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
  input.value = value.substring(0, 19);
}

function formatExpiry(input) {
  let value = input.value.replace(/\D/g, '');
  if (value.length >= 2) {
    value = value.substring(0, 2) + '/' + value.substring(2);
  }
  input.value = value.substring(0, 5);
}

// ==================== RAZORPAY PAYMENT ====================
async function payWithRazorpay() {
  if (!selectedUpgradePlan) {
    showToast("Please select a plan first", "error");
    return;
  }

  const billingCycle = document.getElementById("billingCycle").value;
  const isYearly = billingCycle === 'yearly';
  const amount = isYearly
    ? (selectedUpgradePlan.annualPrice || selectedUpgradePlan.monthlyPrice * 12 * 0.8)
    : selectedUpgradePlan.monthlyPrice;

  try {
    // Create Razorpay order on backend
    const orderResponse = await apiPost(`/sites/${siteId}/payments/razorpay/create-order`, {
      amount: amount,
      currency: selectedUpgradePlan.currency || "INR",
      planId: selectedUpgradePlan.id,
      billingCycle: billingCycle
    });

    // Open Razorpay checkout
    const options = {
      key: orderResponse.keyId,
      amount: amount * 100, // Razorpay expects amount in paise
      currency: orderResponse.currency || "INR",
      name: "ChatApp",
      description: `${selectedUpgradePlan.name} Plan - ${billingCycle} subscription`,
      order_id: orderResponse.orderId,
      handler: async function(response) {
        // Verify payment on backend
        try {
          const verifyResponse = await apiPost(`/sites/${siteId}/payments/razorpay/verify`, {
            razorpayOrderId: response.razorpay_order_id,
            razorpayPaymentId: response.razorpay_payment_id,
            razorpaySignature: response.razorpay_signature,
            siteId: siteId,
            planId: selectedUpgradePlan.id,
            billingCycle: billingCycle
          });

          if (verifyResponse.success) {
            showToast("Payment successful! Subscription upgraded.", "success");
            closeModal('paymentModal');
            await loadSubscriptionInfo();
            await loadAvailablePlans();
          } else {
            showToast(verifyResponse.message || "Payment verification failed", "error");
          }
        } catch (err) {
          console.error("Verification error:", err);
          showToast("Payment verification failed. Please contact support.", "error");
        }
      },
      prefill: {
        name: siteData?.companyName || "",
        email: siteData?.contactEmail || "",
      },
      theme: {
        color: "#2563eb"
      },
      modal: {
        ondismiss: function() {
          showToast("Payment cancelled", "info");
        }
      }
    };

    const razorpay = new Razorpay(options);
    razorpay.on('payment.failed', function(response) {
      showToast("Payment failed: " + response.error.description, "error");
    });
    razorpay.open();

  } catch (err) {
    console.error("Razorpay error:", err);
    showToast(err.message || "Failed to initiate payment", "error");
  }
}

// ==================== PAYPAL PAYMENT ====================
async function payWithPayPal() {
  if (!selectedUpgradePlan) {
    showToast("Please select a plan first", "error");
    return;
  }

  const billingCycle = document.getElementById("billingCycle").value;
  const isYearly = billingCycle === 'yearly';
  const amount = isYearly
    ? (selectedUpgradePlan.annualPrice || selectedUpgradePlan.monthlyPrice * 12 * 0.8)
    : selectedUpgradePlan.monthlyPrice;

  try {
    // Create PayPal order on backend
    const orderResponse = await apiPost(`/sites/${siteId}/payments/paypal/create-order`, {
      amount: amount,
      currency: "USD",
      planId: selectedUpgradePlan.id,
      billingCycle: billingCycle
    });

    // Store order details for capture callback
    sessionStorage.setItem('paypalOrderId', orderResponse.orderId);
    sessionStorage.setItem('paypalPlanId', selectedUpgradePlan.id);
    sessionStorage.setItem('paypalBillingCycle', billingCycle);

    // Redirect to PayPal approval URL
    if (orderResponse.approvalUrl) {
      window.location.href = orderResponse.approvalUrl;
    } else {
      throw new Error("PayPal approval URL not received");
    }

  } catch (err) {
    console.error("PayPal error:", err);
    showToast(err.message || "Failed to initiate PayPal payment", "error");
  }
}

// Handle PayPal return from approval
async function handlePayPalReturn() {
  const urlParams = new URLSearchParams(window.location.search);
  const payment = urlParams.get('payment');
  const provider = urlParams.get('provider');

  if (provider === 'paypal') {
    if (payment === 'success') {
      const orderId = sessionStorage.getItem('paypalOrderId');
      const planId = sessionStorage.getItem('paypalPlanId');
      const billingCycle = sessionStorage.getItem('paypalBillingCycle');

      if (orderId && planId) {
        try {
          const captureResponse = await apiPost(`/sites/${siteId}/payments/paypal/capture`, {
            orderId: orderId,
            planId: planId,
            billingCycle: billingCycle
          });

          if (captureResponse.success) {
            showToast("Payment successful! Subscription upgraded.", "success");
            // Clean up session storage
            sessionStorage.removeItem('paypalOrderId');
            sessionStorage.removeItem('paypalPlanId');
            sessionStorage.removeItem('paypalBillingCycle');
            // Reload subscription info
            await loadSubscriptionInfo();
            await loadAvailablePlans();
          } else {
            showToast(captureResponse.message || "PayPal capture failed", "error");
          }
        } catch (err) {
          console.error("PayPal capture error:", err);
          showToast("Failed to capture PayPal payment", "error");
        }
      }
    } else if (payment === 'cancelled') {
      showToast("PayPal payment was cancelled", "info");
      sessionStorage.removeItem('paypalOrderId');
      sessionStorage.removeItem('paypalPlanId');
      sessionStorage.removeItem('paypalBillingCycle');
    }

    // Clean up URL parameters
    const cleanUrl = window.location.pathname + '?siteId=' + siteId + '&token=' + token;
    window.history.replaceState({}, document.title, cleanUrl);
  }
}

// ==================== SAVE DATA ====================
async function saveSiteSettings(e) {
  e.preventDefault();
  try {
    await apiPut(`/sites/${siteId}`, {
      name: document.getElementById("settingSiteName").value,
      domain: document.getElementById("settingDomain").value,
      companyName: document.getElementById("settingCompanyName").value,
      companyWebsite: document.getElementById("settingCompanyWebsite").value,
      industry: document.getElementById("settingIndustry").value,
      timezone: document.getElementById("settingTimezone").value,
      aiEnabled: document.getElementById("settingAiEnabled").checked,
      aiModel: document.getElementById("settingAiModel").value
    });
    showToast("Settings saved!", "success");
    loadSiteInfo();
  } catch (err) {
    showToast("Failed to save settings", "error");
  }
}

async function saveWidgetConfig(e) {
  e.preventDefault();
  try {
    await apiPut(`/sites/${siteId}/widget-config`, {
      primaryColor: document.getElementById("widgetPrimaryColor").value,
      secondaryColor: document.getElementById("widgetSecondaryColor").value,
      position: document.getElementById("widgetPosition").value,
      welcomeMessage: document.getElementById("widgetWelcomeMessage").value,
      offlineMessage: document.getElementById("widgetOfflineMessage").value,
      showAgentAvatar: document.getElementById("widgetShowAvatar").checked,
      enableEmoji: document.getElementById("widgetEnableEmoji").checked,
      enableFileUpload: document.getElementById("widgetEnableFileUpload").checked,
      enableSoundNotifications: document.getElementById("widgetEnableSound").checked
    });
    showToast("Widget settings saved!", "success");
  } catch (err) {
    showToast("Failed to save widget settings", "error");
  }
}

async function saveBillingInfo(e) {
  e.preventDefault();
  try {
    await apiPut(`/sites/${siteId}/billing`, {
      billingEmail: document.getElementById("billingEmail").value,
      billingName: document.getElementById("billingName").value,
      billingPhone: document.getElementById("billingPhone").value,
      taxId: document.getElementById("billingTaxId").value,
      billingAddressLine1: document.getElementById("billingAddress1").value,
      billingAddressLine2: document.getElementById("billingAddress2").value,
      billingCity: document.getElementById("billingCity").value,
      billingState: document.getElementById("billingState").value,
      billingPostalCode: document.getElementById("billingPostal").value,
      billingCountry: document.getElementById("billingCountry").value
    });
    showToast("Billing info saved!", "success");
  } catch (err) {
    showToast("Failed to save billing info", "error");
  }
}

// ==================== INVOICES ====================
async function loadInvoices() {
  const container = document.getElementById("invoicesContainer");
  try {
    const response = await apiGet(`/sites/${siteId}/payments/invoices`);
    const invoices = response.items || [];

    if (invoices.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #64748b;">
          <svg xmlns="http://www.w3.org/2000/svg" style="width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <p>No invoices yet</p>
          <p style="font-size: 14px; margin-top: 8px;">Invoices will appear here after your first payment</p>
        </div>
      `;
      return;
    }

    container.innerHTML = `
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 1px solid #e2e8f0;">
              <th style="text-align: left; padding: 12px 16px; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase;">Date</th>
              <th style="text-align: left; padding: 12px 16px; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase;">Invoice #</th>
              <th style="text-align: left; padding: 12px 16px; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase;">Amount</th>
              <th style="text-align: left; padding: 12px 16px; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase;">Status</th>
              <th style="text-align: left; padding: 12px 16px; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase;">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${invoices.map(invoice => `
              <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 16px; color: #334155;">${new Date(invoice.createdAt).toLocaleDateString()}</td>
                <td style="padding: 16px; font-family: monospace; font-weight: 500; color: #334155;">${invoice.invoiceNumber}</td>
                <td style="padding: 16px; font-weight: 600; color: #10b981;">${invoice.currency} ${invoice.total.toLocaleString()}</td>
                <td style="padding: 16px;">
                  <span style="display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; ${getInvoiceStatusStyle(invoice.status)}">
                    ${invoice.status.toUpperCase()}
                  </span>
                </td>
                <td style="padding: 16px;">
                  <button onclick="downloadSiteInvoice('${invoice.id}', '${invoice.stripeInvoicePdf || ''}')" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px; display: inline-flex; align-items: center; gap: 8px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                      <polyline points="7 10 12 15 17 10"></polyline>
                      <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Download
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  } catch (err) {
    console.error("Error loading invoices:", err);
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #ef4444;">
        <p>Failed to load invoices</p>
        <button onclick="loadInvoices()" class="btn btn-secondary" style="margin-top: 16px;">Try Again</button>
      </div>
    `;
  }
}

function getInvoiceStatusStyle(status) {
  switch (status) {
    case 'paid': return 'background: #dcfce7; color: #166534;';
    case 'open': return 'background: #fef3c7; color: #92400e;';
    case 'draft': return 'background: #f1f5f9; color: #64748b;';
    case 'void': return 'background: #fee2e2; color: #991b1b;';
    default: return 'background: #f1f5f9; color: #64748b;';
  }
}

function downloadSiteInvoice(invoiceId, pdfUrl) {
  // If there's a direct PDF URL (from Stripe), use it
  if (pdfUrl) {
    window.open(pdfUrl, '_blank');
    return;
  }

  // Otherwise, use our download endpoint
  const downloadUrl = `${API_BASE}/sites/${siteId}/payments/invoices/${invoiceId}/download`;
  window.open(downloadUrl, '_blank');
}

// ==================== AGENTS ====================
function showAddAgentModal() {
  document.getElementById("addAgentModal").classList.add("show");
}

async function addAgent(e) {
  e.preventDefault();
  try {
    await apiPost(`/sites/${siteId}/agents`, {
      email: document.getElementById("newAgentEmail").value,
      canView: document.getElementById("newAgentCanView").checked,
      canRespond: document.getElementById("newAgentCanRespond").checked,
      canCloseConversations: document.getElementById("newAgentCanClose").checked,
      canManageSettings: document.getElementById("newAgentCanManage").checked
    });
    closeModal("addAgentModal");
    showToast("Agent added!", "success");
    loadAgents();
  } catch (err) {
    showToast("Failed to add agent. Make sure the user exists.", "error");
  }
}

async function removeAgent(userId) {
  if (!confirm("Remove this agent from the site?")) return;
  try {
    await apiDelete(`/sites/${siteId}/agents/${userId}`);
    showToast("Agent removed", "success");
    loadAgents();
  } catch (err) {
    showToast("Failed to remove agent", "error");
  }
}

// ==================== WELCOME MESSAGES ====================
function showAddMessageModal() {
  document.getElementById("addMessageModal").classList.add("show");
}

async function addWelcomeMessage(e) {
  e.preventDefault();
  try {
    await apiPost(`/sites/${siteId}/welcome-messages`, {
      message: document.getElementById("newMessageText").value
    });
    closeModal("addMessageModal");
    document.getElementById("newMessageText").value = "";
    showToast("Message added!", "success");
    loadWelcomeMessages();
  } catch (err) {
    showToast("Failed to add message", "error");
  }
}

async function deleteWelcomeMessage(id) {
  if (!confirm("Delete this welcome message?")) return;
  try {
    await apiDelete(`/sites/${siteId}/welcome-messages/${id}`);
    showToast("Message deleted", "success");
    loadWelcomeMessages();
  } catch (err) {
    showToast("Failed to delete message", "error");
  }
}

// ==================== HELPERS ====================
function openModal(id) {
  document.getElementById(id).classList.add("show");
}

function closeModal(id) {
  document.getElementById(id).classList.remove("show");
}

function hideLoading() {
  document.getElementById("loadingOverlay").style.display = "none";
}

function formatTime(seconds) {
  if (!seconds) return "N/A";
  if (seconds < 60) return `${Math.round(seconds)}s`;
  if (seconds < 3600) return `${Math.round(seconds / 60)}m`;
  return `${Math.round(seconds / 3600)}h`;
}

function escapeHtml(text) {
  if (!text) return "";
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

function showToast(message, type = "success") {
  const container = document.getElementById("toastContainer");
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="${type === 'success' ? '#22c55e' : '#ef4444'}">
      ${type === 'success'
        ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />'
        : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />'}
    </svg>
    <span>${escapeHtml(message)}</span>
  `;
  container.appendChild(toast);
  setTimeout(() => {
    toast.style.animation = "slideIn 0.3s ease reverse";
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function logout() {
  location.href = "/login";
}

// Close modals on overlay click
document.querySelectorAll(".modal-overlay").forEach(modal => {
  modal.addEventListener("click", (e) => {
    if (e.target === modal) {
      modal.classList.remove("show");
    }
  });
});
</script>
</body>
</html>
