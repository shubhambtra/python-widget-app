<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Platform Reports - Assistica AI Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="admin-dashboard.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.reports-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1.5rem;
  margin-bottom: 2rem;
}
@media (max-width: 1200px) {
  .reports-grid {
    grid-template-columns: 1fr;
  }
}
.chart-card {
  background: var(--card-bg);
  border-radius: 12px;
  padding: 1.5rem;
  border: 1px solid var(--border-color);
}
.chart-card.full-width {
  grid-column: 1 / -1;
}
.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}
.chart-title {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.chart-title svg {
  width: 20px;
  height: 20px;
  color: var(--primary-color);
}
.chart-container {
  position: relative;
  height: 300px;
}
.chart-container.small {
  height: 250px;
}
.date-filter {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}
.date-filter select,
.date-filter input {
  padding: 0.5rem 0.75rem;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  background: var(--input-bg, var(--card-bg));
  color: var(--text-primary);
  font-size: 0.875rem;
}
.filter-btn {
  padding: 0.5rem 1rem;
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.875rem;
}
.filter-btn:hover {
  opacity: 0.9;
}
.stats-summary {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  margin-bottom: 1.5rem;
}
@media (max-width: 1200px) {
  .stats-summary {
    grid-template-columns: repeat(3, 1fr);
  }
}
@media (max-width: 768px) {
  .stats-summary {
    grid-template-columns: repeat(2, 1fr);
  }
}
.summary-card {
  background: var(--card-bg);
  border-radius: 10px;
  padding: 1.25rem;
  border: 1px solid var(--border-color);
  text-align: center;
}
.summary-value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--primary-color);
}
.summary-label {
  font-size: 0.875rem;
  color: var(--text-secondary);
  margin-top: 0.25rem;
}
</style>
</head>

<body>

<div class="toast" id="toast"></div>

<!-- Sidebar -->
<aside class="sidebar">
  <a href="/" class="sidebar-logo">
    <div class="logo-icon" data-brand="icon">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
      </svg>
    </div>
    <span><span data-brand="name">Assistica AI</span> Admin</span>
  </a>

  <nav class="sidebar-nav" id="sidebarNav">
    <a href="#" class="nav-item" data-page="admin-dashboard.html">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
      </svg>
      <span>Dashboard</span>
    </a>
    <a href="#" class="nav-item" data-page="admin-dashboard.html" id="navSites">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
      </svg>
      <span>All Sites</span>
    </a>
    <a href="#" class="nav-item" data-page="admin-users.html">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
      </svg>
      <span>Users</span>
    </a>
    <a href="#" class="nav-item" data-page="admin-conversations.html">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
      </svg>
      <span>Conversations</span>
    </a>
    <a href="#" class="nav-item active" data-page="admin-reports.html">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
      </svg>
      <span>Reports</span>
    </a>
    <a href="#" class="nav-item" data-page="admin-plans.html">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
      </svg>
      <span>Plans</span>
    </a>
    <a href="#" class="nav-item" data-page="admin-payments.html">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
      </svg>
      <span>Payments</span>
    </a>
    <a href="#" class="nav-item" data-page="admin-subscriptions.html">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
      </svg>
      <span>Subscriptions</span>
    </a>
    <a href="#" class="nav-item" data-page="admin-settings.html">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
      <span>Settings</span>
    </a>
  </nav>

  <div class="sidebar-footer">
    <div class="user-info">
      <div class="user-avatar" id="userAvatar">A</div>
      <div class="user-details">
        <div class="name" id="userName">Admin</div>
        <div class="role">Platform Owner</div>
      </div>
    </div>
    <button class="logout-btn" onclick="logout()">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
      </svg>
      <span>Logout</span>
    </button>
  </div>
</aside>

<!-- Main Content -->
<main class="main-content">
  <div class="page-header">
    <div>
      <h1>Platform Reports</h1>
      <p>Analytics and insights across all sites</p>
    </div>
    <div class="date-filter">
      <select id="dateRange" onchange="handleDateRangeChange()">
        <option value="7">Last 7 days</option>
        <option value="30" selected>Last 30 days</option>
        <option value="90">Last 90 days</option>
        <option value="custom">Custom Range</option>
      </select>
      <input type="date" id="startDate" style="display: none;" />
      <input type="date" id="endDate" style="display: none;" />
      <button class="filter-btn" onclick="loadReports()">Apply</button>
    </div>
  </div>

  <!-- Summary Stats -->
  <div class="stats-summary">
    <div class="summary-card">
      <div class="summary-value" id="totalSites">-</div>
      <div class="summary-label">Total Sites</div>
    </div>
    <div class="summary-card">
      <div class="summary-value" id="totalUsers">-</div>
      <div class="summary-label">Total Users</div>
    </div>
    <div class="summary-card">
      <div class="summary-value" id="totalConvs">-</div>
      <div class="summary-label">Total Conversations</div>
    </div>
    <div class="summary-card">
      <div class="summary-value" id="activeSubscriptions">-</div>
      <div class="summary-label">Active Subscriptions</div>
    </div>
    <div class="summary-card">
      <div class="summary-value" id="totalRevenue">-</div>
      <div class="summary-label">Total Revenue</div>
    </div>
  </div>

  <!-- Charts Grid -->
  <div class="reports-grid">
    <!-- Conversations by Site -->
    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
          </svg>
          Conversations by Site
        </div>
      </div>
      <div class="chart-container">
        <canvas id="siteConvsChart"></canvas>
      </div>
    </div>

    <!-- Conversations by Intent -->
    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
          </svg>
          Conversations by Intent
        </div>
      </div>
      <div class="chart-container">
        <canvas id="intentChart"></canvas>
      </div>
    </div>

    <!-- Conversations Over Time -->
    <div class="chart-card full-width">
      <div class="chart-header">
        <div class="chart-title">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
          </svg>
          Conversations Over Time
        </div>
      </div>
      <div class="chart-container">
        <canvas id="timelineChart"></canvas>
      </div>
    </div>

    <!-- Users by Plan -->
    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          Sites by Plan
        </div>
      </div>
      <div class="chart-container">
        <canvas id="planChart"></canvas>
      </div>
    </div>

    <!-- Site Status -->
    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Site Status Distribution
        </div>
      </div>
      <div class="chart-container">
        <canvas id="siteStatusChart"></canvas>
      </div>
    </div>

    <!-- Revenue Over Time -->
    <div class="chart-card full-width">
      <div class="chart-header">
        <div class="chart-title">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Revenue Over Time
        </div>
      </div>
      <div class="chart-container">
        <canvas id="revenueChart"></canvas>
      </div>
    </div>

    <!-- New Registrations -->
    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
          </svg>
          New Registrations
        </div>
      </div>
      <div class="chart-container">
        <canvas id="registrationsChart"></canvas>
      </div>
    </div>

    <!-- Top Sites by Conversations -->
    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          Top Sites by Conversations
        </div>
      </div>
      <div class="chart-container">
        <canvas id="topSitesChart"></canvas>
      </div>
    </div>
  </div>
</main>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
</div>

<script src="/config.js"></script>
<script src="/branding.js"></script>
<script src="/js/admin-shared.js"></script>
<script>
// Chart instances
let siteConvsChart, intentChart, timelineChart, planChart, siteStatusChart, revenueChart, registrationsChart, topSitesChart;

// Chart colors
const chartColors = [
  '#6366f1', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6',
  '#06b6d4', '#ec4899', '#14b8a6', '#f97316', '#84cc16'
];

// Check auth on load
if (!checkAuth()) {
  // checkAuth will redirect
}

async function apiGet(endpoint) {
  const response = await apiFetch(`${API_BASE}${endpoint}`);
  return await handleApiResponse(response, 'API request failed');
}

function showLoading() {
  document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
  document.getElementById('loadingOverlay').style.display = 'none';
}

// showToast is provided by admin-shared.js

function handleDateRangeChange() {
  const dateRange = document.getElementById('dateRange').value;
  const startDate = document.getElementById('startDate');
  const endDate = document.getElementById('endDate');
  if (dateRange === 'custom') {
    startDate.style.display = 'block';
    endDate.style.display = 'block';
  } else {
    startDate.style.display = 'none';
    endDate.style.display = 'none';
  }
}

function getDateRange() {
  const rangeValue = document.getElementById('dateRange').value;
  const endDate = new Date();
  let startDate = new Date();
  if (rangeValue === 'custom') {
    const customStart = document.getElementById('startDate').value;
    const customEnd = document.getElementById('endDate').value;
    if (customStart && customEnd) {
      return { start: new Date(customStart), end: new Date(customEnd) };
    }
  }
  startDate.setDate(endDate.getDate() - parseInt(rangeValue));
  return { start: startDate, end: endDate };
}

async function loadReports() {
  showLoading();
  try {
    // Load all data
    const [sites, users, conversations, subscriptions, payments] = await Promise.all([
      apiGet('/api/sites'),
      apiGet('/api/users'),
      apiGet('/api/conversations').catch(() => []),
      apiGet('/api/subscriptions').catch(() => []),
      apiGet('/api/payments').catch(() => [])
    ]);

    const dateRange = getDateRange();

    // Filter conversations by date
    const filteredConvs = (conversations || []).filter(c => {
      const convDate = new Date(c.startedAt || c.createdAt);
      return convDate >= dateRange.start && convDate <= dateRange.end;
    });

    // Update summary
    updateSummary(sites, users, filteredConvs, subscriptions, payments);

    // Render charts
    renderSiteConvsChart(filteredConvs, sites);
    renderIntentChart(filteredConvs);
    renderTimelineChart(filteredConvs, dateRange);
    renderPlanChart(sites);
    renderSiteStatusChart(sites);
    renderRevenueChart(payments, dateRange);
    renderRegistrationsChart(users, dateRange);
    renderTopSitesChart(filteredConvs, sites);

  } catch (err) {
    console.error('Error loading reports:', err);
    showToast('Error loading reports', 'error');
  } finally {
    hideLoading();
  }
}

function updateSummary(sites, users, conversations, subscriptions, payments) {
  document.getElementById('totalSites').textContent = sites?.length || 0;
  document.getElementById('totalUsers').textContent = users?.length || 0;
  document.getElementById('totalConvs').textContent = conversations?.length || 0;

  const activeSubsCount = (subscriptions || []).filter(s => s.status === 'active').length;
  document.getElementById('activeSubscriptions').textContent = activeSubsCount;

  const totalRev = (payments || [])
    .filter(p => p.status === 'success' || p.status === 'completed')
    .reduce((sum, p) => sum + (p.amount || 0), 0);
  document.getElementById('totalRevenue').textContent = '$' + totalRev.toLocaleString();
}

function renderSiteConvsChart(conversations, sites) {
  const ctx = document.getElementById('siteConvsChart').getContext('2d');

  const siteMap = {};
  sites.forEach(s => siteMap[s.id] = s.name || s.domain || 'Unknown');

  const siteCounts = {};
  conversations.forEach(c => {
    const siteName = siteMap[c.siteId] || c.siteName || 'Unknown';
    siteCounts[siteName] = (siteCounts[siteName] || 0) + 1;
  });

  const labels = Object.keys(siteCounts).slice(0, 10);
  const data = labels.map(l => siteCounts[l]);

  if (siteConvsChart) siteConvsChart.destroy();

  siteConvsChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: chartColors.slice(0, labels.length),
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: { color: '#94a3b8', padding: 10, usePointStyle: true }
        }
      }
    }
  });
}

function renderIntentChart(conversations) {
  const ctx = document.getElementById('intentChart').getContext('2d');

  const intentCounts = {};
  conversations.forEach(c => {
    const tags = c.tags || [];
    if (tags.length === 0) {
      intentCounts['No Intent'] = (intentCounts['No Intent'] || 0) + 1;
    } else {
      tags.forEach(tag => {
        intentCounts[tag] = (intentCounts[tag] || 0) + 1;
      });
    }
  });

  const labels = Object.keys(intentCounts);
  const data = Object.values(intentCounts);

  if (intentChart) intentChart.destroy();

  intentChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: chartColors.slice(0, labels.length),
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: { color: '#94a3b8', padding: 10, usePointStyle: true }
        }
      }
    }
  });
}

function renderTimelineChart(conversations, dateRange) {
  const ctx = document.getElementById('timelineChart').getContext('2d');

  const dateCounts = {};
  const currentDate = new Date(dateRange.start);
  while (currentDate <= dateRange.end) {
    const dateKey = currentDate.toISOString().split('T')[0];
    dateCounts[dateKey] = 0;
    currentDate.setDate(currentDate.getDate() + 1);
  }

  conversations.forEach(c => {
    const date = new Date(c.startedAt || c.createdAt).toISOString().split('T')[0];
    if (dateCounts.hasOwnProperty(date)) {
      dateCounts[date]++;
    }
  });

  const labels = Object.keys(dateCounts).map(d => {
    const date = new Date(d);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  });
  const data = Object.values(dateCounts);

  if (timelineChart) timelineChart.destroy();

  timelineChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Conversations',
        data: data,
        borderColor: '#6366f1',
        backgroundColor: 'rgba(99, 102, 241, 0.1)',
        fill: true,
        tension: 0.4,
        pointRadius: 3,
        pointBackgroundColor: '#6366f1'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { display: false }, ticks: { color: '#94a3b8', maxRotation: 45 } },
        y: { beginAtZero: true, grid: { color: 'rgba(100, 116, 139, 0.1)' }, ticks: { color: '#94a3b8', stepSize: 1 } }
      }
    }
  });
}

function renderPlanChart(sites) {
  const ctx = document.getElementById('planChart').getContext('2d');

  const planCounts = {};
  sites.forEach(s => {
    const plan = s.planName || s.plan || 'Free';
    planCounts[plan] = (planCounts[plan] || 0) + 1;
  });

  const labels = Object.keys(planCounts);
  const data = Object.values(planCounts);

  if (planChart) planChart.destroy();

  planChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: ['#22c55e', '#6366f1', '#f59e0b', '#ef4444'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: { color: '#94a3b8', padding: 10, usePointStyle: true }
        }
      }
    }
  });
}

function renderSiteStatusChart(sites) {
  const ctx = document.getElementById('siteStatusChart').getContext('2d');

  const statusCounts = { active: 0, inactive: 0, suspended: 0 };
  sites.forEach(s => {
    const status = s.status || 'active';
    statusCounts[status] = (statusCounts[status] || 0) + 1;
  });

  if (siteStatusChart) siteStatusChart.destroy();

  siteStatusChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Active', 'Inactive', 'Suspended'],
      datasets: [{
        data: [statusCounts.active, statusCounts.inactive, statusCounts.suspended],
        backgroundColor: ['#22c55e', '#64748b', '#ef4444'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: { color: '#94a3b8', padding: 10, usePointStyle: true }
        }
      }
    }
  });
}

function renderRevenueChart(payments, dateRange) {
  const ctx = document.getElementById('revenueChart').getContext('2d');

  const dateCounts = {};
  const currentDate = new Date(dateRange.start);
  while (currentDate <= dateRange.end) {
    const dateKey = currentDate.toISOString().split('T')[0];
    dateCounts[dateKey] = 0;
    currentDate.setDate(currentDate.getDate() + 1);
  }

  (payments || []).forEach(p => {
    if (p.status === 'success' || p.status === 'completed') {
      const date = new Date(p.createdAt || p.paidAt).toISOString().split('T')[0];
      if (dateCounts.hasOwnProperty(date)) {
        dateCounts[date] += (p.amount || 0);
      }
    }
  });

  const labels = Object.keys(dateCounts).map(d => {
    const date = new Date(d);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  });
  const data = Object.values(dateCounts);

  if (revenueChart) revenueChart.destroy();

  revenueChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Revenue ($)',
        data: data,
        backgroundColor: '#22c55e',
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { display: false }, ticks: { color: '#94a3b8', maxRotation: 45 } },
        y: { beginAtZero: true, grid: { color: 'rgba(100, 116, 139, 0.1)' }, ticks: { color: '#94a3b8' } }
      }
    }
  });
}

function renderRegistrationsChart(users, dateRange) {
  const ctx = document.getElementById('registrationsChart').getContext('2d');

  const dateCounts = {};
  const currentDate = new Date(dateRange.start);
  while (currentDate <= dateRange.end) {
    const dateKey = currentDate.toISOString().split('T')[0];
    dateCounts[dateKey] = 0;
    currentDate.setDate(currentDate.getDate() + 1);
  }

  (users || []).forEach(u => {
    const date = new Date(u.createdAt || u.registeredAt).toISOString().split('T')[0];
    if (dateCounts.hasOwnProperty(date)) {
      dateCounts[date]++;
    }
  });

  const labels = Object.keys(dateCounts).map(d => {
    const date = new Date(d);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  });
  const data = Object.values(dateCounts);

  if (registrationsChart) registrationsChart.destroy();

  registrationsChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'New Users',
        data: data,
        borderColor: '#8b5cf6',
        backgroundColor: 'rgba(139, 92, 246, 0.1)',
        fill: true,
        tension: 0.4,
        pointRadius: 3,
        pointBackgroundColor: '#8b5cf6'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { display: false }, ticks: { color: '#94a3b8', maxRotation: 45 } },
        y: { beginAtZero: true, grid: { color: 'rgba(100, 116, 139, 0.1)' }, ticks: { color: '#94a3b8', stepSize: 1 } }
      }
    }
  });
}

function renderTopSitesChart(conversations, sites) {
  const ctx = document.getElementById('topSitesChart').getContext('2d');

  const siteMap = {};
  sites.forEach(s => siteMap[s.id] = s.name || s.domain || 'Unknown');

  const siteCounts = {};
  conversations.forEach(c => {
    const siteName = siteMap[c.siteId] || c.siteName || 'Unknown';
    siteCounts[siteName] = (siteCounts[siteName] || 0) + 1;
  });

  const sorted = Object.entries(siteCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
  const labels = sorted.map(s => s[0]);
  const data = sorted.map(s => s[1]);

  if (topSitesChart) topSitesChart.destroy();

  topSitesChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Conversations',
        data: data,
        backgroundColor: '#6366f1',
        borderRadius: 6
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { beginAtZero: true, grid: { color: 'rgba(100, 116, 139, 0.1)' }, ticks: { color: '#94a3b8' } },
        y: { grid: { display: false }, ticks: { color: '#94a3b8' } }
      }
    }
  });
}

// logout is provided by admin-shared.js

// Navigation
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', (e) => {
    e.preventDefault();
    const page = item.dataset.page;
    if (page) window.location.href = buildAdminUrl('/admin/' + page);
  });
});

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  loadReports();
});
</script>
</body>
</html>
