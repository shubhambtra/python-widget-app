<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Support</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script src="/config.js"></script>

<style>
:root {
  --widget-primary: #2563eb;
  --widget-secondary: #8b5cf6;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  height: 100%;
  background: transparent;
  overflow: hidden;
}

/* ==================== CHAT CONTAINER ==================== */
.chat-widget {
  height: 100%;
  display: flex;
  flex-direction: column;
  background: #fff;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
}

/* ==================== HEADER ==================== */
.chat-header {
  background: linear-gradient(135deg, var(--widget-primary) 0%, var(--widget-secondary) 100%);
  color: white;
  padding: 16px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.header-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-avatar {
  width: 40px;
  height: 40px;
  background: rgba(255,255,255,0.2);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.header-avatar-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: inherit;
}

.header-text h3 {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 2px;
}

.header-text p {
  font-size: 12px;
  opacity: 0.9;
}

.header-text p.online,
.header-text p.away,
.header-text p.busy {
  display: flex;
  align-items: center;
  gap: 6px;
}

.header-text p.online::before,
.header-text p.away::before,
.header-text p.busy::before {
  content: '';
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.header-text p.online::before {
  background: #22c55e;
  box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
}

.header-text p.away::before {
  background: #f59e0b;
  box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);
}

.header-text p.busy::before {
  background: #ef4444;
  box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
}

.btn-collapse {
  width: 32px;
  height: 32px;
  background: rgba(255,255,255,0.15);
  border: none;
  border-radius: 8px;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.btn-collapse:hover {
  background: rgba(255,255,255,0.25);
}

/* ==================== MESSAGES ==================== */
.messages-area {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  background: #f8fafc;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.message-wrapper {
  display: flex;
  flex-direction: column;
  max-width: 85%;
}

.message-wrapper.me {
  align-self: flex-end;
}

.message-wrapper.support {
  align-self: flex-start;
}

.message-bubble {
  padding: 10px 14px;
  border-radius: 16px;
  font-size: 14px;
  line-height: 1.4;
  word-wrap: break-word;
}

.message-wrapper.me .message-bubble {
  background: linear-gradient(135deg, var(--widget-primary) 0%, var(--widget-secondary) 100%);
  color: white;
  border-bottom-right-radius: 4px;
}

.message-wrapper.support .message-bubble {
  background: #fff;
  color: #1e293b;
  border-bottom-left-radius: 4px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.message-time {
  font-size: 10px;
  color: #94a3b8;
  margin-top: 4px;
  padding: 0 4px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.message-wrapper.me .message-time {
  justify-content: flex-end;
}

/* Read Receipt Icons */
.read-receipt {
  display: inline-flex;
  align-items: center;
  margin-left: 4px;
}

.read-receipt svg {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
}

.read-receipt.sent svg {
  color: #94a3b8;
}

.read-receipt.delivered svg {
  color: #64748b;
}

.read-receipt.read svg {
  color: #22c55e;
}

/* Typing indicator */
.typing-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 14px;
  background: #fff;
  border-radius: 16px;
  border-bottom-left-radius: 4px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  max-width: 70px;
  align-self: flex-start;
}

.typing-dots {
  display: flex;
  gap: 4px;
}

.typing-dots span {
  width: 6px;
  height: 6px;
  background: #94a3b8;
  border-radius: 50%;
  animation: bounce 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: 0s; }
.typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.typing-dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes bounce {
  0%, 60%, 100% { transform: translateY(0); }
  30% { transform: translateY(-6px); }
}

/* ==================== INPUT AREA ==================== */
.input-area {
  padding: 12px 16px;
  background: #fff;
  border-top: 1px solid #e2e8f0;
}

.input-wrapper {
  display: flex;
  align-items: flex-end;
  gap: 8px;
  background: #f1f5f9;
  border-radius: 24px;
  padding: 6px 6px 6px 14px;
}

.input-wrapper textarea {
  flex: 1;
  border: none;
  background: transparent;
  font-family: inherit;
  font-size: 14px;
  resize: none;
  outline: none;
  max-height: 80px;
  min-height: 20px;
  line-height: 20px;
}

.input-actions {
  display: flex;
  align-items: center;
  gap: 2px;
}

.btn-emoji, .btn-attach, .btn-send {
  width: 32px;
  height: 32px;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.btn-emoji, .btn-attach {
  background: transparent;
  color: #64748b;
}

.btn-emoji:hover, .btn-attach:hover {
  background: #e2e8f0;
  color: #1e293b;
}

.btn-send {
  background: linear-gradient(135deg, var(--widget-primary) 0%, var(--widget-secondary) 100%);
  color: white;
}

.btn-send:hover {
  transform: scale(1.05);
}

/* File messages */
.message-file {
  margin-top: 8px;
}

.message-image {
  max-width: 200px;
  max-height: 200px;
  border-radius: 8px;
  cursor: pointer;
  transition: transform 0.2s;
}

.message-image:hover {
  transform: scale(1.02);
}

.file-attachment {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: rgba(0,0,0,0.05);
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s;
  text-decoration: none;
  color: inherit;
}

.file-attachment:hover {
  background: rgba(0,0,0,0.1);
}

.message-wrapper.me .file-attachment {
  background: rgba(255,255,255,0.15);
}

.message-wrapper.me .file-attachment:hover {
  background: rgba(255,255,255,0.25);
}

.file-download-icon {
  width: 32px;
  height: 32px;
  background: rgba(37, 99, 235, 0.1);
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--widget-primary);
  flex-shrink: 0;
}

.message-wrapper.me .file-download-icon {
  background: rgba(255,255,255,0.15);
  color: white;
}

.file-icon {
  width: 36px;
  height: 36px;
  background: var(--widget-primary);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
}

.message-wrapper.me .file-icon {
  background: rgba(255,255,255,0.2);
}

.file-info {
  flex: 1;
  min-width: 0;
}

.file-name {
  font-size: 13px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.file-size {
  font-size: 11px;
  opacity: 0.7;
}

/* Image download overlay */
.image-container {
  position: relative;
  display: inline-block;
}

.image-download-btn {
  position: absolute;
  top: 6px;
  right: 6px;
  width: 28px;
  height: 28px;
  background: rgba(0, 0, 0, 0.6);
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.2s, background 0.2s;
  text-decoration: none;
}

.image-container:hover .image-download-btn {
  opacity: 1;
}

.image-download-btn:hover {
  background: rgba(37, 99, 235, 0.9);
}

/* File preview before sending */
.file-preview {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  background: #e2e8f0;
  border-radius: 8px;
  margin-bottom: 8px;
}

.file-preview img {
  width: 40px;
  height: 40px;
  object-fit: cover;
  border-radius: 6px;
}

.file-preview-info {
  flex: 1;
  min-width: 0;
}

.file-preview-name {
  font-size: 13px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.file-preview-size {
  font-size: 11px;
  color: #64748b;
}

.file-preview-remove {
  width: 24px;
  height: 24px;
  border: none;
  background: #ef4444;
  color: white;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Image modal */
.image-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.9);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.image-modal.show {
  display: flex;
}

.image-modal img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 8px;
}

.image-modal-close {
  position: absolute;
  top: 16px;
  right: 16px;
  width: 40px;
  height: 40px;
  border: none;
  background: rgba(255,255,255,0.2);
  color: white;
  border-radius: 50%;
  cursor: pointer;
  font-size: 24px;
}

/* ==================== EMOJI PICKER ==================== */
.emoji-picker {
  position: absolute;
  bottom: 70px;
  left: 16px;
  right: 16px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  display: none;
  z-index: 100;
  overflow: hidden;
}

.emoji-picker.show {
  display: block;
  animation: fadeUp 0.2s ease;
}

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.emoji-categories {
  display: flex;
  padding: 8px;
  gap: 4px;
  border-bottom: 1px solid #e2e8f0;
  overflow-x: auto;
}

.emoji-cat-btn {
  padding: 6px 8px;
  border: none;
  background: transparent;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
}

.emoji-cat-btn:hover, .emoji-cat-btn.active {
  background: #f1f5f9;
}

.emoji-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
  padding: 10px;
  max-height: 150px;
  overflow-y: auto;
}

.emoji-item {
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  border-radius: 4px;
  cursor: pointer;
}

.emoji-item:hover {
  background: #f1f5f9;
  transform: scale(1.2);
}

/* ==================== WELCOME SCREEN ==================== */
.welcome-screen {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 30px;
  background: #f8fafc;
  text-align: center;
}

.welcome-icon {
  width: 64px;
  height: 64px;
  background: linear-gradient(135deg, var(--widget-primary) 0%, var(--widget-secondary) 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 20px;
}

.welcome-icon svg {
  width: 32px;
  height: 32px;
  color: white;
}

.welcome-screen h2 {
  font-size: 20px;
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 8px;
}

.welcome-screen p {
  font-size: 14px;
  color: #64748b;
  margin-bottom: 24px;
}

.name-input {
  width: 100%;
  max-width: 240px;
}

.name-input input {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 15px;
  font-family: inherit;
  outline: none;
  transition: all 0.2s;
  margin-bottom: 12px;
}

.name-input input:focus {
  border-color: var(--widget-primary);
}

.name-input button {
  width: 100%;
  padding: 12px;
  background: linear-gradient(135deg, var(--widget-primary) 0%, var(--widget-secondary) 100%);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 600;
  font-family: inherit;
  cursor: pointer;
  transition: all 0.2s;
}

.name-input button:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}

/* Intent Dropdown */
.intent-select {
  width: 100%;
  padding: 12px 14px;
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  font-size: 14px;
  font-family: inherit;
  color: #374151;
  background: white;
  cursor: pointer;
  transition: all 0.2s;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 16px;
  margin-bottom: 12px;
}

.intent-select:focus {
  outline: none;
  border-color: var(--widget-primary);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.intent-select option {
  padding: 10px;
}

/* ==================== COLLAPSED STATE ==================== */
.chat-widget.collapsed {
  height: 56px;
  border-radius: 28px;
  cursor: pointer;
  background: transparent;
  box-shadow: none;
  overflow: visible;
}

.chat-widget.collapsed .chat-header {
  border-radius: 28px;
  padding: 12px 20px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  height: 56px;
}

.chat-widget.collapsed .messages-area,
.chat-widget.collapsed .input-area,
.chat-widget.collapsed .welcome-screen {
  display: none;
}

.chat-widget.collapsed .header-text h3 {
  font-size: 14px;
  white-space: nowrap;
}

.chat-widget.collapsed .header-text p {
  display: none;
}

.chat-widget.collapsed .header-avatar {
  width: 32px;
  height: 32px;
  min-width: 32px;
  border-radius: 8px;
}

.chat-widget.collapsed .header-info {
  gap: 8px;
}

.notification-badge {
  position: absolute;
  top: -4px;
  right: -4px;
  background: #ef4444;
  color: white;
  font-size: 11px;
  font-weight: 600;
  min-width: 20px;
  height: 20px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 6px;
  display: none;
}

.notification-badge.show {
  display: flex;
  animation: pop 0.3s ease;
}

@keyframes pop {
  0% { transform: scale(0); }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); }
}

.hidden {
  display: none !important;
}

/* ==================== CSAT POPUP ==================== */
.csat-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1001;
  animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.csat-popup {
  background: white;
  border-radius: 16px;
  padding: 24px;
  width: 90%;
  max-width: 320px;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.csat-header h3 {
  font-size: 18px;
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 8px;
}

.csat-header p {
  font-size: 14px;
  color: #64748b;
  margin-bottom: 20px;
}

.csat-stars {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-bottom: 8px;
}

.csat-star {
  font-size: 32px;
  color: #e2e8f0;
  background: none;
  border: none;
  cursor: pointer;
  transition: all 0.2s;
  padding: 4px;
}

.csat-star:hover {
  transform: scale(1.2);
}

.csat-star.selected {
  color: #f59e0b;
}

.csat-labels {
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  color: #94a3b8;
  margin-bottom: 16px;
  padding: 0 8px;
}

.csat-feedback {
  width: 100%;
  padding: 12px;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  font-size: 14px;
  font-family: inherit;
  resize: none;
  margin-bottom: 16px;
}

.csat-feedback:focus {
  outline: none;
  border-color: var(--widget-primary);
}

.csat-actions {
  display: flex;
  gap: 12px;
}

.csat-skip {
  flex: 1;
  padding: 12px;
  border: 1px solid #e2e8f0;
  background: white;
  border-radius: 8px;
  color: #64748b;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.csat-skip:hover {
  background: #f8fafc;
}

.csat-submit {
  flex: 1;
  padding: 12px;
  border: none;
  background: linear-gradient(135deg, var(--widget-primary) 0%, var(--widget-secondary) 100%);
  border-radius: 8px;
  color: white;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.csat-submit:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}

.csat-submit:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* ==================== SYSTEM MESSAGE ==================== */
.message-wrapper.system {
  justify-content: center;
}

.system-message {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  background: #f1f5f9;
  border-radius: 20px;
  font-size: 12px;
  color: #64748b;
}

.system-message svg {
  color: #22c55e;
  flex-shrink: 0;
}

/* ==================== DISABLED INPUT ==================== */
.input-area.disabled {
  opacity: 0.5;
  pointer-events: none;
}

.input-area.disabled::after {
  content: 'Conversation closed';
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(248, 250, 252, 0.9);
  font-size: 13px;
  color: #94a3b8;
}

</style>
</head>

<body>

<div class="chat-widget" id="chatWidget">

  <!-- HEADER -->
  <div class="chat-header" id="chatHeader">
    <div class="header-info">
      <div class="header-avatar" id="headerAvatar">
        <img class="header-avatar-img" src="/uploads/favicon-48x48.png" alt="Logo" />
      </div>
      <div class="header-text">
        <h3 id="headerTitle">Chat Support</h3>
        <p id="headerStatus">We typically reply within minutes</p>
      </div>
    </div>
    <button class="btn-collapse" id="btnCollapse" title="Minimize" style="position: relative;">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
      </svg>
      <span class="notification-badge" id="notificationBadge">0</span>
    </button>
  </div>

  <!-- WELCOME SCREEN -->
  <div class="welcome-screen" id="welcomeScreen">
    <div class="welcome-icon">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
      </svg>
    </div>
    <h2>Welcome!</h2>
    <p>Enter your details to start a conversation</p>
    <div class="name-input">
      <input type="text" id="nameInput" placeholder="Your name *" required />
      <input type="email" id="emailInput" placeholder="Your email (optional)" />
      <select id="intentSelect" class="intent-select">
        <option value="">How can we help you today?</option>
        <option value="Sales">Sales Inquiry</option>
        <option value="Support">General Support</option>
        <option value="Billing">Billing Question</option>
        <option value="Technical">Technical Issue</option>
        <option value="Feedback">Feedback</option>
        <option value="Other">Other</option>
      </select>
      <button id="btnStartChat">Start Chat</button>
    </div>
  </div>

  <!-- MESSAGES AREA -->
  <div class="messages-area hidden" id="messagesArea"></div>

  <!-- INPUT AREA -->
  <div class="input-area hidden" id="inputArea" style="position: relative;">
    <div class="emoji-picker" id="emojiPicker">
      <div class="emoji-categories" id="emojiCategories"></div>
      <div class="emoji-grid" id="emojiGrid"></div>
    </div>
    <div id="filePreviewArea"></div>
    <div class="input-wrapper">
      <textarea id="messageInput" placeholder="Type a message..." rows="1"></textarea>
      <div class="input-actions">
        <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx,.txt,.zip" style="display: none;" />
        <button class="btn-attach" id="btnAttach" title="Attach file">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
          </svg>
        </button>
        <button class="btn-emoji" id="btnEmoji" title="Emoji">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </button>
        <button class="btn-send" id="btnSend" title="Send">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div class="image-modal" id="imageModal">
    <button class="image-modal-close" onclick="closeImageModal()">&times;</button>
    <img id="modalImage" src="" alt="Full size image" />
  </div>

</div>

<script>
// ==================== CONFIG ====================
const urlParams = new URLSearchParams(location.search);
const siteId = urlParams.get("siteId");
const apiKey = urlParams.get("apiKey");

if (!siteId) {
  console.error("Missing siteId");
}

if (!apiKey) {
  console.error("Missing apiKey");
}

// Use sessionStorage so each browser tab/session gets a fresh visitor
// Close tab = new visitor on next visit
const visitorId = sessionStorage.getItem("chatWidgetVisitorId") || crypto.randomUUID();
sessionStorage.setItem("chatWidgetVisitorId", visitorId);

// ==================== STATE ====================
let socket = null;
let isCollapsed = true;
let unreadCount = 0;
let userName = sessionStorage.getItem("chatWidgetUserName") || "";
let userEmail = sessionStorage.getItem("chatWidgetUserEmail") || "";
let userIntent = sessionStorage.getItem("chatWidgetIntent") || "";
let chatStarted = sessionStorage.getItem("chatWidgetStarted") === "true";
let brandName = sessionStorage.getItem("chatWidgetBrandName") || "Us";
let pendingFile = null;

// ==================== DOM ELEMENTS ====================
const chatWidget = document.getElementById("chatWidget");
const welcomeScreen = document.getElementById("welcomeScreen");
const messagesArea = document.getElementById("messagesArea");
const inputArea = document.getElementById("inputArea");
const headerTitle = document.getElementById("headerTitle");
const headerStatus = document.getElementById("headerStatus");
const nameInput = document.getElementById("nameInput");
const emailInput = document.getElementById("emailInput");
const messageInput = document.getElementById("messageInput");
const emojiPicker = document.getElementById("emojiPicker");
const notificationBadge = document.getElementById("notificationBadge");

// ==================== COLLAPSE / EXPAND ====================
document.getElementById("btnCollapse").addEventListener("click", (e) => {
  e.stopPropagation();
  if (isCollapsed) {
    expand();
  } else {
    collapse();
  }
});

chatWidget.addEventListener("click", () => {
  if (isCollapsed) {
    expand();
  }
});

function collapse() {
  isCollapsed = true;
  chatWidget.classList.add("collapsed");
  headerTitle.textContent = `Ask ${brandName}`;
  parent.postMessage({ type: "CHAT_COLLAPSE" }, "*");
}

function expand() {
  isCollapsed = false;
  chatWidget.classList.remove("collapsed");
  headerTitle.textContent = "Chat Support";
  unreadCount = 0;
  updateBadge();
  parent.postMessage({ type: "CHAT_EXPAND" }, "*");
  // Tell support dashboard that customer has read the messages
  if (socket && socket.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({ type: 'messages_read', timestamp: new Date().toISOString() }));
  }
}

function updateBadge() {
  notificationBadge.textContent = unreadCount;
  if (unreadCount > 0 && isCollapsed) {
    notificationBadge.classList.add("show");
  } else {
    notificationBadge.classList.remove("show");
  }
  // Also notify parent
  parent.postMessage({ type: "CHAT_UNREAD", count: unreadCount }, "*");
}

// ==================== START CHAT ====================
document.getElementById("btnStartChat").addEventListener("click", startChat);
nameInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") startChat();
});

function startChat() {
  const name = nameInput.value.trim();
  const email = emailInput.value.trim();
  const intentSelect = document.getElementById("intentSelect");
  const selectedIntent = intentSelect ? intentSelect.value : "";

  if (!name) {
    nameInput.focus();
    nameInput.style.borderColor = "#ef4444";
    return;
  }

  // Basic email validation if provided
  if (email && !isValidEmail(email)) {
    emailInput.focus();
    emailInput.style.borderColor = "#ef4444";
    return;
  }

  // Reset border colors
  nameInput.style.borderColor = "";
  emailInput.style.borderColor = "";

  userName = name;
  userEmail = email;
  userIntent = selectedIntent;
  chatStarted = true;

  // Save to sessionStorage for page reload persistence
  sessionStorage.setItem("chatWidgetUserName", userName);
  sessionStorage.setItem("chatWidgetUserEmail", userEmail);
  sessionStorage.setItem("chatWidgetIntent", userIntent);
  sessionStorage.setItem("chatWidgetStarted", "true");

  // Switch UI
  welcomeScreen.classList.add("hidden");
  messagesArea.classList.remove("hidden");
  inputArea.classList.remove("hidden");

  // Connect WebSocket
  connectWebSocket();
}

// Restore chat state on page load if chat was already started
function restoreChat() {
  if (chatStarted && userName) {
    // Switch UI
    welcomeScreen.classList.add("hidden");
    messagesArea.classList.remove("hidden");
    inputArea.classList.remove("hidden");

    // Connect WebSocket
    connectWebSocket();
  }
}

// Auto-restore on load
restoreChat();

// ==================== WEBSOCKET ====================
function connectWebSocket() {
  // Use iframe's own origin (Assistica AI server), not the parent website's domain
  const wsProtocol = location.protocol === "https:" ? "wss:" : "ws:";
  const wsHost = location.host;
  socket = new WebSocket(`${wsProtocol}//${wsHost}/ws?siteId=${siteId}&role=customer&visitorId=${visitorId}&apiKey=${encodeURIComponent(apiKey)}`);

  socket.onopen = () => {
    socket.send(JSON.stringify({ type: "init", name: userName, email: userEmail, intent: userIntent }));
    socket.send(JSON.stringify({ type: "get_state" }));
  };

  socket.onmessage = (e) => {
    const data = JSON.parse(e.data);

    if (data.type === "message") {
      addMessage("support", data.message, data.file);

      // Send delivery acknowledgement back to support dashboard
      if (socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
          type: 'message_delivered',
          timestamp: new Date().toISOString()
        }));
      }

      if (isCollapsed) {
        unreadCount++;
        updateBadge();
      } else {
        // Widget is open â€” customer sees the message immediately, send read receipt
        socket.send(JSON.stringify({ type: 'messages_read', timestamp: new Date().toISOString() }));
      }
    }

    if (data.type === "support_joined") {
      headerTitle.textContent = data.name;
      headerStatus.textContent = "Online";
      headerStatus.className = "online";
    }

    if (data.type === "support_left") {
      headerTitle.textContent = "Chat Support";
      headerStatus.textContent = "We'll be back soon";
      headerStatus.className = "";
    }

    if (data.type === "support_typing") {
      showTypingIndicator();
    }

    if (data.type === "support_typing_stop") {
      hideTypingIndicator();
    }

    // Handle agent status updates
    if (data.type === "agent_status_broadcast") {
      updateAgentStatus(data.status, data.agentName);
    }

    // Handle CSAT request
    if (data.type === "csat_request") {
      showCsatPopup(data.agentName, data.conversationId);
    }

    // Handle conversation closed
    if (data.type === "conversation_closed") {
      showConversationClosed(data.message);
    }

    // Handle read receipt updates
    if (data.type === "message_read" || data.type === "messages_read") {
      updateReadReceipts('read');
    }

    if (data.type === "message_delivered") {
      updateReadReceipts('delivered');
    }
  };

  socket.onclose = () => {
    console.log("WebSocket closed");
  };
}

// Update read receipts on messages
// Single tick = delivered, Double tick = seen/read
function updateReadReceipts(status) {
  const receipts = document.querySelectorAll('.read-receipt.sent, .read-receipt.delivered');
  receipts.forEach(receipt => {
    receipt.className = `read-receipt ${status}`;
    if (status === 'read') {
      // Double checkmark = seen
      receipt.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 7l-8.5 8.5-4-4"></path>
          <path d="M22 7l-8.5 8.5-1-1"></path>
        </svg>
      `;
    } else if (status === 'delivered') {
      // Single checkmark = delivered
      receipt.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 6L9 17l-5-5"></path>
        </svg>
      `;
    }
  });
}

// ==================== AGENT STATUS ====================
function updateAgentStatus(status, agentName) {
  const statusMessages = {
    online: "We're here to help!",
    away: "We'll respond shortly",
    busy: "High volume - expect delays"
  };

  headerStatus.textContent = statusMessages[status] || statusMessages.online;
  headerStatus.className = status || 'online';

  // Update title if agent name provided
  if (agentName) {
    headerTitle.textContent = agentName;
  }
}

// ==================== CSAT (Customer Satisfaction) ====================
let selectedCsatRating = 0;
let csatConversationId = null;

function showCsatPopup(agentName, conversationId) {
  csatConversationId = conversationId;
  // Create CSAT popup overlay
  const overlay = document.createElement('div');
  overlay.id = 'csatOverlay';
  overlay.className = 'csat-overlay';
  overlay.innerHTML = `
    <div class="csat-popup">
      <div class="csat-header">
        <h3>Rate your experience</h3>
        <p>How was your chat with ${agentName || 'our support team'}?</p>
      </div>
      <div class="csat-stars" id="csatStarsContainer">
        <button class="csat-star" data-rating="1" onclick="selectCsatRating(1)">â˜…</button>
        <button class="csat-star" data-rating="2" onclick="selectCsatRating(2)">â˜…</button>
        <button class="csat-star" data-rating="3" onclick="selectCsatRating(3)">â˜…</button>
        <button class="csat-star" data-rating="4" onclick="selectCsatRating(4)">â˜…</button>
        <button class="csat-star" data-rating="5" onclick="selectCsatRating(5)">â˜…</button>
      </div>
      <div class="csat-labels">
        <span>Poor</span>
        <span>Excellent</span>
      </div>
      <textarea id="csatFeedback" class="csat-feedback" placeholder="Additional feedback (optional)..." rows="2"></textarea>
      <div class="csat-actions">
        <button class="csat-skip" onclick="closeCsatPopup()">Skip</button>
        <button class="csat-submit" id="csatSubmitBtn" onclick="submitCsatRating()" disabled>Submit</button>
      </div>
    </div>
  `;

  document.body.appendChild(overlay);
  selectedCsatRating = 0;
}

function selectCsatRating(rating) {
  selectedCsatRating = rating;
  const stars = document.querySelectorAll('.csat-star');
  stars.forEach((star, index) => {
    if (index < rating) {
      star.classList.add('selected');
    } else {
      star.classList.remove('selected');
    }
  });
  document.getElementById('csatSubmitBtn').disabled = false;
}

function submitCsatRating() {
  const feedback = document.getElementById('csatFeedback').value.trim();

  if (socket && socket.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({
      type: 'csat_response',
      rating: selectedCsatRating,
      feedback: feedback,
      conversationId: csatConversationId
    }));
  }

  closeCsatPopup();
  showThankYouMessage();
}

function closeCsatPopup() {
  const overlay = document.getElementById('csatOverlay');
  if (overlay) {
    overlay.remove();
  }
}

function showThankYouMessage() {
  addMessage('support', 'Thank you for your feedback! We appreciate you taking the time to rate your experience.');
}

function showConversationClosed(message) {
  // Add a system message indicating the conversation is closed
  const wrapper = document.createElement("div");
  wrapper.className = "message-wrapper system";
  wrapper.innerHTML = `
    <div class="system-message">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <span>${message || 'This conversation has been closed.'}</span>
    </div>
  `;
  messagesArea.appendChild(wrapper);
  messagesArea.scrollTop = messagesArea.scrollHeight;

  // Disable input
  const inputArea = document.querySelector('.input-area');
  if (inputArea) {
    inputArea.classList.add('disabled');
  }
}

// ==================== MESSAGES ====================
function addMessage(from, text, fileData = null, status = 'sent') {
  hideTypingIndicator();

  const wrapper = document.createElement("div");
  wrapper.className = `message-wrapper ${from}`;

  const bubble = document.createElement("div");
  bubble.className = "message-bubble";

  // Add text if present
  if (text) {
    bubble.textContent = text;
  }

  // Add file if present
  if (fileData) {
    const fileDiv = document.createElement("div");
    fileDiv.className = "message-file";

    if (fileData.is_image) {
      const container = document.createElement("div");
      container.className = "image-container";

      const img = document.createElement("img");
      img.className = "message-image";
      img.src = fileData.url;
      img.alt = fileData.original_name;
      img.onclick = () => openImageModal(fileData.url);
      container.appendChild(img);

      const downloadBtn = document.createElement("a");
      downloadBtn.className = "image-download-btn";
      downloadBtn.href = fileData.url;
      downloadBtn.download = fileData.original_name;
      downloadBtn.title = "Download";
      downloadBtn.onclick = (e) => e.stopPropagation();
      downloadBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
      `;
      container.appendChild(downloadBtn);

      fileDiv.appendChild(container);
    } else {
      const attachment = document.createElement("a");
      attachment.className = "file-attachment";
      attachment.href = fileData.url;
      attachment.download = fileData.original_name;
      attachment.innerHTML = `
        <div class="file-download-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
          </svg>
        </div>
        <div class="file-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg>
        </div>
        <div class="file-info">
          <div class="file-name">${escapeHtml(fileData.original_name)}</div>
          <div class="file-size">${formatFileSize(fileData.size)}</div>
        </div>
      `;
      fileDiv.appendChild(attachment);
    }

    bubble.appendChild(fileDiv);
  }

  const time = document.createElement("div");
  time.className = "message-time";

  // Add time text
  const timeText = document.createElement("span");
  timeText.textContent = formatTime(new Date());
  time.appendChild(timeText);

  // Add read receipt icon for customer's messages
  // Single tick = delivered, Double tick = seen/read
  if (from === "me") {
    const receipt = document.createElement("span");
    receipt.className = `read-receipt ${status}`;
    receipt.id = `receipt-${Date.now()}`;

    if (status === 'read') {
      // Double checkmark = seen
      receipt.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 7l-8.5 8.5-4-4"></path>
          <path d="M22 7l-8.5 8.5-1-1"></path>
        </svg>
      `;
    } else {
      // Single checkmark = delivered (covers both 'sent' and 'delivered')
      receipt.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 6L9 17l-5-5"></path>
        </svg>
      `;
    }
    time.appendChild(receipt);
  }

  wrapper.appendChild(bubble);
  wrapper.appendChild(time);
  messagesArea.appendChild(wrapper);

  messagesArea.scrollTop = messagesArea.scrollHeight;

  // Return the receipt element id for updating later
  return from === "me" ? `receipt-${Date.now()}` : null;
}

function showTypingIndicator() {
  if (document.getElementById("typingIndicator")) return;

  const div = document.createElement("div");
  div.id = "typingIndicator";
  div.className = "typing-indicator";
  div.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
  messagesArea.appendChild(div);
  messagesArea.scrollTop = messagesArea.scrollHeight;
}

function hideTypingIndicator() {
  const el = document.getElementById("typingIndicator");
  if (el) el.remove();
}

// ==================== SEND MESSAGE ====================
document.getElementById("btnSend").addEventListener("click", send);
messageInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});

async function send() {
  const text = messageInput.value.trim();
  if ((!text && !pendingFile) || !socket) return;

  // If there's a file, upload it first
  if (pendingFile) {
    const formData = new FormData();
    formData.append("file", pendingFile);
    formData.append("siteId", siteId);
    formData.append("visitorId", visitorId);

    try {
      const response = await fetch("/upload", {
        method: "POST",
        body: formData
      });

      if (!response.ok) {
        const error = await response.json();
        alert(error.detail || "Failed to upload file");
        return;
      }

      const fileData = await response.json();

      // Add message locally
      addMessage("me", text, fileData);

      // Send via WebSocket
      socket.send(JSON.stringify({
        message: text,
        file: fileData
      }));
    } catch (error) {
      alert("Failed to upload file");
      return;
    }

    // Clear pending file
    clearPendingFile();
  } else {
    // Text only message
    addMessage("me", text);
    socket.send(JSON.stringify({ message: text }));
  }

  // Stop typing
  socket.send(JSON.stringify({ type: "typing_stop" }));
  isTyping = false;

  messageInput.value = "";
  messageInput.style.height = "auto";

}

// ==================== FILE HANDLING ====================
const fileInput = document.getElementById("fileInput");
const filePreviewArea = document.getElementById("filePreviewArea");

document.getElementById("btnAttach").addEventListener("click", () => {
  fileInput.click();
});

fileInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  // Check file size (10MB limit)
  if (file.size > 10 * 1024 * 1024) {
    alert("File is too large. Maximum size is 10MB.");
    fileInput.value = "";
    return;
  }

  pendingFile = file;
  showFilePreview(file);
});

function showFilePreview(file) {
  const isImage = file.type.startsWith("image/");

  let previewHtml = `
    <div class="file-preview">
      ${isImage ? `<img src="${URL.createObjectURL(file)}" alt="Preview" />` : `
        <div class="file-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg>
        </div>
      `}
      <div class="file-preview-info">
        <div class="file-preview-name">${escapeHtml(file.name)}</div>
        <div class="file-preview-size">${formatFileSize(file.size)}</div>
      </div>
      <button class="file-preview-remove" onclick="clearPendingFile()" title="Remove">&times;</button>
    </div>
  `;

  filePreviewArea.innerHTML = previewHtml;
}

function clearPendingFile() {
  pendingFile = null;
  fileInput.value = "";
  filePreviewArea.innerHTML = "";
}

function openImageModal(url) {
  const modal = document.getElementById("imageModal");
  const img = document.getElementById("modalImage");
  img.src = url;
  modal.classList.add("show");
}

function closeImageModal() {
  document.getElementById("imageModal").classList.remove("show");
}

// Close modal on background click
document.getElementById("imageModal").addEventListener("click", (e) => {
  if (e.target.id === "imageModal") {
    closeImageModal();
  }
});

// ==================== TYPING INDICATOR ====================
let typingTimeout = null;
let isTyping = false;

messageInput.addEventListener("input", () => {
  // Auto-resize
  messageInput.style.height = "auto";
  messageInput.style.height = Math.min(messageInput.scrollHeight, 80) + "px";

  if (!socket) return;

  if (!isTyping) {
    isTyping = true;
    socket.send(JSON.stringify({ type: "typing_start" }));
  }

  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => {
    isTyping = false;
    socket.send(JSON.stringify({ type: "typing_stop" }));
  }, 2000);
});

// ==================== EMOJI PICKER ====================
const EMOJI_DATA = {
  "Smileys": ["ðŸ˜€","ðŸ˜ƒ","ðŸ˜„","ðŸ˜","ðŸ˜…","ðŸ˜‚","ðŸ¤£","ðŸ˜Š","ðŸ˜‡","ðŸ™‚","ðŸ˜‰","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ˜‹","ðŸ˜›","ðŸ˜œ","ðŸ¤—","ðŸ¤”","ðŸ˜","ðŸ˜","ðŸ˜´","ðŸ˜·","ðŸ¤’","ðŸ¤•","ðŸ˜Ž","ðŸ¤“","ðŸ¥³"],
  "Gestures": ["ðŸ‘‹","ðŸ¤š","âœ‹","ðŸ––","ðŸ‘Œ","âœŒï¸","ðŸ¤ž","ðŸ¤Ÿ","ðŸ¤˜","ðŸ‘","ðŸ‘Ž","âœŠ","ðŸ‘Š","ðŸ‘","ðŸ™Œ","ðŸ¤","ðŸ™"],
  "Hearts": ["â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ–¤","ðŸ’”","â¤ï¸â€ðŸ”¥","ðŸ’•","ðŸ’–","ðŸ’"],
  "Objects": ["ðŸ’¼","ðŸ“","ðŸ“…","ðŸ“Œ","ðŸ“","ðŸ”","ðŸ’¡","ðŸ“§","ðŸ“¦","ðŸŽ","ðŸŽ‰"],
  "Symbols": ["âœ…","âŒ","â“","â—","ðŸ’¯","ðŸ”¥","â­","âœ¨","ðŸŽ¯","ðŸ’¬","ðŸ””"]
};

let currentCategory = "Smileys";

function initEmojis() {
  const cats = document.getElementById("emojiCategories");
  const icons = { "Smileys": "ðŸ˜€", "Gestures": "ðŸ‘‹", "Hearts": "â¤ï¸", "Objects": "ðŸ’¼", "Symbols": "âœ…" };

  cats.innerHTML = Object.keys(EMOJI_DATA).map(c => `
    <button class="emoji-cat-btn ${c === currentCategory ? 'active' : ''}" data-cat="${c}">${icons[c]}</button>
  `).join('');

  cats.querySelectorAll(".emoji-cat-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      currentCategory = btn.dataset.cat;
      cats.querySelectorAll(".emoji-cat-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      renderEmojis();
    });
  });

  renderEmojis();
}

function renderEmojis() {
  const grid = document.getElementById("emojiGrid");
  grid.innerHTML = EMOJI_DATA[currentCategory].map(e => `
    <span class="emoji-item" data-emoji="${e}">${e}</span>
  `).join('');

  grid.querySelectorAll(".emoji-item").forEach(item => {
    item.addEventListener("click", () => {
      insertEmoji(item.dataset.emoji);
    });
  });
}

function insertEmoji(emoji) {
  const start = messageInput.selectionStart;
  const end = messageInput.selectionEnd;
  const text = messageInput.value;

  messageInput.value = text.substring(0, start) + emoji + text.substring(end);
  messageInput.selectionStart = messageInput.selectionEnd = start + emoji.length;
  messageInput.focus();

  emojiPicker.classList.remove("show");
}

document.getElementById("btnEmoji").addEventListener("click", (e) => {
  e.stopPropagation();
  emojiPicker.classList.toggle("show");
  if (emojiPicker.classList.contains("show")) {
    initEmojis();
  }
});

document.addEventListener("click", (e) => {
  if (!emojiPicker.contains(e.target) && e.target.id !== "btnEmoji" && !e.target.closest("#btnEmoji")) {
    emojiPicker.classList.remove("show");
  }
});

// ==================== UTILITIES ====================
function formatTime(date) {
  return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
}

function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + " B";
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
  return (bytes / (1024 * 1024)).toFixed(1) + " MB";
}

function escapeHtml(text) {
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

function isValidEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

// Listen for parent commands
window.addEventListener("message", (e) => {
  if (e.data?.type === "EXPAND_WIDGET") {
    expand();
  }
});

// ==================== API BASE URL ====================
const apiBaseUrl = (typeof CONFIG !== 'undefined' && CONFIG.API_URL) ? CONFIG.API_URL : window.location.origin;

// ==================== WIDGET CONFIG ====================
async function fetchWidgetConfig() {
  if (!siteId) return;
  try {
    const response = await fetch(`${apiBaseUrl}/api/sites/${siteId}/widget-config`);
    if (response.ok) {
      const result = await response.json();
      const cfg = result.data || result;
      if (cfg) {
        const root = document.documentElement;
        if (cfg.primaryColor) {
          root.style.setProperty('--widget-primary', cfg.primaryColor);
        }
        if (cfg.secondaryColor) {
          root.style.setProperty('--widget-secondary', cfg.secondaryColor);
        }
        if (cfg.welcomeMessage) {
          const welcomeP = document.querySelector('.welcome-screen p');
          if (welcomeP) welcomeP.textContent = cfg.welcomeMessage;
        }
        // Send position to parent (widget.js) to update container placement
        if (cfg.position && window.parent !== window) {
          window.parent.postMessage({ type: 'WIDGET_POSITION', position: cfg.position }, '*');
        }
      }
    }
  } catch (e) {
    console.warn("Failed to fetch widget config:", e);
  }
}

// Fetch brand name from API
async function fetchBrandName() {
  if (!siteId) return;
  try {
    const response = await fetch(`${apiBaseUrl}/api/SiteSettings`);
    if (response.ok) {
      const result = await response.json();
      if (result.data?.siteName) {
        brandName = result.data.siteName;
        sessionStorage.setItem("chatWidgetBrandName", brandName);
        if (isCollapsed) {
          headerTitle.textContent = `Ask ${brandName}`;
        }
      }
    }
  } catch (e) {
    console.warn("Failed to fetch brand name:", e);
  }
}

// Initialize on load
collapse();
fetchWidgetConfig();
fetchBrandName();
</script>

</body>
</html>
